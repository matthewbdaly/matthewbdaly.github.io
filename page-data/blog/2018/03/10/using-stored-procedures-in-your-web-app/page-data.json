{"componentChunkName":"component---src-templates-post-tsx","path":"/blog/2018/03/10/using-stored-procedures-in-your-web-app/","result":{"data":{"site":{"siteMetadata":{"title":"Matthew Daly","siteUrl":"https://matthewdaly.co.uk"}},"mdx":{"id":"d6706fc9-e7fd-5aa0-84e4-48414c0f3c13","body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Using stored procedures in your web app\",\n  \"date\": \"2018-03-10 15:10:16 +0000\",\n  \"layout\": \"post\",\n  \"categories\": [\"sql\"],\n  \"comments\": true\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"In the last few days I've done something I've never done before, namely written a stored procedure for a web app. Like most web developers, I know enough about SQL to be able to formulate some fairly complex queries, but I hadn't really touched on control flow functions or stored procedures, and in my experience they tend to be the province of the dedicated database administrator, not us web devs, who will typically delegate more complex functionality to our application code.\"), mdx(\"p\", null, \"In this case, there were a number of factors influencing my decision to use a stored procedure for this:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The application was a legacy application which had been worked on by developers of, shall we say, varying skill levels. As a result the database schema was badly designed, with no prospect of changing it without causing huge numbers of breakages\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The query in question was used to generate a complex report that was quite time-consuming, therefore the optimisations from using a stored procedure were worthwhile.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The report required that data be grouped by a set of categories which were stored in a separate table, which meant the table had to be pivoted (transformed from rows to columns), resulting in an incredibly complex dynamic query that had to be constructed on the fly by concatenating different SQL strings. In PostgreSQL, this can be done fairly easily using the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"crosstab\"), \" function, but MySQL doesn't have native support for anything like this.\")), mdx(\"p\", null, \"Historically, one issue with using stored procedures has been that it kept business logic out of the application code, meaning they are not stored in version control. However, most modern frameworks provide some support for migrations, and since they are intended to be used to make changes to the database, they are the obvious place to define the stored procedure. This particular application was built with an older framework that didn't come with migrations, so we'd installed \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://phinx.org/\"\n  }, \"Phinx\"), \" to handle those for us. Initially, I defined the stored procedure inside a migration that ran a raw query to create the stored procedure, as in this example:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"public function up()\\n{\\n   $query = <<<EOF\\nCREATE PROCEDURE IF NOT EXISTS foo\\nBEGIN\\n   SELECT * FROM foo;\\nEND\\nEOF;\\n   $this->execute($query);\\n}\\n\\npublic function down()\\n{\\n   $this->execute('DROP PROCEDURE IF EXISTS foo');\\n}\\n\")), mdx(\"p\", null, \"Once this is done, you can then use your framework's particular support for raw queries to call \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CALL foo()\"), \" whenever your stored procedure needs to be executed.\"), mdx(\"p\", null, \"However, we soon ran into an issue. It turns out \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"mysqldump\"), \" doesn't export stored procedures by default, so there was a risk that anyone working on the code base might import the database from an SQL file and not get the migrations. I'd used the Symfony Console component to create a simple command-line tool, reminiscent of Laravel's Artisan, so I used that to create a command to set up the stored procedure, amended the migration to call that command, and placed a check in the application where the procedure was called so that if it was not defined the command would be called and the procedure would be created. In most cases this wouldn't be an issue.\"), mdx(\"p\", null, \"Having now had experience using stored procedures in a web application, there are a number of issues they raise:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"It's hard to make queries flexible, whereas with something like Eloquent it's straightforward to conditionally apply \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"WHERE\"), \" statements.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"While storing them in migrations is a practical solution, if the database is likely to be imported rather than created from scratch during development it can be problematic.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"They aren't easily portable, not just between database management systems, but between different versions - the production server was using an older version of MySQL, and it failed to create the procedure. It's therefore good practice for your migrations to check the procedure was created successfully and raise a noisy exception if they failed.\")), mdx(\"p\", null, \"Conversely, they do bring certain benefits:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"For particularly complex transactions that don't change, such as generating reports, they are a good fit since they reduce the amount of data that needs to be sent to the database and allow the query to be pre-optimised somewhat.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"If a particular query is unusually expensive, is called often, and can't be cached, it may improve performance to make it a stored procedure.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Doing a query in a for loop is usually a very big no-no. However, if there really is no way to avoid it (and this should almost never happen), it would make sense to try to do it in a stored procedure using SQL rather than in application code since that would minimise the overhead.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"If multiple applications need to work with the same database, using stored procedures for queries in more than one application removes the need to re-implement or copy over the code for the query in the second application - they can just call the same procedure, and if it needs to be changed it need only be done once.\")), mdx(\"p\", null, \"Honestly, I'm not sure I'm ever likely to again come across a scenario where using a stored procedure in a web application would be beneficial, but it's been very interesting delving into aspects of SQL that I don't normally touch on and I've picked up on some rarely-used SQL statements that I haven't used before, such as \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GROUP_CONCAT()\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CASE\"), \". With the widespread adoption of migrations in most frameworks, I think that the argument that using stored procedures keeps application logic out of version control no longer holds any water, since developers can generally be trusted to store changes to database structure in their migrations and not start messing them around, so the same applies for stored procedures. Report generation seems to be the ideal use case since this invariably involves complex queries that run regularly and don't change often, and this is where I expect it would be most likely I'd have cause to use them again.\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"In the last few days I've done something I've never done before, namely written a stored procedure for a web app. Like most web developers, I know enough about SQL to be able toâ€¦","frontmatter":{"title":"Using stored procedures in your web app","date":"10th March 2018 3:10 pm","isoDate":"2018-03-10T15:10:16+00:00","categories":["sql"]},"fields":{"path":"/blog/2018/03/10/using-stored-procedures-in-your-web-app/"}}},"pageContext":{"previous":{"fields":{"path":"/blog/2018/02/25/check-your-code-base-is-php-7-ready-with-php-compatibility/"},"frontmatter":{"title":"Check your code base is PHP 7 ready with PHP Compatibility","date":"2018-02-25 17:22:34 +0000","layout":"post"}},"next":{"fields":{"path":"/blog/2018/04/12/making-wordpress-less-shit/"},"frontmatter":{"title":"Making Wordpress less shit","date":"2018-04-12 23:57:05 +0100","layout":"post"}}}},"staticQueryHashes":["290055352","2909664151"]}