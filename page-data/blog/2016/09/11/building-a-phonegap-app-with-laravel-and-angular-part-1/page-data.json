{"componentChunkName":"component---src-templates-post-tsx","path":"/blog/2016/09/11/building-a-phonegap-app-with-laravel-and-angular-part-1/","result":{"data":{"site":{"siteMetadata":{"title":"Matthew Daly","siteUrl":"https://matthewdaly.co.uk"}},"mdx":{"id":"99451e7e-dc79-5cc4-88cd-c7211e42bfff","body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Building a Phonegap app with Laravel and Angular - Part 1\",\n  \"date\": \"2016-09-11 19:33:41 +0100\",\n  \"layout\": \"post\",\n  \"categories\": [\"php\", \"laravel\", \"javascript\", \"angular\", \"phonegap\", \"laravel-phonegap-tutorial\"],\n  \"comments\": true\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"A lot of my work over the last few years has been on Phonegap apps. Phonegap isn't terribly hard to use, but the difference in context between that and a more conventional web app means that you have to move a lot of functionality to the client side, and unless you've used client-side Javascript frameworks before it can be a struggle.\"), mdx(\"p\", null, \"In this series of tutorials I'll show you how I might build a Phonegap app. The work involved will include:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Building a REST API using Laravel to expose the data\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Building an admin interface to manage the data\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Building a Phonegap app using Angular.js\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Testing and deploying it\")), mdx(\"p\", null, \"In the process we'll cover issues like authentication, authorisation, real-time notifications and working with REST APIs. Note that we won't cover the app submission process - you can find plenty of resources on that. We will, however, be using Phonegap Build to build the app.\"), mdx(\"h2\", null, \"The brief\"), mdx(\"p\", null, \"Let's say our new client is an animal shelter. The brief for the app is as follows:\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"My New Animal Friend will be an app for finding a new pet. Once a user signs in, they'll be able to choose what type of pet they're looking for, then look through a list of pets available to adopt. They can reject them by swiping left or save them by swiping right. They can see more about the ones they swipe right on, and arrange to meet them, from within the app. Users can also message the staff to ask questions about a pet.\")), mdx(\"p\", null, \"Nice idea, but there's a lot of work involved! Our very first task is to build the REST API, since everything else relies on that. Before starting, make sure you have the following installed:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"PHP (I'm using PHP 7, but 5.6 should be fine)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Composer\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Git\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A compatible relational database (I use PostgreSQL)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Redis\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Your usual text editor\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Node.js\")), mdx(\"p\", null, \"As long as you have this, you should be ready to go. Using \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://laravel.com/docs/5.3/homestead\"\n  }, \"Homestead\"), \" is the simplest way to get started if you don't have all this stuff already.\"), mdx(\"h2\", null, \"Starting the API\"), mdx(\"p\", null, \"To start building our REST API, run the following command from the shell:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ composer create-project --prefer-dist laravel/laravel mynewanimalfriend-backend\\n\")), mdx(\"p\", null, \"We also have some other dependencies we need to install, so switch into the new directory and run the following command:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ composer require barryvdh/laravel-cors tymon/jwt-auth predis/predis\\n\")), mdx(\"p\", null, \"Next, we need to add the new packages to the Laravel config. Open up \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"config/app.php\"), \" and add the following to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"providers\"), \" array:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"   Tymon\\\\JWTAuth\\\\Providers\\\\JWTAuthServiceProvider::class,                                                                                                                                              \\n   Barryvdh\\\\Cors\\\\ServiceProvider::class,   \\n\")), mdx(\"p\", null, \"And the following to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"aliases\"), \" array:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"   'JWTAuth' => Tymon\\\\JWTAuth\\\\Facades\\\\JWTAuth::class,\\n\")), mdx(\"p\", null, \"We also need to ensure that the CORS middleware is applied to all API routes. Open up \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"app/Http/Kernel.php\"), \" and under the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"api\"), \" array in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"protected $middlewareGroups\"), \" paste the following:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"   \\\\Barryvdh\\\\Cors\\\\HandleCors::class,\\n\")), mdx(\"p\", null, \"Now that the packages are included, we can publish the files for them:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ php artisan vendor:publish\\n\")), mdx(\"p\", null, \"Next, we need to set a key for our API authentication:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ php artisan jwt:generate\\n\")), mdx(\"p\", null, \"And set a custom namespace:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ php artisan app:name AnimalFriend\\n\")), mdx(\"p\", null, \"You'll also want to set up the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \".env\"), \" file with the configuration settings for your application. There's one at \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \".env.example\"), \" by default that you can copy and customise. Then run the following command to generate the application key:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ php artisan key:generate\\n\")), mdx(\"p\", null, \"I had to change the namespace for the user model in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"config/jwt.php\"), \" as well:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"    'user' => 'AnimalFriend\\\\User',\\n\")), mdx(\"p\", null, \"I also tend to amend the settings in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"phpunit.xml\"), \" as follows so that it uses an in-memory SQLite database for tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-xml\"\n  }, \"        <env name=\\\"APP_ENV\\\" value=\\\"testing\\\"/>\\n        <env name=\\\"SESSION_DRIVER\\\" value=\\\"array\\\"/>\\n        <env name=\\\"QUEUE_DRIVER\\\" value=\\\"sync\\\"/>\\n        <env name=\\\"CACHE_DRIVER\\\" value=\\\"redis\\\"/>\\n        <env name=\\\"DB_CONNECTION\\\" value=\\\"sqlite\\\"/>\\n        <env name=\\\"DB_DATABASE\\\" value=\\\":memory:\\\"/>\\n\")), mdx(\"p\", null, \"Also, delete \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"tests/ExampleTest.php\"), \" and amend \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"tests/TestCase.php\"), \" as follows in order to use database migrations in tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"<?php\\n\\nuse Illuminate\\\\Foundation\\\\Testing\\\\DatabaseMigrations;\\n\\nabstract class TestCase extends Illuminate\\\\Foundation\\\\Testing\\\\TestCase\\n{\\n    use DatabaseMigrations;\\n\\n    /**\\n     * The base URL to use while testing the application.\\n     *\\n     * @var string\\n     */\\n    protected $baseUrl = 'http://localhost';\\n\\n    /**\\n     * Creates the application.\\n     *\\n     * @return \\\\Illuminate\\\\Foundation\\\\Application\\n     */\\n    public function createApplication()\\n    {\\n        $app = require __DIR__.'/../bootstrap/app.php';\\n\\n        $app->make(Illuminate\\\\Contracts\\\\Console\\\\Kernel::class)->bootstrap();\\n\\n        return $app;\\n    }\\n}\\n\")), mdx(\"p\", null, \"With that in place, we can start work on our API proper.\"), mdx(\"h2\", null, \"Authenticating our API\"), mdx(\"p\", null, \"We're going to start out with a very limited subset of our API. First, we'll implement the authentication for our app, then we'll add the facility to view a list of pets or an individual pet. Other functionality will come later. This will be sufficient to get the app working.\"), mdx(\"p\", null, \"First, we need to create our user model. As we'll be practising TDD throughout, we write a test for the user model first. Save the following as \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"tests/UserModelTest.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"<?php\\n\\nuse AnimalFriend\\\\User;\\n\\nclass UserModelTest extends TestCase\\n{\\n    /**\\n     * Test creating a user\\n     *\\n     * @return void\\n     */\\n    public function testCreatingAUser()\\n    {\\n        // Create a User\\n        $user = factory(AnimalFriend\\\\User::class)->create([\\n            'name' => 'bobsmith',\\n            'email' => 'bob@example.com',\\n        ]);\\n        $this->seeInDatabase('users', ['email' => 'bob@example.com']);\\n\\n        // Verify it works\\n        $saved = User::where('email', 'bob@example.com')->first();\\n        $this->assertEquals($saved->id, 1);\\n        $this->assertEquals($saved->name, 'bobsmith');\\n    }\\n}\\n\")), mdx(\"p\", null, \"If we run the tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ vendor/bin/phpunit\\nPHPUnit 5.5.4 by Sebastian Bergmann and contributors.\\n\\n.                                                                   1 / 1 (100%)\\n\\nTime: 169 ms, Memory: 12.00MB\\n\\nOK (1 test, 3 assertions)\\n\")), mdx(\"p\", null, \"We already have a perfectly good \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"User\"), \" model and the appropriate migrations, so our test already passes.\"), mdx(\"p\", null, \"Next, we need to implement the authentication system. Save this as \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"tests/AuthTest.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"<?php\\n\\nuse Illuminate\\\\Foundation\\\\Testing\\\\DatabaseMigrations;\\n\\nclass AuthTest extends TestCase\\n{\\n    use DatabaseMigrations;\\n\\n    /**\\n     * Test the auth\\n     *\\n     * @return void\\n     */\\n    public function testAuth()\\n    {\\n        // Create a User\\n        $user = factory(AnimalFriend\\\\User::class)->create([\\n            'name' => 'bobsmith',\\n            'email' => 'bob@example.com',\\n            'password' => bcrypt('password')\\n        ]);\\n\\n        // Create request\\n        $data = array(\\n            'email' => $user->email,\\n            'password' => 'password',\\n        );\\n        $response = $this->call('POST', 'api/authenticate', $data);\\n        $this->assertResponseStatus(200);\\n        $content = json_decode($response->getContent());\\n        $this->assertTrue(array_key_exists('token', $content));\\n    }\\n\\n    /**\\n     * Test the auth when user does not exist\\n     *\\n     * @return void\\n     */\\n    public function testAuthFailure()\\n    {\\n        // Create data for request\\n        $data = array(\\n            'email' => 'user@example.com',\\n            'password' => 'password',\\n        );\\n        $response = $this->call('POST', 'api/authenticate', $data);\\n\\n        // Check the status code\\n        $this->assertResponseStatus(401);\\n    }\\n}\\n\")), mdx(\"p\", null, \"The first test creates a user and sends an authentication request, then confirms that it returns the JSON Web Token. The second checks that a user that doesn't exist cannot log in.\"), mdx(\"p\", null, \"Let's run the tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ vendor/bin/phpunit\\nPHPUnit 5.5.4 by Sebastian Bergmann and contributors.\\n\\nFF.                                                                 3 / 3 (100%)\\n\\nTime: 328 ms, Memory: 14.00MB\\n\\nThere were 2 failures:\\n\\n1) AuthTest::testAuth\\nExpected status code 200, got 404.\\nFailed asserting that 404 matches expected 200.\\n\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:648\\n/home/matthew/Projects/mynewanimalfriend-backend/tests/AuthTest.php:29\\n\\n2) AuthTest::testAuthFailure\\nExpected status code 401, got 404.\\nFailed asserting that 404 matches expected 401.\\n\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:648\\n/home/matthew/Projects/mynewanimalfriend-backend/tests/AuthTest.php:49\\n\\nFAILURES!\\nTests: 3, Assertions: 5, Failures: 2.\\n\")), mdx(\"p\", null, \"With a failing test in place, we can implement login. First let's create our controller at \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"app/Http/Controllers/AuthenticateController.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"<?php\\n\\nnamespace AnimalFriend\\\\Http\\\\Controllers;\\n\\nuse Illuminate\\\\Http\\\\Request;\\n\\nuse AnimalFriend\\\\Http\\\\Requests;\\nuse AnimalFriend\\\\Http\\\\Controllers\\\\Controller;\\nuse JWTAuth;\\nuse Tymon\\\\JWTAuth\\\\Exceptions\\\\JWTException;\\nuse AnimalFriend\\\\User;\\nuse Hash;\\n\\nclass AuthenticateController extends Controller\\n{\\n    private $user;\\n\\n    public function __construct(User $user) {\\n        $this->user = $user;\\n    }\\n\\n    public function authenticate(Request $request)\\n    {\\n        // Get credentials\\n        $credentials = $request->only('email', 'password');\\n\\n        // Get user\\n        $user = $this->user->where('email', $credentials['email'])->first();\\n\\n        try {\\n            // attempt to verify the credentials and create a token for the user\\n            if (! $token = JWTAuth::attempt($credentials)) {\\n                return response()->json(['error' => 'invalid_credentials'], 401);\\n            }\\n        } catch (JWTException $e) {\\n            // something went wrong whilst attempting to encode the token\\n            return response()->json(['error' => 'could_not_create_token'], 500);\\n        }\\n\\n        // all good so return the token\\n        return response()->json(compact('token'));\\n    }\\n}\\n\")), mdx(\"p\", null, \"And we need to set up the route in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"routes/api.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"<?php\\n\\nuse Illuminate\\\\Http\\\\Request;\\n\\n/*\\n|--------------------------------------------------------------------------\\n| API Routes\\n|--------------------------------------------------------------------------\\n|\\n| Here is where you can register API routes for your application. These\\n| routes are loaded by the RouteServiceProvider within a group which\\n| is assigned the \\\"api\\\" middleware group. Enjoy building your API!\\n|\\n*/\\n\\nRoute::post('authenticate', 'AuthenticateController@authenticate');\\n\")), mdx(\"p\", null, \"Note that because it's an API route, it's automatically prefixed with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"api/\"), \" without us having to do anything.\"), mdx(\"p\", null, \"Now if we run our tests, they should pass:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ vendor/bin/phpunit\\nPHPUnit 5.5.4 by Sebastian Bergmann and contributors.\\n\\n...                                                                 3 / 3 (100%)\\n\\nTime: 402 ms, Memory: 14.00MB\\n\\nOK (3 tests, 6 assertions)\\n\")), mdx(\"p\", null, \"Now we can obtain a JSON Web Token to authenticate users with. To start with we'll only support existing users, but later we'll add a method to sign up. However, we need at least one user to test with, so we'll create a seeder for that at \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"database/seeds/UserTableSeeder.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"<?php\\n\\nuse Illuminate\\\\Database\\\\Seeder;\\nuse Carbon\\\\Carbon;\\n\\nclass UserTableSeeder extends Seeder\\n{\\n    /**\\n     * Run the database seeds.\\n     *\\n     * @return void\\n     */\\n    public function run()\\n    {\\n        // Add user\\n        DB::table('users')->insert([\\n            'name' => 'bobsmith',\\n            'email' => 'bob@example.com',\\n            'created_at' => Carbon::now(),\\n            'updated_at' => Carbon::now(),\\n            'password' => Hash::make(\\\"password\\\")\\n        ]);\\n    }\\n}\\n\")), mdx(\"p\", null, \"You can run \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"php artisan make:seeder UserTableSeeder\"), \" to generate the file, or just paste it in. You also need to amend \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"database/seeds/DatabaseSeeder.php\"), \" as follows:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"<?php\\n\\nuse Illuminate\\\\Database\\\\Seeder;\\n\\nclass DatabaseSeeder extends Seeder\\n{\\n    /**\\n     * Run the database seeds.\\n     *\\n     * @return void\\n     */\\n    public function run()\\n    {\\n        $this->call(UserTableSeeder::class);\\n    }\\n}\\n\")), mdx(\"p\", null, \"This ensures the seeder will actually be called. Then, run the following commands:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ php artisan migrate\\n$ php artisan db:seed\\n\")), mdx(\"p\", null, \"That sets up our user in the database.\"), mdx(\"h2\", null, \"Adding the Pets endpoint\"), mdx(\"p\", null, \"Our next step is to add the pets model and endpoint. Our \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Pet\"), \" model should have the following fields:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"ID\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Timestamps (\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"created_at\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"updated_at\"), \")\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Name\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Path to photo\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Availability\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Type (eg cat, dog)\")), mdx(\"p\", null, \"Let's create a test for that model:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"<?php\\n\\nuse AnimalFriend\\\\Pet;\\n\\nclass PetModelTest extends TestCase\\n{\\n    /**\\n     * Test creating a pet\\n     *\\n     * @return void\\n     */\\n    public function testCreatingAPet()\\n    {\\n        // Create a Pet\\n        $pet = factory(AnimalFriend\\\\Pet::class)->create([\\n            'name' => 'Freddie',\\n            'type' => 'Cat',\\n        ]);\\n        $this->seeInDatabase('pets', ['type' => 'Cat']);\\n\\n        // Verify it works\\n        $saved = Pet::where('name', 'Freddie')->first();\\n        $this->assertEquals($saved->id, 1);\\n        $this->assertEquals($saved->name, 'Freddie');\\n        $this->assertEquals($saved->type, 'Cat');\\n        $this->assertEquals($saved->available, 1);\\n        $this->assertEquals($saved->picture, '1.jpg');\\n    }\\n}\\n\")), mdx(\"p\", null, \"Save this as \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"tests/PetModelTest.php\"), \". Then run the tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ vendor/bin/phpunit\\nPHPUnit 5.5.4 by Sebastian Bergmann and contributors.\\n\\n..E.                                                                4 / 4 (100%)\\n\\nTime: 414 ms, Memory: 16.00MB\\n\\nThere was 1 error:\\n\\n1) PetModelTest::testCreatingAUser\\nInvalidArgumentException: Unable to locate factory with name [default] [AnimalFriend\\\\Pet].\\n\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Database/Eloquent/FactoryBuilder.php:126\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:2280\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Database/Eloquent/FactoryBuilder.php:139\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Database/Eloquent/FactoryBuilder.php:106\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Database/Eloquent/FactoryBuilder.php:84\\n/home/matthew/Projects/mynewanimalfriend-backend/tests/PetModelTest.php:16\\n\\nERRORS!\\nTests: 4, Assertions: 6, Errors: 1.\\n\")), mdx(\"p\", null, \"First we need to create a factory for creating a pet in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"database/factories/ModelFactory.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"$factory->define(AnimalFriend\\\\Pet::class, function (Faker\\\\Generator $faker) {\\n    return [\\n        'name' => $faker->firstNameMale,\\n        'type' => 'Cat',\\n        'available' => 1,\\n        'picture' => '1.jpg'\\n    ];\\n});\\n\")), mdx(\"p\", null, \"Then, we create the model:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ php artisan make:model Pet\\n\")), mdx(\"p\", null, \"Next, we create a migration for the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Pet\"), \" model:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ php artisan make:migration create_pets_table\\nCreated Migration: 2016_09_11_145010_create_pets_table\\n\")), mdx(\"p\", null, \"And paste in the following code:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"<?php\\n\\nuse Illuminate\\\\Support\\\\Facades\\\\Schema;\\nuse Illuminate\\\\Database\\\\Schema\\\\Blueprint;\\nuse Illuminate\\\\Database\\\\Migrations\\\\Migration;\\n\\nclass CreatePetsTable extends Migration\\n{\\n    /**\\n     * Run the migrations.\\n     *\\n     * @return void\\n     */\\n    public function up()\\n    {\\n        Schema::create('pets', function (Blueprint $table) {\\n            $table->increments('id');\\n            $table->string('name');\\n            $table->string('type');\\n            $table->string('available');\\n            $table->string('picture')->nullable();\\n            $table->timestamps();\\n        });\\n    }\\n\\n    /**\\n     * Reverse the migrations.\\n     *\\n     * @return void\\n     */\\n    public function down()\\n    {\\n        Schema::drop('pets');\\n    }\\n}\\n\")), mdx(\"p\", null, \"Time to run the tests again:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ vendor/bin/phpunit\\nPHPUnit 5.5.4 by Sebastian Bergmann and contributors.\\n\\n....                                                                4 / 4 (100%)\\n\\nTime: 412 ms, Memory: 16.00MB\\n\\nOK (4 tests, 12 assertions)\\n\")), mdx(\"p\", null, \"With that done, we can start work on implementing the endpoint. We need to check that unauthorised users cannot retrieve the data, and that authorised users can. First, let's create \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"tests/PetControllerTest.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"<?php\\n\\nuse Illuminate\\\\Foundation\\\\Testing\\\\DatabaseMigrations;\\n\\nclass PetControllerTest extends TestCase\\n{\\n    use DatabaseMigrations;\\n\\n    /**\\n     * Test fetching pets when unauthorised\\n     *\\n     * @return void\\n     */\\n    public function testFetchingPetsWhenUnauthorised()\\n    {\\n        // Create a Pet\\n        $pet = factory(AnimalFriend\\\\Pet::class)->create([\\n            'name' => 'Freddie',\\n            'type' => 'Cat',\\n        ]);\\n        $this->seeInDatabase('pets', ['type' => 'Cat']);\\n\\n        // Create request\\n        $response = $this->call('GET', '/api/pets');\\n        $this->assertResponseStatus(400);\\n    }\\n\\n    /**\\n     * Test fetching pets when authorised\\n     *\\n     * @return void\\n     */\\n    public function testFetchingPets()\\n    {\\n        // Create a Pet\\n        $pet = factory(AnimalFriend\\\\Pet::class)->create([\\n            'name' => 'Freddie',\\n            'type' => 'Cat',\\n        ]);\\n        $this->seeInDatabase('pets', ['type' => 'Cat']);\\n\\n        // Create a User\\n        $user = factory(AnimalFriend\\\\User::class)->create([\\n            'name' => 'bobsmith',\\n            'email' => 'bob@example.com',\\n        ]);\\n        $this->seeInDatabase('users', ['email' => 'bob@example.com']);\\n\\n        // Create request\\n        $token = JWTAuth::fromUser($user);\\n        $headers = array(\\n            'Authorization' => 'Bearer '.$token\\n        );\\n\\n        // Send it\\n        $this->json('GET', '/api/pets', [], $headers)\\n            ->seeJsonStructure([\\n                '*' => [\\n                    'id',\\n                    'name',\\n                    'type',\\n                    'available',\\n                    'picture',\\n                    'created_at',\\n                    'updated_at'\\n                ]\\n            ]);\\n        $this->assertResponseStatus(200);\\n    }\\n}\\n\")), mdx(\"p\", null, \"First, we create a pet, make an HTTP request to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/api/pets\"), \", and check we are not authorised. Next, we do the same, but also create a user and a JSON Web Token, and pass the token through in the request. Then we verify the response data and that it was successful.\"), mdx(\"p\", null, \"Let's run the tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ vendor/bin/phpunit \\nPHPUnit 5.5.4 by Sebastian Bergmann and contributors.\\n\\n..FF..                                                              6 / 6 (100%)\\n\\nTime: 509 ms, Memory: 16.00MB\\n\\nThere were 2 failures:\\n\\n1) PetControllerTest::testFetchingPetsWhenUnauthorised\\nExpected status code 400, got 404.\\nFailed asserting that 404 matches expected 400.\\n\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:648\\n/home/matthew/Projects/mynewanimalfriend-backend/tests/PetControllerTest.php:25\\n\\n2) PetControllerTest::testFetchingPets\\nFailed asserting that null is of type \\\"array\\\".\\n\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:295\\n/home/matthew/Projects/mynewanimalfriend-backend/tests/PetControllerTest.php:67\\n\\nFAILURES!\\nTests: 6, Assertions: 17, Failures: 2.\\n\")), mdx(\"p\", null, \"That looks correct, so we can start building our endpoint. We can generate a boilerplate for it as follows:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ $ php artisan make:controller PetController --resource\\n\")), mdx(\"p\", null, \"Note the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"--resource\"), \" flag - this tells Laravel to set it up to be a RESTful controller with certain predefined functions. Next, let's amend the new file at \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"app\\\\Http\\\\Controllers/PetController.php\"), \" as follows:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"<?php\\n\\nnamespace AnimalFriend\\\\Http\\\\Controllers;\\n\\nuse Illuminate\\\\Http\\\\Request;\\n\\nuse AnimalFriend\\\\Http\\\\Requests;\\nuse AnimalFriend\\\\Pet;\\n\\nclass PetController extends Controller\\n{\\n    private $pet;\\n\\n    public function __construct(Pet $pet) {\\n        $this->pet = $pet;\\n    }\\n\\n    /**\\n     * Display a listing of the resource.\\n     *\\n     * @return \\\\Illuminate\\\\Http\\\\Response\\n     */\\n    public function index()\\n    {\\n        // Get all pets\\n        $pets = $this->pet->get();\\n\\n        // Send response\\n        return response()->json($pets, 200);\\n    }\\n}\\n\")), mdx(\"p\", null, \"This implements an index route that shows all pets. Next, we hook up the route in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"routes/api.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"// Auth routes\\nRoute::group(['middleware' => ['jwt.auth']], function () {\\n    Route::resource('pets', 'PetController');\\n});\\n\")), mdx(\"p\", null, \"Note that we wrap this resource in the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"jwt.auth\"), \" middleware to prevent access by unauthorised users. Implementing this as middleware makes it very easy to reuse. Also note that we can specify it as a resource, meaning we don't have to explicitly hook up each route to a controller method.\"), mdx(\"p\", null, \"Let's run the tests again:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ vendor/bin/phpunit \\nPHPUnit 5.5.4 by Sebastian Bergmann and contributors.\\n\\n..EE..                                                              6 / 6 (100%)\\n\\nTime: 511 ms, Memory: 16.00MB\\n\\nThere were 2 errors:\\n\\n1) PetControllerTest::testFetchingPetsWhenUnauthorised\\nReflectionException: Class jwt.auth does not exist\\n\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Container/Container.php:734\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Container/Container.php:629\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Application.php:709\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php:173\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:517\\n/home/matthew/Projects/mynewanimalfriend-backend/tests/PetControllerTest.php:24\\n\\n2) PetControllerTest::testFetchingPets\\nReflectionException: Class jwt.auth does not exist\\n\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Container/Container.php:734\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Container/Container.php:629\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Application.php:709\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php:173\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:517\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:72\\n/home/matthew/Projects/mynewanimalfriend-backend/tests/PetControllerTest.php:56\\n\\nERRORS!\\nTests: 6, Assertions: 15, Errors: 2.\\n\")), mdx(\"p\", null, \"Looks like JWT isn't configured correctly. We can fix that in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"app/Http/Kernel.php\"), \" by adding it to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"$routeMiddleware\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"        'jwt.auth' => 'Tymon\\\\JWTAuth\\\\Middleware\\\\GetUserFromToken',\\n        'jwt.refresh' => 'Tymon\\\\JWTAuth\\\\Middleware\\\\RefreshToken',\\n\")), mdx(\"p\", null, \"And run the tests again:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ vendor/bin/phpunit\\nPHPUnit 5.5.4 by Sebastian Bergmann and contributors.\\n\\n......                                                              6 / 6 (100%)\\n\\nTime: 514 ms, Memory: 16.00MB\\n\\nOK (6 tests, 25 assertions)\\n\")), mdx(\"p\", null, \"Our final task for today on the API is building a route for fetching a single pet. Our tests need to handle three situations:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"An unauthorised request\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A request for a pet that does not exist\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A request for a pet that does exist\")), mdx(\"p\", null, \"Add these methods to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"tests/PetControllerTest.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"    /**\\n     * Test fetching pet when unauthorised\\n     *\\n     * @return void\\n     */\\n    public function testFetchingPetWhenUnauthorised()\\n    {\\n        // Create a Pet\\n        $pet = factory(AnimalFriend\\\\Pet::class)->create([\\n            'name' => 'Freddie',\\n            'type' => 'Cat',\\n        ]);\\n        $this->seeInDatabase('pets', ['type' => 'Cat']);\\n\\n        // Send request\\n        $response = $this->call('GET', '/api/pets/'.$pet->id);\\n        $this->assertResponseStatus(400);\\n    }\\n\\n    /**\\n     * Test fetching pet which does not exist\\n     *\\n     * @return void\\n     */\\n    public function testFetchingPetDoesNotExist()\\n    {\\n        // Create a User\\n        $user = factory(AnimalFriend\\\\User::class)->create([\\n            'name' => 'bobsmith',\\n            'email' => 'bob@example.com',\\n        ]);\\n        $this->seeInDatabase('users', ['email' => 'bob@example.com']);\\n\\n        // Create request\\n        $token = JWTAuth::fromUser($user);\\n        $headers = array(\\n            'Authorization' => 'Bearer '.$token\\n        );\\n\\n        // Send it\\n        $this->json('GET', '/api/pets/1', [], $headers);\\n        $this->assertResponseStatus(404);\\n    }\\n\\n    /**\\n     * Test fetching pet when authorised\\n     *\\n     * @return void\\n     */\\n    public function testFetchingPet()\\n    {\\n        // Create a Pet\\n        $pet = factory(AnimalFriend\\\\Pet::class)->create([\\n            'name' => 'Freddie',\\n            'type' => 'Cat',\\n        ]);\\n        $this->seeInDatabase('pets', ['type' => 'Cat']);\\n\\n        // Create a User\\n        $user = factory(AnimalFriend\\\\User::class)->create([\\n            'name' => 'bobsmith',\\n            'email' => 'bob@example.com',\\n        ]);\\n        $this->seeInDatabase('users', ['email' => 'bob@example.com']);\\n\\n        // Create request\\n        $token = JWTAuth::fromUser($user);\\n        $headers = array(\\n            'Authorization' => 'Bearer '.$token\\n        );\\n\\n        // Send it\\n        $this->json('GET', '/api/pets/'.$pet->id, [], $headers)\\n            ->seeJsonStructure([\\n                'id',\\n                'name',\\n                'type',\\n                'available',\\n                'picture',\\n                'created_at',\\n                'updated_at'\\n            ]);\\n        $this->assertResponseStatus(200);\\n    }\\n\")), mdx(\"p\", null, \"Let's check our tests fail:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ vendor/bin/phpunit \\nPHPUnit 5.5.4 by Sebastian Bergmann and contributors.\\n\\n.....FE..                                                           9 / 9 (100%)\\n\\nTime: 974 ms, Memory: 16.00MB\\n\\nThere was 1 error:\\n\\n1) PetControllerTest::testFetchingPet\\nPHPUnit_Framework_Exception: Argument #2 (No Value) of PHPUnit_Framework_Assert::assertArrayHasKey() must be a array or ArrayAccess\\n\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:304\\n/home/matthew/Projects/mynewanimalfriend-backend/tests/PetControllerTest.php:145\\n\\n--\\n\\nThere was 1 failure:\\n\\n1) PetControllerTest::testFetchingPetDoesNotExist\\nExpected status code 404, got 400.\\nFailed asserting that 400 matches expected 404.\\n\\n/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:648\\n/home/matthew/Projects/mynewanimalfriend-backend/tests/PetControllerTest.php:112\\n\\nERRORS!\\nTests: 9, Assertions: 31, Errors: 1, Failures: 1.\\n\")), mdx(\"p\", null, \"Now, we already have the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"show()\"), \" method hooked up by default, so we just have to implement it in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"app/Http/Controllers/PetController.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\"\n  }, \"    /**\\n     * Display the specified resource.\\n     *\\n     * @param  int  $id\\n     * @return \\\\Illuminate\\\\Http\\\\Response\\n     */\\n    public function show($id)\\n    {\\n        // Get pet\\n        $pet = $this->pet->findOrFail($id);\\n\\n        // Send response\\n        return response()->json($pet, 200);\\n    }\\n\")), mdx(\"p\", null, \"And let's run our tests again:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ vendor/bin/phpunit \\nPHPUnit 5.5.4 by Sebastian Bergmann and contributors.\\n\\n.........                                                           9 / 9 (100%)\\n\\nTime: 693 ms, Memory: 16.00MB\\n\\nOK (9 tests, 39 assertions)\\n\")), mdx(\"p\", null, \"Now we have all the endpoints we need to get started with the app. You can find the source code for this backend on \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/matthewbdaly/mynewanimalfriend-backend\"\n  }, \"Github\"), \" - check out the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"lesson-1\"), \" tag.\"), mdx(\"p\", null, \"That seems like a good place to stop for now. We have our first pass at the back end. It's not complete by any means, but it's a good start, and is sufficient for us to get some basic functionality up and running in the app. In the next instalment we'll start working with Phonegap to build the first pass at the app itself. Later instalments will see us working with both the app and backend to build it into a more useful whole.\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"A lot of my work over the last few years has been on Phonegap apps. Phonegap isn't terribly hard to use, but the difference in context between that and a more conventional web app…","frontmatter":{"title":"Building a Phonegap app with Laravel and Angular - Part 1","date":"11th September 2016 6:33 pm","isoDate":"2016-09-11T18:33:41+00:00","categories":["php","laravel","javascript","angular","phonegap","laravel-phonegap-tutorial"]},"fields":{"path":"/blog/2016/09/11/building-a-phonegap-app-with-laravel-and-angular-part-1/"}}},"pageContext":{"previous":{"fields":{"path":"/blog/2016/09/05/deploying-new-versions-of-a-laravel-app-with-fabric/"},"frontmatter":{"title":"Deploying new versions of a Laravel app with Fabric","date":"2016-09-05 22:22:16 +0100","layout":"post"}},"next":{"fields":{"path":"/blog/2016/09/18/building-a-phonegap-app-with-laravel-and-angular-part-2/"},"frontmatter":{"title":"Building a Phonegap app with Laravel and Angular - Part 2","date":"2016-09-18 23:18:06 +0100","layout":"post"}}}},"staticQueryHashes":["290055352","2909664151"]}