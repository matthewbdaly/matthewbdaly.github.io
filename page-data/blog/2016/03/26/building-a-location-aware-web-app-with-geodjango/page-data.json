{"componentChunkName":"component---src-templates-post-tsx","path":"/blog/2016/03/26/building-a-location-aware-web-app-with-geodjango/","result":{"data":{"site":{"siteMetadata":{"title":"Matthew Daly","siteUrl":"https://matthewdaly.co.uk"}},"mdx":{"id":"d1c603e7-f311-554f-ae3f-bb3ef3b909ff","body":"var _excluded = [\"components\"];\nfunction _extends() { return _extends = Object.assign ? Object.assign.bind() : function (n) { for (var e = 1; e < arguments.length; e++) { var t = arguments[e]; for (var r in t) ({}).hasOwnProperty.call(t, r) && (n[r] = t[r]); } return n; }, _extends.apply(null, arguments); }\nfunction _objectWithoutProperties(e, t) { if (null == e) return {}; var o, r, i = _objectWithoutPropertiesLoose(e, t); if (Object.getOwnPropertySymbols) { var n = Object.getOwnPropertySymbols(e); for (r = 0; r < n.length; r++) o = n[r], t.indexOf(o) >= 0 || {}.propertyIsEnumerable.call(e, o) && (i[o] = e[o]); } return i; }\nfunction _objectWithoutPropertiesLoose(r, e) { if (null == r) return {}; var t = {}; for (var n in r) if ({}.hasOwnProperty.call(r, n)) { if (e.indexOf(n) >= 0) continue; t[n] = r[n]; } return t; }\n/* @jsxRuntime classic */\n/* @jsx mdx */\n\nvar _frontmatter = {\n  \"title\": \"Building a location aware web app with GeoDjango\",\n  \"date\": \"2016-03-26 21:30:29 +0000\",\n  \"layout\": \"post\",\n  \"categories\": [\"python\", \"django\", \"tdd\", \"postgres\", \"geo\", \"geodjango\"],\n  \"comments\": true\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n    props = _objectWithoutProperties(_ref, _excluded);\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"PostgreSQL has excellent support for geographical data thanks to the PostGIS extension, and Django allows you to take full advantage of it thanks to GeoDjango. In this tutorial, I'll show you how to use GeoDjango to build a web app that allows users to search for gigs and events near them.\"), mdx(\"h2\", null, \"Requirements\"), mdx(\"p\", null, \"I've made the jump to Python 3, and if you haven't done so yet, I highly recommend it - it's not hard, and there's very few modules left that haven't been ported across. As such, this tutorial assumes you're using Python 3. You'll also need to have Git, PostgreSQL and PostGIS installed - I'll leave the details of doing so up to you as it varies by platform, but you can generally do so easily with a package manager on most Linux distros. On Mac OS X I recommend using Homebrew. If you're on Windows I think your best bet is probably to use a Vagrant VM.\"), mdx(\"p\", null, \"We'll be using Django 1.9 - if by the time you read this a newer version of Django is out, it's quite possible that some things may have changed and you'll need to work around any problems caused. Generally search engines are the best place to look for this, and I'll endeavour to keep the resulting Github repository as up to date as I can, so try those if you get stuck.\"), mdx(\"h2\", null, \"Getting started\"), mdx(\"p\", null, \"First of all, let's create our database. Make sure you're running as a user that has the required privileges to create users and databases for PostgreSQL and run the following command:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ createdb gigfinder\\n\")), mdx(\"p\", null, \"This creates the database. Next, we create the user:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ createuser -s giguser -P\\n\")), mdx(\"p\", null, \"You'll be prompted to enter a password for the new user. Next, we want to use the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"psql\"), \" command-line client to interact with our new database:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ psql gigfinder\\n\")), mdx(\"p\", null, \"This connects to the database. Run these commands to set up access to the database and install the PostGIS extension:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-psql\"\n  }, \"# GRANT ALL PRIVILEGES ON DATABASE gigfinder TO giguser;\\n# CREATE EXTENSION postgis;\\n# \\\\q\\n\")), mdx(\"p\", null, \"With our database set up, it's time to start work on our project. Let's create our virtualenv in a new folder:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ pyvenv venv\\n\")), mdx(\"p\", null, \"Then activate it:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ source venv/bin/activate\\n\")), mdx(\"p\", null, \"Then we install Django, along with a few other production dependencies:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ pip install django-toolbelt\\n\")), mdx(\"p\", null, \"And record our dependencies:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ pip freeze > requirements.txt\\n\")), mdx(\"p\", null, \"Next, we create our application skeleton:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ django-admin.py startproject gigfinder .\\n\")), mdx(\"p\", null, \"We'll also create a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \".gitignore\"), \" file:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"venv/\\n.DS_Store\\n*.swp\\nnode_modules/\\n*.pyc\\n\")), mdx(\"p\", null, \"Let's commit our changes:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ git init\\n$ git add .gitignore requirements.txt manage.py gigfinder\\n$ git commit -m 'Initial commit'\\n\")), mdx(\"p\", null, \"Next, let's create our first app, which we will call \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py startapp gigs\\n\")), mdx(\"p\", null, \"We need to add our new app to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"INSTALLED_APPS\"), \" setting. While we're there we'll also add GIS support and set up the database connection. First, add the required apps to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"INSTALLED_APPS\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"INSTALLED_APPS = [\\n    ...\\n    'django.contrib.gis',\\n    'gigs',\\n]\\n\")), mdx(\"p\", null, \"Next, configure the database:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"DATABASES = {\\n    'default': {\\n         'ENGINE': 'django.contrib.gis.db.backends.postgis',\\n         'NAME': 'gigfinder',\\n         'USER': 'giguser',\\n         'PASSWORD': 'password',\\n    },\\n}\\n\")), mdx(\"p\", null, \"Let's run the migrations:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py migrate\\nOperations to perform:\\n  Apply all migrations: sessions, contenttypes, admin, auth\\nRunning migrations:\\n  Rendering model states... DONE\\n  Applying contenttypes.0001_initial... OK\\n  Applying auth.0001_initial... OK\\n  Applying admin.0001_initial... OK\\n  Applying admin.0002_logentry_remove_auto_add... OK\\n  Applying contenttypes.0002_remove_content_type_name... OK\\n  Applying auth.0002_alter_permission_name_max_length... OK\\n  Applying auth.0003_alter_user_email_max_length... OK\\n  Applying auth.0004_alter_user_username_opts... OK\\n  Applying auth.0005_alter_user_last_login_null... OK\\n  Applying auth.0006_require_contenttypes_0002... OK\\n  Applying auth.0007_alter_validators_add_error_messages... OK\\n  Applying sessions.0001_initial... OK\\n\")), mdx(\"p\", null, \"And create our superuser account:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py createsuperuser\\n\")), mdx(\"p\", null, \"Now, we'll commit our changes:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ git add gigfinder/ gigs/\\n$ git commit -m 'Created gigs app'\\n[master e72a846] Created gigs app\\n 8 files changed, 24 insertions(+), 3 deletions(-)\\n create mode 100644 gigs/__init__.py\\n create mode 100644 gigs/admin.py\\n create mode 100644 gigs/apps.py\\n create mode 100644 gigs/migrations/__init__.py\\n create mode 100644 gigs/models.py\\n create mode 100644 gigs/tests.py\\n create mode 100644 gigs/views.py\\n\")), mdx(\"h2\", null, \"Our first model\"), mdx(\"p\", null, \"At this point, it's worth thinking about the models we plan for our app to have. First we'll have a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Venue\"), \" model that contains details of an individual venue, which will include a name and a geographical location. We'll also have an \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Event\"), \" model that will represent an individual gig or event at a venue, and will include a name, date/time and a venue as a foreign key.\"), mdx(\"p\", null, \"Before we start writing our first model, we need to write a test for it, but we also need to be able to create objects easily in our tests. We also want to be able to easily examine our objects, so we'll install iPDB and Factory Boy:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ pip install ipdb factory-boy\\n$ pip freeze > requirements.txt\\n\")), mdx(\"p\", null, \"Next, we write a test for the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Venue\"), \" model:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.test import TestCase\\nfrom gigs.models import Venue\\nfrom factory.fuzzy import BaseFuzzyAttribute\\nfrom django.contrib.gis.geos import Point\\nimport factory.django, random\\n\\nclass FuzzyPoint(BaseFuzzyAttribute):\\n    def fuzz(self):\\n        return Point(random.uniform(-180.0, 180.0),\\n                     random.uniform(-90.0, 90.0))\\n\\n#\\xA0Factories for tests\\nclass VenueFactory(factory.django.DjangoModelFactory):\\n    class Meta:\\n        model = Venue\\n        django_get_or_create = (\\n            'name',\\n            'location'\\n        )\\n\\n    name = 'Wembley Arena'\\n    location = FuzzyPoint()\\n\\nclass VenueTest(TestCase):\\n    def test_create_venue(self):\\n        # Create the venue\\n        venue = VenueFactory()\\n\\n        #\\xA0Check we can find it\\n        all_venues = Venue.objects.all()\\n        self.assertEqual(len(all_venues), 1)\\n        only_venue = all_venues[0]\\n        self.assertEqual(only_venue, venue)\\n\\n        #\\xA0Check attributes\\n        self.assertEqual(only_venue.name, 'Wembley Arena')\\n\")), mdx(\"p\", null, \"Note that we randomly generate our location - this is done as suggested in \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"http://stackoverflow.com/questions/32828890/using-factory-boy-with-geodjango-pointfields\"\n  }, \"this Stack Overflow post\"), \".\"), mdx(\"p\", null, \"Now, running our tests brings up an expected error:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\nE\\n======================================================================\\nERROR: gigs.tests (unittest.loader._FailedTest)\\n----------------------------------------------------------------------\\nImportError: Failed to import test module: gigs.tests\\nTraceback (most recent call last):\\n  File \\\"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py\\\", line 428, in _find_test_path\\n    module = self._get_module_from_name(name)\\n  File \\\"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py\\\", line 369, in _get_module_from_name\\n    __import__(name)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py\\\", line 2, in <module>\\n    from gigs.models import Venue\\nImportError: cannot import name 'Venue'\\n\\n\\n----------------------------------------------------------------------\\nRan 1 test in 0.001s\\n\\nFAILED (errors=1)\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"Let's create our \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Venue\"), \" model in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/models.py\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.contrib.gis.db import models\\n\\nclass Venue(models.Model):\\n    \\\"\\\"\\\"\\n    Model for a venue\\n    \\\"\\\"\\\"\\n    pass\\n\")), mdx(\"p\", null, \"For now, we're just creating a simple dummy model. Note that we import \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"models\"), \" from \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"django.contrib.gis.db\"), \" instead of the usual place - this gives us access to the additional geographical fields.\"), mdx(\"p\", null, \"If we run our tests again we get an error:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\nTraceback (most recent call last):\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py\\\", line 64, in execute\\n    return self.cursor.execute(sql, params)\\npsycopg2.ProgrammingError: relation \\\"gigs_venue\\\" does not exist\\nLINE 1: SELECT \\\"gigs_venue\\\".\\\"id\\\" FROM \\\"gigs_venue\\\" ORDER BY \\\"gigs_ve...\\n                                      ^\\n\\n\\nThe above exception was the direct cause of the following exception:\\n\\nTraceback (most recent call last):\\n  File \\\"manage.py\\\", line 10, in <module>\\n    execute_from_command_line(sys.argv)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py\\\", line 353, in execute_from_command_line\\n    utility.execute()\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py\\\", line 345, in execute\\n    self.fetch_command(subcommand).run_from_argv(self.argv)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py\\\", line 30, in run_from_argv\\n    super(Command, self).run_from_argv(argv)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py\\\", line 348, in run_from_argv\\n    self.execute(*args, **cmd_options)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py\\\", line 74, in execute\\n    super(Command, self).execute(*args, **options)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py\\\", line 399, in execute\\n    output = self.handle(*args, **options)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py\\\", line 90, in handle\\n    failures = test_runner.run_tests(test_labels)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py\\\", line 532, in run_tests\\n    old_config = self.setup_databases()\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py\\\", line 482, in setup_databases\\n    self.parallel, **kwargs\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py\\\", line 726, in setup_databases\\n    serialize=connection.settings_dict.get(\\\"TEST\\\", {}).get(\\\"SERIALIZE\\\", True),\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py\\\", line 78, in create_test_db\\n    self.connection._test_serialized_contents = self.serialize_db_to_string()\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py\\\", line 122, in serialize_db_to_string\\n    serializers.serialize(\\\"json\\\", get_objects(), indent=None, stream=out)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/__init__.py\\\", line 129, in serialize\\n    s.serialize(queryset, **options)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/base.py\\\", line 79, in serialize\\n    for count, obj in enumerate(queryset, start=1):\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py\\\", line 118, in get_objects\\n    for obj in queryset.iterator():\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/query.py\\\", line 52, in __iter__\\n    results = compiler.execute_sql()\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/sql/compiler.py\\\", line 848, in execute_sql\\n    cursor.execute(sql, params)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py\\\", line 64, in execute\\n    return self.cursor.execute(sql, params)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/utils.py\\\", line 95, in __exit__\\n    six.reraise(dj_exc_type, dj_exc_value, traceback)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/utils/six.py\\\", line 685, in reraise\\n    raise value.with_traceback(tb)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py\\\", line 64, in execute\\n    return self.cursor.execute(sql, params)\\ndjango.db.utils.ProgrammingError: relation \\\"gigs_venue\\\" does not exist\\nLINE 1: SELECT \\\"gigs_venue\\\".\\\"id\\\" FROM \\\"gigs_venue\\\" ORDER BY \\\"gigs_ve...\\n\")), mdx(\"p\", null, \"Let's update our model:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.contrib.gis.db import models\\n\\nclass Venue(models.Model):\\n    \\\"\\\"\\\"\\n    Model for a venue\\n    \\\"\\\"\\\"\\n    name = models.CharField(max_length=200)\\n    location = models.PointField()\\n\")), mdx(\"p\", null, \"Then create our migration:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py makemigrations\\nMigrations for 'gigs':\\n  0001_initial.py:\\n    - Create model Venue\\n\")), mdx(\"p\", null, \"And run it:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py migrate\\nOperations to perform:\\n  Apply all migrations: gigs, sessions, contenttypes, auth, admin\\nRunning migrations:\\n  Rendering model states... DONE\\n  Applying gigs.0001_initial... OK\\n\")), mdx(\"p\", null, \"Then if we run our tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\n.\\n----------------------------------------------------------------------\\nRan 1 test in 0.362s\\n\\nOK\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"They should pass. Note that Django may complain about needing to delete the test database before running the tests, but this should not cause any problems. Let's commit our changes:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ git add requirements.txt gigs/\\n$ git commit -m 'Venue model in place'\\n\")), mdx(\"p\", null, \"With our venue done, let's turn to our \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Event\"), \" model. Amend \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/tests.py\"), \" as follows:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.test import TestCase\\nfrom gigs.models import Venue, Event\\nfrom factory.fuzzy import BaseFuzzyAttribute\\nfrom django.contrib.gis.geos import Point\\nimport factory.django, random\\nfrom django.utils import timezone\\n\\nclass FuzzyPoint(BaseFuzzyAttribute):\\n    def fuzz(self):\\n        return Point(random.uniform(-180.0, 180.0),\\n                     random.uniform(-90.0, 90.0))\\n\\n#\\xA0Factories for tests\\nclass VenueFactory(factory.django.DjangoModelFactory):\\n    class Meta:\\n        model = Venue\\n        django_get_or_create = (\\n            'name',\\n            'location'\\n        )\\n\\n    name = 'Wembley Arena'\\n    location = FuzzyPoint()\\n\\nclass EventFactory(factory.django.DjangoModelFactory):\\n    class Meta:\\n        model = Event\\n        django_get_or_create = (\\n            'name',\\n            'venue',\\n            'datetime'\\n        )\\n\\n    name = 'Queens of the Stone Age'\\n    datetime = timezone.now()\\n\\nclass VenueTest(TestCase):\\n    def test_create_venue(self):\\n        # Create the venue\\n        venue = VenueFactory()\\n\\n        #\\xA0Check we can find it\\n        all_venues = Venue.objects.all()\\n        self.assertEqual(len(all_venues), 1)\\n        only_venue = all_venues[0]\\n        self.assertEqual(only_venue, venue)\\n\\n        #\\xA0Check attributes\\n        self.assertEqual(only_venue.name, 'Wembley Arena')\\n\\n\\nclass EventTest(TestCase):\\n    def test_create_event(self):\\n        # Create the venue\\n        venue = VenueFactory()\\n\\n        #\\xA0Create the event\\n        event = EventFactory(venue=venue)\\n\\n        #\\xA0Check we can find it\\n        all_events = Event.objects.all()\\n        self.assertEqual(len(all_events), 1)\\n        only_event = all_events[0]\\n        self.assertEqual(only_event, event)\\n\\n        #\\xA0Check attributes\\n        self.assertEqual(only_event.name, 'Queens of the Stone Age')\\n        self.assertEqual(only_event.venue.name, 'Wembley Arena')\\n\")), mdx(\"p\", null, \"Then we run our tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\nE\\n======================================================================\\nERROR: gigs.tests (unittest.loader._FailedTest)\\n----------------------------------------------------------------------\\nImportError: Failed to import test module: gigs.tests\\nTraceback (most recent call last):\\n  File \\\"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py\\\", line 428, in _find_test_path\\n    module = self._get_module_from_name(name)\\n  File \\\"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py\\\", line 369, in _get_module_from_name\\n    __import__(name)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py\\\", line 2, in <module>\\n    from gigs.models import Venue, Event\\nImportError: cannot import name 'Event'\\n\\n\\n----------------------------------------------------------------------\\nRan 1 test in 0.001s\\n\\nFAILED (errors=1)\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"As expected, this fails, so create an empty \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Event\"), \" model in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/models.py\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"class Event(models.Model):\\n    \\\"\\\"\\\"\\n    Model for an event\\n    \\\"\\\"\\\"\\n    pass\\n\")), mdx(\"p\", null, \"Running the tests now will raise an error due to the table not existing:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\nTraceback (most recent call last):\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py\\\", line 64, in execute\\n    return self.cursor.execute(sql, params)\\npsycopg2.ProgrammingError: relation \\\"gigs_event\\\" does not exist\\nLINE 1: SELECT \\\"gigs_event\\\".\\\"id\\\" FROM \\\"gigs_event\\\" ORDER BY \\\"gigs_ev...\\n                                      ^\\n\\n\\nThe above exception was the direct cause of the following exception:\\n\\nTraceback (most recent call last):\\n  File \\\"manage.py\\\", line 10, in <module>\\n    execute_from_command_line(sys.argv)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py\\\", line 353, in execute_from_command_line\\n    utility.execute()\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py\\\", line 345, in execute\\n    self.fetch_command(subcommand).run_from_argv(self.argv)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py\\\", line 30, in run_from_argv\\n    super(Command, self).run_from_argv(argv)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py\\\", line 348, in run_from_argv\\n    self.execute(*args, **cmd_options)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py\\\", line 74, in execute\\n    super(Command, self).execute(*args, **options)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py\\\", line 399, in execute\\n    output = self.handle(*args, **options)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py\\\", line 90, in handle\\n    failures = test_runner.run_tests(test_labels)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py\\\", line 532, in run_tests\\n    old_config = self.setup_databases()\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py\\\", line 482, in setup_databases\\n    self.parallel, **kwargs\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py\\\", line 726, in setup_databases\\n    serialize=connection.settings_dict.get(\\\"TEST\\\", {}).get(\\\"SERIALIZE\\\", True),\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py\\\", line 78, in create_test_db\\n    self.connection._test_serialized_contents = self.serialize_db_to_string()\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py\\\", line 122, in serialize_db_to_string\\n    serializers.serialize(\\\"json\\\", get_objects(), indent=None, stream=out)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/__init__.py\\\", line 129, in serialize\\n    s.serialize(queryset, **options)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/base.py\\\", line 79, in serialize\\n    for count, obj in enumerate(queryset, start=1):\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py\\\", line 118, in get_objects\\n    for obj in queryset.iterator():\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/query.py\\\", line 52, in __iter__\\n    results = compiler.execute_sql()\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/sql/compiler.py\\\", line 848, in execute_sql\\n    cursor.execute(sql, params)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py\\\", line 64, in execute\\n    return self.cursor.execute(sql, params)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/utils.py\\\", line 95, in __exit__\\n    six.reraise(dj_exc_type, dj_exc_value, traceback)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/utils/six.py\\\", line 685, in reraise\\n    raise value.with_traceback(tb)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py\\\", line 64, in execute\\n    return self.cursor.execute(sql, params)\\ndjango.db.utils.ProgrammingError: relation \\\"gigs_event\\\" does not exist\\nLINE 1: SELECT \\\"gigs_event\\\".\\\"id\\\" FROM \\\"gigs_event\\\" ORDER BY \\\"gigs_ev...\\n\")), mdx(\"p\", null, \"So let's populate our model:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"class Event(models.Model):\\n    \\\"\\\"\\\"\\n    Model for an event\\n    \\\"\\\"\\\"\\n    name = models.CharField(max_length=200)\\n    datetime = models.DateTimeField()\\n    venue = models.ForeignKey(Venue)\\n\")), mdx(\"p\", null, \"And create our migration:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py makemigrations\\nMigrations for 'gigs':\\n  0002_event.py:\\n    - Create model Event\\n\")), mdx(\"p\", null, \"And run it:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py migrate\\nOperations to perform:\\n  Apply all migrations: auth, admin, sessions, contenttypes, gigs\\nRunning migrations:\\n  Rendering model states... DONE\\n  Applying gigs.0002_event... OK\\n\")), mdx(\"p\", null, \"And run our tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\n..\\n----------------------------------------------------------------------\\nRan 2 tests in 0.033s\\n\\nOK\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"Again, you may be prompted to delete the test database, but this should not be an issue.\"), mdx(\"p\", null, \"With this done, let's commit our changes:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ git add gigs\\n$ git commit -m 'Added Event model'\\n[master 47ba686] Added Event model\\n 3 files changed, 67 insertions(+), 1 deletion(-)\\n create mode 100644 gigs/migrations/0002_event.py\\n\")), mdx(\"h2\", null, \"Setting up the admin\"), mdx(\"p\", null, \"For an application like this, you'd expect the curators of the site to maintain the gigs and venues stored in the database, and that's an obvious use case for the Django admin. So let's set our models up to be available in the admin. Open up \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/admin.py\"), \" and amend it as follows:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.contrib import admin\\nfrom gigs.models import Venue, Event\\n\\nadmin.site.register(Venue)\\nadmin.site.register(Event)\\n\")), mdx(\"p\", null, \"Now, if you start up the dev server as usual with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"python manage.py runserver\"), \" and visit \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"http://127.0.0.1:8000/admin/\"\n  }, \"http://127.0.0.1:8000/admin/\"), \", you can see that our \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Event\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Venue\"), \" models are now available. However, the string representations of them are pretty useless. Let's fix that. First, we amend our tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.test import TestCase\\nfrom gigs.models import Venue, Event\\nfrom factory.fuzzy import BaseFuzzyAttribute\\nfrom django.contrib.gis.geos import Point\\nimport factory.django, random\\nfrom django.utils import timezone\\n\\nclass FuzzyPoint(BaseFuzzyAttribute):\\n    def fuzz(self):\\n        return Point(random.uniform(-180.0, 180.0),\\n                     random.uniform(-90.0, 90.0))\\n\\n#\\xA0Factories for tests\\nclass VenueFactory(factory.django.DjangoModelFactory):\\n    class Meta:\\n        model = Venue\\n        django_get_or_create = (\\n            'name',\\n            'location'\\n        )\\n\\n    name = 'Wembley Arena'\\n    location = FuzzyPoint()\\n\\nclass EventFactory(factory.django.DjangoModelFactory):\\n    class Meta:\\n        model = Event\\n        django_get_or_create = (\\n            'name',\\n            'venue',\\n            'datetime'\\n        )\\n\\n    name = 'Queens of the Stone Age'\\n    datetime = timezone.now()\\n\\nclass VenueTest(TestCase):\\n    def test_create_venue(self):\\n        # Create the venue\\n        venue = VenueFactory()\\n\\n        #\\xA0Check we can find it\\n        all_venues = Venue.objects.all()\\n        self.assertEqual(len(all_venues), 1)\\n        only_venue = all_venues[0]\\n        self.assertEqual(only_venue, venue)\\n\\n        #\\xA0Check attributes\\n        self.assertEqual(only_venue.name, 'Wembley Arena')\\n\\n        #\\xA0Check string representation\\n        self.assertEqual(only_venue.__str__(), 'Wembley Arena')\\n\\n\\nclass EventTest(TestCase):\\n    def test_create_event(self):\\n        # Create the venue\\n        venue = VenueFactory()\\n\\n        #\\xA0Create the event\\n        event = EventFactory(venue=venue)\\n\\n        #\\xA0Check we can find it\\n        all_events = Event.objects.all()\\n        self.assertEqual(len(all_events), 1)\\n        only_event = all_events[0]\\n        self.assertEqual(only_event, event)\\n\\n        #\\xA0Check attributes\\n        self.assertEqual(only_event.name, 'Queens of the Stone Age')\\n        self.assertEqual(only_event.venue.name, 'Wembley Arena')\\n\\n        #\\xA0Check string representation\\n        self.assertEqual(only_event.__str__(), 'Queens of the Stone Age - Wembley Arena')\\n\")), mdx(\"p\", null, \"Next, we run our tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\nFF\\n======================================================================\\nFAIL: test_create_event (gigs.tests.EventTest)\\n----------------------------------------------------------------------\\nTraceback (most recent call last):\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py\\\", line 74, in test_create_event\\n    self.assertEqual(only_event.__str__(), 'Queens of the Stone Age - Wembley Arena')\\nAssertionError: 'Event object' != 'Queens of the Stone Age - Wembley Arena'\\n- Event object\\n+ Queens of the Stone Age - Wembley Arena\\n\\n\\n======================================================================\\nFAIL: test_create_venue (gigs.tests.VenueTest)\\n----------------------------------------------------------------------\\nTraceback (most recent call last):\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py\\\", line 52, in test_create_venue\\n    self.assertEqual(only_venue.__str__(), 'Wembley Arena')\\nAssertionError: 'Venue object' != 'Wembley Arena'\\n- Venue object\\n+ Wembley Arena\\n\\n\\n----------------------------------------------------------------------\\nRan 2 tests in 0.059s\\n\\nFAILED (failures=2)\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"They fail as expected. So let's update \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/models.py\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.contrib.gis.db import models\\n\\nclass Venue(models.Model):\\n    \\\"\\\"\\\"\\n    Model for a venue\\n    \\\"\\\"\\\"\\n    name = models.CharField(max_length=200)\\n    location = models.PointField()\\n\\n    def __str__(self):\\n        return self.name\\n\\n\\nclass Event(models.Model):\\n    \\\"\\\"\\\"\\n    Model for an event\\n    \\\"\\\"\\\"\\n    name = models.CharField(max_length=200)\\n    datetime = models.DateTimeField()\\n    venue = models.ForeignKey(Venue)\\n\\n    def __str__(self):\\n        return \\\"%s - %s\\\" % (self.name, self.venue.name)\\n\")), mdx(\"p\", null, \"For the venue, we just use the name. For the event, we use the event name and the venue name.\"), mdx(\"p\", null, \"Now, we run our tests again:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\n..\\n----------------------------------------------------------------------\\nRan 2 tests in 0.048s\\n\\nOK\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"Time to commit our changes:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ git add gigs\\n$ git commit -m 'Added models to admin'\\n[master 65d051f] Added models to admin\\n 3 files changed, 15 insertions(+), 1 deletion(-)\\n\")), mdx(\"p\", null, \"Our models are now in place, so you may want to log into the admin and create a few venues and events so you can see it in action. Note that the location field for the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Venue\"), \" model creates a map widget that allows you to select a geographical location. It is a bit basic, however, so let's make it better. Let's install \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"django-floppyforms\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ pip install django-floppyforms\\n\")), mdx(\"p\", null, \"And add it to our requirements:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ pip freeze -r requirements.txt\\n\")), mdx(\"p\", null, \"Then add it to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"INSTALLED_APPS\"), \" in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigfinder/setttings.py\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"INSTALLED_APPS = [\\n    ...\\n    'django.contrib.gis',\\n    'gigs',\\n    'floppyforms',\\n]\\n\")), mdx(\"p\", null, \"Now we create a custom point widget for our admin, a custom form for the venues, and a custom venue admin:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.contrib import admin\\nfrom gigs.models import Venue, Event\\nfrom django.forms import ModelForm\\nfrom floppyforms.gis import PointWidget, BaseGMapWidget\\n\\nclass CustomPointWidget(PointWidget, BaseGMapWidget):\\n    class Media:\\n        js = ('/static/floppyforms/js/MapWidget.js',)\\n\\nclass VenueAdminForm(ModelForm):\\n    class Meta:\\n        model = Venue\\n        fields = ['name', 'location']\\n        widgets = {\\n            'location': CustomPointWidget()\\n        }\\n\\nclass VenueAdmin(admin.ModelAdmin):\\n    form = VenueAdminForm\\n\\nadmin.site.register(Venue, VenueAdmin)\\nadmin.site.register(Event)\\n\")), mdx(\"p\", null, \"Note in particular that we define the media for our widget so we can include some required Javascript. If you run the dev server again, you should see that the map widget in the admin is now provided by Google Maps, making it much easier to identify the correct location of the venue.\"), mdx(\"p\", null, \"Time to commit our changes:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ git add gigfinder/ gigs/ requirements.txt\\n$ git commit -m 'Customised location widget'\\n\")), mdx(\"p\", null, \"With our admin ready, it's time to move on to the user-facing part of the web app.\"), mdx(\"h2\", null, \"Creating our views\"), mdx(\"p\", null, \"We will keep the front end for this app as simple as possible for the purposes of this tutorial, but of course you should feel free to expand upon this as you see fit. What we'll do is create a form that uses HTML5 geolocation to get the user's current geographical coordinates. It will then return events in the next week, ordered by how close the venue is. Please note that there are plans afoot in some browsers to prevent HTML5 geolocation from working unless content is server over HTTPS, so that may complicate things.\"), mdx(\"p\", null, \"How do we query the database to get this data? It's not too difficult, as shown in this example:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py shell\\nPython 3.5.1 (default, Mar 25 2016, 00:17:15)\\nType \\\"copyright\\\", \\\"credits\\\" or \\\"license\\\" for more information.\\n\\nIPython 4.1.2 -- An enhanced Interactive Python.\\n?         -> Introduction and overview of IPython's features.\\n%quickref -> Quick reference.\\nhelp      -> Python's own help system.\\nobject?   -> Details about 'object', use 'object??' for extra details.\\n\\nIn [1]: from gigs.models import *\\n\\nIn [2]: from django.contrib.gis.geos import Point\\n\\nIn [3]: from django.contrib.gis.db.models.functions import Distance\\n\\nIn [4]: location = Point(52.3749159, 1.1067473, srid=4326)\\n\\nIn [5]: Venue.objects.all().annotate(distance=Distance('location', location)).order_by('distance')\\nOut[5]: [<Venue: Diss Corn Hall>, <Venue: Waterfront Norwich>, <Venue: UEA Norwich>, <Venue: Wembley Arena>]\\n\")), mdx(\"p\", null, \"I've set up a number of venues using the admin, one round the corner, two in Norwich, and one in London. I then imported the models, the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Point\"), \" class, and the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Distance\"), \" function, and created a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Point\"), \" object. Note that the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Point\"), \" is passed three fields - the first and second are the latitude and longitude, respectively, while the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"srid\"), \" field takes a value of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"4326\"), \". This field represents the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://en.wikipedia.org/wiki/SRID\"\n  }, \"Spatial Reference System Identifier\"), \" used for this query - we've gone for \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://en.wikipedia.org/wiki/World_Geodetic_System#WGS84\"\n  }, \"WGS 84\"), \", which is a common choice and is referred to with the SRID 4326.\"), mdx(\"p\", null, \"Now, we want the user to be able to submit the form and get the 5 nearest events in the next week. We can get the date for this time next week as follows:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"In [6]: next_week = timezone.now() + timezone.timedelta(weeks=1)\\n\")), mdx(\"p\", null, \"Then we can get the events we want, sorted by distance, like this:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"In [7]: Event.objects.filter(datetime__gte=timezone.now()).filter(datetime__lte=next_week).annotate(distance=Distance('venue__location', location)).order_by('distance')[0:5]\\nOut[7]: [<Event: Primal Scream - UEA Norwich>, <Event: Queens of the Stone Age - Wembley Arena>]\\n\")), mdx(\"p\", null, \"With that in mind, let's write the test for our view. The view should contain a single form that accepts a user's geographical coordinates - for convenience we'll auto-complete this with HTML5 geolocation. On submit, the user should see a list of the five closest events in the next week.\"), mdx(\"p\", null, \"First, let's test the GET request. Amend \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/tests.py\"), \" as follows:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.test import TestCase\\nfrom gigs.models import Venue, Event\\nfrom factory.fuzzy import BaseFuzzyAttribute\\nfrom django.contrib.gis.geos import Point\\nimport factory.django, random\\nfrom django.utils import timezone\\nfrom django.test import RequestFactory\\nfrom django.core.urlresolvers import reverse\\nfrom gigs.views import LookupView\\n\\nclass FuzzyPoint(BaseFuzzyAttribute):\\n    def fuzz(self):\\n        return Point(random.uniform(-180.0, 180.0),\\n                     random.uniform(-90.0, 90.0))\\n\\n#\\xA0Factories for tests\\nclass VenueFactory(factory.django.DjangoModelFactory):\\n    class Meta:\\n        model = Venue\\n        django_get_or_create = (\\n            'name',\\n            'location'\\n        )\\n\\n    name = 'Wembley Arena'\\n    location = FuzzyPoint()\\n\\nclass EventFactory(factory.django.DjangoModelFactory):\\n    class Meta:\\n        model = Event\\n        django_get_or_create = (\\n            'name',\\n            'venue',\\n            'datetime'\\n        )\\n\\n    name = 'Queens of the Stone Age'\\n    datetime = timezone.now()\\n\\nclass VenueTest(TestCase):\\n    def test_create_venue(self):\\n        # Create the venue\\n        venue = VenueFactory()\\n\\n        #\\xA0Check we can find it\\n        all_venues = Venue.objects.all()\\n        self.assertEqual(len(all_venues), 1)\\n        only_venue = all_venues[0]\\n        self.assertEqual(only_venue, venue)\\n\\n        #\\xA0Check attributes\\n        self.assertEqual(only_venue.name, 'Wembley Arena')\\n\\n        #\\xA0Check string representation\\n        self.assertEqual(only_venue.__str__(), 'Wembley Arena')\\n\\n\\nclass EventTest(TestCase):\\n    def test_create_event(self):\\n        # Create the venue\\n        venue = VenueFactory()\\n\\n        #\\xA0Create the event\\n        event = EventFactory(venue=venue)\\n\\n        #\\xA0Check we can find it\\n        all_events = Event.objects.all()\\n        self.assertEqual(len(all_events), 1)\\n        only_event = all_events[0]\\n        self.assertEqual(only_event, event)\\n\\n        #\\xA0Check attributes\\n        self.assertEqual(only_event.name, 'Queens of the Stone Age')\\n        self.assertEqual(only_event.venue.name, 'Wembley Arena')\\n\\n        #\\xA0Check string representation\\n        self.assertEqual(only_event.__str__(), 'Queens of the Stone Age - Wembley Arena')\\n\\n\\nclass LookupViewTest(TestCase):\\n    \\\"\\\"\\\"\\n    Test lookup view\\n    \\\"\\\"\\\"\\n    def setUp(self):\\n        self.factory = RequestFactory()\\n\\n    def test_get(self):\\n        request = self.factory.get(reverse('lookup'))\\n        response = LookupView.as_view()(request)\\n        self.assertEqual(response.status_code, 200)\\n        self.assertTemplateUsed('gigs/lookup.html')\\n\")), mdx(\"p\", null, \"Let's run our tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\nE\\n======================================================================\\nERROR: gigs.tests (unittest.loader._FailedTest)\\n----------------------------------------------------------------------\\nImportError: Failed to import test module: gigs.tests\\nTraceback (most recent call last):\\n  File \\\"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py\\\", line 428, in _find_test_path\\n    module = self._get_module_from_name(name)\\n  File \\\"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py\\\", line 369, in _get_module_from_name\\n    __import__(name)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py\\\", line 9, in <module>\\n    from gigs.views import LookupView\\nImportError: cannot import name 'LookupView'\\n\\n\\n----------------------------------------------------------------------\\nRan 1 test in 0.000s\\n\\nFAILED (errors=1)\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"Our first issue is that we can't import the view in the test. Let's fix that by amending \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/views.py\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.shortcuts import render\\nfrom django.views.generic.base import View\\n\\nclass LookupView(View):\\n    pass\\n\")), mdx(\"p\", null, \"Running the tests again results in the following:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\n.E.\\n======================================================================\\nERROR: test_get (gigs.tests.LookupViewTest)\\n----------------------------------------------------------------------\\nTraceback (most recent call last):\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py\\\", line 88, in test_get\\n    request = self.factory.get(reverse('lookup'))\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/urlresolvers.py\\\", line 600, in reverse\\n    return force_text(iri_to_uri(resolver._reverse_with_prefix(view, prefix, *args, **kwargs)))\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/urlresolvers.py\\\", line 508, in _reverse_with_prefix\\n    (lookup_view_s, args, kwargs, len(patterns), patterns))\\ndjango.core.urlresolvers.NoReverseMatch: Reverse for 'lookup' with arguments '()' and keyword arguments '{}' not found. 0 pattern(s) tried: []\\n\\n----------------------------------------------------------------------\\nRan 3 tests in 0.154s\\n\\nFAILED (errors=1)\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"We can't resolve the URL for our new view, so we need to add it to our URLconf. First of all, save this as \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/urls.py\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.conf.urls import url\\nfrom gigs.views import LookupView\\n\\nurlpatterns = [\\n    # Lookup\\n    url(r'', LookupView.as_view(), name='lookup'),\\n]\\n\")), mdx(\"p\", null, \"Then amend \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigfinder/urls.py\"), \" as follows:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.conf.urls import url, include\\nfrom django.contrib import admin\\n\\nurlpatterns = [\\n    url(r'^admin/', admin.site.urls),\\n\\n    #\\xA0Gig URLs\\n    url(r'', include('gigs.urls')),\\n]\\n\")), mdx(\"p\", null, \"Then run the tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\n.F.\\n======================================================================\\nFAIL: test_get (gigs.tests.LookupViewTest)\\n----------------------------------------------------------------------\\nTraceback (most recent call last):\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py\\\", line 90, in test_get\\n    self.assertEqual(response.status_code, 200)\\nAssertionError: 405 != 200\\n\\n----------------------------------------------------------------------\\nRan 3 tests in 0.417s\\n\\nFAILED (failures=1)\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"We get a 405 response because the view does not accept GET requests. Let's resolve that:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.shortcuts import render_to_response\\nfrom django.views.generic.base import View\\n\\nclass LookupView(View):\\n    def get(self, request):\\n        return render_to_response('gigs/lookup.html')\\n\")), mdx(\"p\", null, \"If we run our tests now:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\n.E.\\n======================================================================\\nERROR: test_get (gigs.tests.LookupViewTest)\\n----------------------------------------------------------------------\\nTraceback (most recent call last):\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py\\\", line 89, in test_get\\n    response = LookupView.as_view()(request)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py\\\", line 68, in view\\n    return self.dispatch(request, *args, **kwargs)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py\\\", line 88, in dispatch\\n    return handler(request, *args, **kwargs)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/views.py\\\", line 6, in get\\n    return render_to_response('gigs/lookup.html')\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/shortcuts.py\\\", line 39, in render_to_response\\n    content = loader.render_to_string(template_name, context, using=using)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py\\\", line 96, in render_to_string\\n    template = get_template(template_name, using=using)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py\\\", line 43, in get_template\\n    raise TemplateDoesNotExist(template_name, chain=chain)\\ndjango.template.exceptions.TemplateDoesNotExist: gigs/lookup.html\\n\\n----------------------------------------------------------------------\\nRan 3 tests in 0.409s\\n\\nFAILED (errors=1)\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"We see that the template is not defined. Save the following as \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/templates/gigs/includes/base.html\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-django\"\n  }, \"<!DOCTYPE html>\\n<html>\\n    <head>\\n        <title>Gig finder</title>\\n        <meta charset=\\\"utf-8\\\">\\n        <meta http-equiv=\\\"X-UA-Compatible\\\" content=\\\"IE=edge\\\">\\n        <meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1\\\">\\n        <link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css\\\"></link>\\n    </head>\\n    <body>\\n        <h1>Gig Finder</h1>\\n        <div class=\\\"container\\\">\\n            <div class=\\\"row\\\">\\n                {% block content %}{% endblock %}\\n            </div>\\n        </div>\\n        <script src=\\\"https://code.jquery.com/jquery-2.2.2.min.js\\\" integrity=\\\"sha256-36cp2Co+/62rEAAYHLmRCPIych47CvdM+uTBJwSzWjI=\\\" crossorigin=\\\"anonymous\\\"></script>\\n        <script language=\\\"javascript\\\" type=\\\"text/javascript\\\" src=\\\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js\\\"></script>\\n    </body>\\n</html>\\n\")), mdx(\"p\", null, \"And the following as \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/templates/gigs/lookup.html\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-django\"\n  }, \"{% extends \\\"gigs/includes/base.html\\\" %}\\n\\n{% block content %}\\n    <form role=\\\"form\\\" action=\\\"/\\\" method=\\\"post\\\">{% csrf_token %}\\n        <div class=\\\"form-group\\\">\\n            <label for=\\\"latitude\\\">Latitude:</label>\\n            <input id=\\\"id_latitude\\\" name=\\\"latitude\\\" type=\\\"text\\\" class=\\\"form-control\\\"></input>\\n        </div>\\n        <div class=\\\"form-group\\\">\\n            <label for=\\\"longitude\\\">Longitude:</label>\\n            <input id=\\\"id_longitude\\\" name=\\\"longitude\\\" type=\\\"text\\\" class=\\\"form-control\\\"></input>\\n        </div>\\n        <input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" value=\\\"Submit\\\" />\\n    </form>\\n    <script language=\\\"javascript\\\" type=\\\"text/javascript\\\">\\n        navigator.geolocation.getCurrentPosition(function (position) {\\n            var lat = document.getElementById('id_latitude');\\n            var lon = document.getElementById('id_longitude');\\n            lat.value = position.coords.latitude;\\n            lon.value = position.coords.longitude;\\n        });\\n    </script>\\n{% endblock %}\\n\")), mdx(\"p\", null, \"Note the JavaScript to populate the latitude and longitude. Now, if we run our tests:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\n...\\n----------------------------------------------------------------------\\nRan 3 tests in 1.814s\\n\\nOK\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"Success! We now render our form as expected. Time to commit:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ git add gigs gigfinder\\n$ git commit -m 'Implemented GET handler'\\n\")), mdx(\"h2\", null, \"Handling POST requests\"), mdx(\"p\", null, \"Now we need to be able to handle POST requests and return the appropriate results. First, let's write a test for it in our existing \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"LookupViewTest\"), \" class:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"    def test_post(self):\\n        #\\xA0Create venues to return\\n        v1 = VenueFactory(name='Venue1')\\n        v2 = VenueFactory(name='Venue2')\\n        v3 = VenueFactory(name='Venue3')\\n        v4 = VenueFactory(name='Venue4')\\n        v5 = VenueFactory(name='Venue5')\\n        v6 = VenueFactory(name='Venue6')\\n        v7 = VenueFactory(name='Venue7')\\n        v8 = VenueFactory(name='Venue8')\\n        v9 = VenueFactory(name='Venue9')\\n        v10 = VenueFactory(name='Venue10')\\n\\n        #\\xA0Create events to return\\n        e1 = EventFactory(name='Event1', venue=v1)\\n        e2 = EventFactory(name='Event2', venue=v2)\\n        e3 = EventFactory(name='Event3', venue=v3)\\n        e4 = EventFactory(name='Event4', venue=v4)\\n        e5 = EventFactory(name='Event5', venue=v5)\\n        e6 = EventFactory(name='Event6', venue=v6)\\n        e7 = EventFactory(name='Event7', venue=v7)\\n        e8 = EventFactory(name='Event8', venue=v8)\\n        e9 = EventFactory(name='Event9', venue=v9)\\n        e10 = EventFactory(name='Event10', venue=v10)\\n\\n        # Set parameters\\n        lat = 52.3749159\\n        lon = 1.1067473\\n\\n        #\\xA0Put together request\\n        data = {\\n            'latitude': lat,\\n            'longitude': lon\\n        }\\n        request = self.factory.post(reverse('lookup'), data)\\n        response = LookupView.as_view()(request)\\n        self.assertEqual(response.status_code, 200)\\n        self.assertTemplateUsed('gigs/lookupresults.html')\\n\")), mdx(\"p\", null, \"If we now run this test:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\n..F.\\n======================================================================\\nFAIL: test_post (gigs.tests.LookupViewTest)\\n----------------------------------------------------------------------\\nTraceback (most recent call last):\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py\\\", line 117, in test_post\\n    self.assertEqual(response.status_code, 200)\\nAssertionError: 405 != 200\\n\\n----------------------------------------------------------------------\\nRan 4 tests in 1.281s\\n\\nFAILED (failures=1)\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"We can see that it fails because the POST method is not supported. Now we can start work on implementing it. First, let's create a form in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/forms.py\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.forms import Form, FloatField\\n\\nclass LookupForm(Form):\\n    latitude = FloatField()\\n    longitude = FloatField()\\n\")), mdx(\"p\", null, \"Next, edit \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/views.py\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.shortcuts import render_to_response\\nfrom django.views.generic.edit import FormView\\nfrom gigs.forms import LookupForm\\nfrom gigs.models import Event\\nfrom django.utils import timezone\\nfrom django.contrib.gis.geos import Point\\nfrom django.contrib.gis.db.models.functions import Distance\\n\\nclass LookupView(FormView):\\n    form_class = LookupForm\\n\\n    def get(self, request):\\n        return render_to_response('gigs/lookup.html')\\n\\n    def form_valid(self, form):\\n        # Get data\\n        latitude = form.cleaned_data['latitude']\\n        longitude = form.cleaned_data['longitude']\\n\\n        #\\xA0Get today's date\\n        now = timezone.now()\\n\\n        #\\xA0Get next week's date\\n        next_week = now + timezone.timedelta(weeks=1)\\n\\n        #\\xA0Get Point\\n        location = Point(longitude, latitude, srid=4326)\\n\\n        #\\xA0Look up events\\n        events = Event.objects.filter(datetime__gte=now).filter(datetime__lte=next_week).annotate(distance=Distance('venue__location', location)).order_by('distance')[0:5]\\n\\n        # Render the template\\n        return render_to_response('gigs/lookupresults.html', {\\n            'events': events\\n            })\\n\")), mdx(\"p\", null, \"Note that we're switching from a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"View\"), \" to a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"FormView\"), \" so that it can more easily handle our form. We could render the form using this as well, but as it's a simple form I decided it wasn't worth the bother. Also, note that the longitude goes first - this caught me out as I expected the latitude to be the first argument.\"), mdx(\"p\", null, \"Now, if we run our tests, they should complain about our missing template:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\n..E.\\n======================================================================\\nERROR: test_post (gigs.tests.LookupViewTest)\\n----------------------------------------------------------------------\\nTraceback (most recent call last):\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py\\\", line 116, in test_post\\n    response = LookupView.as_view()(request)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py\\\", line 68, in view\\n    return self.dispatch(request, *args, **kwargs)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py\\\", line 88, in dispatch\\n    return handler(request, *args, **kwargs)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/edit.py\\\", line 222, in post\\n    return self.form_valid(form)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/gigs/views.py\\\", line 31, in form_valid\\n    'events': events\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/shortcuts.py\\\", line 39, in render_to_response\\n    content = loader.render_to_string(template_name, context, using=using)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py\\\", line 96, in render_to_string\\n    template = get_template(template_name, using=using)\\n  File \\\"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py\\\", line 43, in get_template\\n    raise TemplateDoesNotExist(template_name, chain=chain)\\ndjango.template.exceptions.TemplateDoesNotExist: gigs/lookupresults.html\\n\\n----------------------------------------------------------------------\\nRan 4 tests in 0.506s\\n\\nFAILED (errors=1)\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"So let's create \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gigs/templates/gigs/lookupresults.html\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-django\"\n  }, \"{% extends \\\"gigs/includes/base.html\\\" %}\\n\\n{% block content %}\\n    <ul>\\n    {% for event in events %}\\n    <li>{{ event.name }} - {{ event.venue.name }}</li>\\n    {% endfor %}\\n    </ul>\\n{% endblock %}\\n\")), mdx(\"p\", null, \"Now, if we run our tests, they should pass:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ python manage.py test gigs\\nCreating test database for alias 'default'...\\n....\\n----------------------------------------------------------------------\\nRan 4 tests in 0.728s\\n\\nOK\\nDestroying test database for alias 'default'...\\n\")), mdx(\"p\", null, \"However, if we try actually submitting the form by hand, we get the error \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CSRF token missing or incorrect\"), \". Edit \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"views.py\"), \" as follows to resolve this:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"from django.shortcuts import render_to_response\\nfrom django.views.generic.edit import FormView\\nfrom gigs.forms import LookupForm\\nfrom gigs.models import Event\\nfrom django.utils import timezone\\nfrom django.contrib.gis.geos import Point\\nfrom django.contrib.gis.db.models.functions import Distance\\nfrom django.template import RequestContext\\n\\nclass LookupView(FormView):\\n    form_class = LookupForm\\n\\n    def get(self, request):\\n        return render_to_response('gigs/lookup.html', RequestContext(request))\\n\\n    def form_valid(self, form):\\n        # Get data\\n        latitude = form.cleaned_data['latitude']\\n        longitude = form.cleaned_data['longitude']\\n\\n        #\\xA0Get today's date\\n        now = timezone.now()\\n\\n        #\\xA0Get next week's date\\n        next_week = now + timezone.timedelta(weeks=1)\\n\\n        #\\xA0Get Point\\n        location = Point(longitude, latitude, srid=4326)\\n\\n        #\\xA0Look up events\\n        events = Event.objects.filter(datetime__gte=now).filter(datetime__lte=next_week).annotate(distance=Distance('venue__location', location)).order_by('distance')[0:5]\\n\\n        # Render the template\\n        return render_to_response('gigs/lookupresults.html', {\\n            'events': events\\n            })\\n\")), mdx(\"p\", null, \"Here we're adding the request context so that the CSRF token is available.\"), mdx(\"p\", null, \"If you run the dev server, add a few events and venues via the admin, and submit a search, you'll see that you're returning events closest to you first.\"), mdx(\"p\", null, \"Now that we can submit searches, we're ready to commit:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ git add gigs/\\n$ git commit -m 'Can now retrieve search results'\\n\")), mdx(\"p\", null, \"And we're done! Of course, you may want to expand on this by plotting each gig venue on a map, or something like that, in which case there's plenty of methods of doing so - you can retrieve the latitude and longitude in the template and use Google Maps to display them. I'll leave doing so as an exercise for the reader.\"), mdx(\"p\", null, \"I can't say that working with GeoDjango isn't a bit of a struggle at times, but being able to make spatial queries in this fashion is very useful. With more and more people carrying smartphones, you're more likely than ever to be asked to build applications that return data based on someone's geographical location, and GeoDjango is a great way to do this with a Django application. You can find the source on \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/matthewbdaly/gigfinder\"\n  }, \"Github\"), \".\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"PostgreSQL has excellent support for geographical data thanks to the PostGIS extension, and Django allows you to take full advantage of it thanks to GeoDjango. In this tutorial, I…","frontmatter":{"title":"Building a location aware web app with GeoDjango","date":"26th March 2016 9:30 pm","isoDate":"2016-03-26T21:30:29+00:00","categories":["python","django","tdd","postgres","geo","geodjango"]},"fields":{"path":"/blog/2016/03/26/building-a-location-aware-web-app-with-geodjango/"}}},"pageContext":{"previous":{"fields":{"path":"/blog/2016/03/18/my-experience-using-php-7-in-production/"},"frontmatter":{"title":"My experience using PHP 7 in production","date":"2016-03-18 19:42:37 +0000","layout":"post"}},"next":{"fields":{"path":"/blog/2016/04/04/writing-faster-laravel-tests/"},"frontmatter":{"title":"Writing faster Laravel tests","date":"2016-04-04 20:55:15 +0100","layout":"post"}}}},"staticQueryHashes":["1776624730","3528622268"]}