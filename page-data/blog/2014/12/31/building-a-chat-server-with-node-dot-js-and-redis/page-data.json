{"componentChunkName":"component---src-templates-post-tsx","path":"/blog/2014/12/31/building-a-chat-server-with-node-dot-js-and-redis/","result":{"data":{"site":{"siteMetadata":{"title":"Matthew Daly","siteUrl":"https://matthewdaly.co.uk"}},"mdx":{"id":"97e9df06-1a21-5131-b1cf-e3f6f17ca11d","body":"var _excluded = [\"components\"];\nfunction _extends() { return _extends = Object.assign ? Object.assign.bind() : function (n) { for (var e = 1; e < arguments.length; e++) { var t = arguments[e]; for (var r in t) ({}).hasOwnProperty.call(t, r) && (n[r] = t[r]); } return n; }, _extends.apply(null, arguments); }\nfunction _objectWithoutProperties(e, t) { if (null == e) return {}; var o, r, i = _objectWithoutPropertiesLoose(e, t); if (Object.getOwnPropertySymbols) { var n = Object.getOwnPropertySymbols(e); for (r = 0; r < n.length; r++) o = n[r], t.indexOf(o) >= 0 || {}.propertyIsEnumerable.call(e, o) && (i[o] = e[o]); } return i; }\nfunction _objectWithoutPropertiesLoose(r, e) { if (null == r) return {}; var t = {}; for (var n in r) if ({}.hasOwnProperty.call(r, n)) { if (e.indexOf(n) >= 0) continue; t[n] = r[n]; } return t; }\n/* @jsxRuntime classic */\n/* @jsx mdx */\n\nvar _frontmatter = {\n  \"layout\": \"post\",\n  \"title\": \"Building a chat server with Node.js and Redis\",\n  \"date\": \"2014-12-31 14:10:57 +0000\",\n  \"comments\": true,\n  \"categories\": [\"node.js\", \"redis\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n    props = _objectWithoutProperties(_ref, _excluded);\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"One of the more interesting capabilities Redis offers is its support for Pub/Sub. This allows you to subscribe to a specific channel, and then react when some content is published to that channel. In this tutorial, we'll build a very simple web-based chat system that demonstrates Redis's Pub/Sub support in action. Chat systems are pretty much synonymous with Node.js - it's widely considered the \\\"Hello, World!\\\" of Node.js. Since we already used Node with the prior Redis tutorial, then it also makes sense to stick with it for this project too.\"), mdx(\"h2\", null, \"Installing Node.js\"), mdx(\"p\", null, \"Since the last tutorial, I've discovered \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/creationix/nvm\"\n  }, \"NVM\"), \", and if you're using any flavour of Unix, I highly recommend using it. It's not an option if you're using Windows, however Redis doesn't officially support Windows anyway, so if you want to follow along on a Windows machine I'd recommend using a VM.\"), mdx(\"p\", null, \"If you followed the URL shortener tutorial, you should already have everything you need, though I'd still recommend switching to NVM as it's very convenient. We'll be using Grunt again, so you'll need to make sure you have \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"grunt-cli\"), \" installed with the following command:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ npm install -g grunt-cli\\n\")), mdx(\"p\", null, \"This assumes you used NVM to install Node - if it's installed globally, you may need to use \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"sudo\"), \".\"), mdx(\"h2\", null, \"Installing dependencies\"), mdx(\"p\", null, \"As usual with a Node.js project, our first step is to create our \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"package.json\"), \" file:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ npm init\\n\")), mdx(\"p\", null, \"Answer the questions so you end up with something like this (or just paste this into \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"package.json\"), \" and amend it as you see fit):\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-json\"\n  }, \"{\\n  \\\"name\\\": \\\"babblr\\\",\\n  \\\"version\\\": \\\"1.0.0\\\",\\n  \\\"description\\\": \\\"Chat client\\\",\\n  \\\"main\\\": \\\"index.js\\\",\\n  \\\"scripts\\\": {\\n    \\\"test\\\": \\\"grunt test --verbose\\\"\\n  },\\n  \\\"keywords\\\": [\\n    \\\"chat\\\"\\n  ],\\n  \\\"author\\\": \\\"Matthew Daly <matthew@matthewdaly.co.uk> (http://matthewdaly.co.uk/)\\\",\\n  \\\"license\\\": \\\"GPLv2\\\"\\n}\\n\")), mdx(\"p\", null, \"Now let's install our dependencies:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ npm install express hbs redis hiredis socket.io socket.io-client --save\\n$ npm install chai grunt grunt-contrib-jshint grunt-coveralls grunt-mocha-istanbul istanbul mocha request --save-dev\\n\")), mdx(\"p\", null, \"These two commands will install our dependencies.\"), mdx(\"p\", null, \"Now, if you followed on with the URL shortener tutorial, you'll notice that we aren't using Jade - instead we're going to use Handlebars. Jade is quite a nice templating system, but I find it gets in the way for larger projects - you spend too much time looking up the syntax for things you already know in HTML. Handlebars is closer to HTML so we will use that. We'll also use Socket.IO extensively on this project.\"), mdx(\"h2\", null, \"Support files\"), mdx(\"p\", null, \"As before, we'll also use Mocha for our unit tests and Istanbul to generate coverage stats. We'll need a Grunt configuration for that, so here it is:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"module.exports = function (grunt) {\\n    'use strict';\\n\\n    grunt.initConfig({\\n        jshint: {\\n            all: [\\n                'test/*.js',\\n                'index.js'\\n            ]\\n        },\\n        mocha_istanbul: {\\n            coverage: {\\n                src: 'test', // the folder, not the files,\\n                options: {\\n                    mask: '*.js',\\n                    reportFormats: ['cobertura', 'html', 'lcovonly']\\n                }\\n            }\\n        },\\n        coveralls: {\\n            options: {\\n                src: 'coverage/lcov.info',\\n                force: false\\n            },\\n            app: {\\n                src: 'coverage/lcov.info'\\n            }\\n        }\\n    });\\n\\n    // Load tasks\\n    grunt.loadNpmTasks('grunt-contrib-jshint');\\n    grunt.loadNpmTasks('grunt-coveralls');\\n    grunt.loadNpmTasks('grunt-mocha-istanbul');\\n\\n    // Register tasks\\n    grunt.registerTask('test', ['jshint', 'mocha_istanbul:coverage', 'coveralls']);\\n};\\n\")), mdx(\"p\", null, \"We also need a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \".bowerrc\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-json\"\n  }, \"{\\n    \\\"directory\\\": \\\"static/bower_components\\\"\\n}\\n\")), mdx(\"p\", null, \"And a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"bower.json\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-json\"\n  }, \"{\\n  \\\"name\\\": \\\"babblr\\\",\\n  \\\"main\\\": \\\"index.js\\\",\\n  \\\"version\\\": \\\"1.0.0\\\",\\n  \\\"authors\\\": [\\n    \\\"Matthew Daly <matthewbdaly@gmail.com>\\\"\\n  ],\\n  \\\"description\\\": \\\"A simple chat server\\\",\\n  \\\"moduleType\\\": [\\n    \\\"node\\\"\\n  ],\\n  \\\"keywords\\\": [\\n    \\\"chat\\\"\\n  ],\\n  \\\"license\\\": \\\"GPLv2\\\",\\n  \\\"homepage\\\": \\\"http://matthewdaly.co.uk\\\",\\n  \\\"private\\\": true,\\n  \\\"ignore\\\": [\\n    \\\"**/.*\\\",\\n    \\\"node_modules\\\",\\n    \\\"bower_components\\\",\\n    \\\"test\\\",\\n    \\\"tests\\\"\\n  ],\\n  \\\"dependencies\\\": {\\n    \\\"html5-boilerplate\\\": \\\"~4.3.0\\\",\\n    \\\"jquery\\\": \\\"~2.1.1\\\",\\n    \\\"bootstrap\\\": \\\"~3.3.1\\\"\\n  }\\n}\\n\")), mdx(\"p\", null, \"Then install the Bower dependencies:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ bower install\\n\")), mdx(\"p\", null, \"We also need a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Procfile\"), \" so we can run it on Heroku:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"web: node index.js\\n\")), mdx(\"p\", null, \"Now, let's create the main file:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ touch index.js\\n\")), mdx(\"p\", null, \"And our test file:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ mkdir test\\n$ touch test/test.js\\n\")), mdx(\"h2\", null, \"Implementing the chat server\"), mdx(\"p\", null, \"Next, let's implement our first test. First of all, we'll verify that the index route works:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"/*jslint node: true */\\n/*global describe: false, before: false, after: false, it: false */\\n\\\"use strict\\\";\\n\\n// Declare the variables used\\nvar expect = require('chai').expect,\\n    request = require('request'),\\n    server = require('../index'),\\n    redis = require('redis'),\\n    io = require('socket.io-client'),\\n    client;\\nclient = redis.createClient();\\n\\n// Server tasks\\ndescribe('server', function () {\\n\\n    // Beforehand, start the server\\n    before(function (done) {\\n        console.log('Starting the server');\\n        done();\\n    });\\n\\n    // Afterwards, stop the server and empty the database\\n    after(function (done) {\\n        console.log('Stopping the server');\\n        client.flushdb();\\n        done();\\n    });\\n\\n    // Test the index route\\n    describe('Test the index route', function () {\\n        it('should return a page with the title Babblr', function (done) {\\n            request.get({ url: 'http://localhost:5000/' }, function (error, response, body) {\\n                expect(body).to.include('Babblr');\\n                expect(response.statusCode).to.equal(200);\\n                expect(response.headers['content-type']).to.equal('text/html; charset=utf-8');\\n                done();\\n            });\\n        });\\n    });\\n});\\n\")), mdx(\"p\", null, \"Note that this is very similar to the first test for the URL shortener, because it's doing basically the same thing.\"), mdx(\"p\", null, \"Now, run the test and make sure it fails:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ grunt test\\nRunning \\\"jshint:all\\\" (jshint) task\\n>> 2 files lint free.\\n\\nRunning \\\"mocha_istanbul:coverage\\\" (mocha_istanbul) task\\n\\n\\n  server\\nStarting the server\\n    Test the index route\\n      1) should return a page with the title Babblr\\nStopping the server\\n\\n\\n  0 passing (873ms)\\n  1 failing\\n\\n  1) server Test the index route should return a page with the title Babblr:\\n     Uncaught AssertionError: expected undefined to include 'Babblr'\\n      at Request._callback (/Users/matthewdaly/Projects/babblr/test/test.js:34:33)\\n      at self.callback (/Users/matthewdaly/Projects/babblr/node_modules/request/request.js:373:22)\\n      at Request.emit (events.js:95:17)\\n      at Request.onRequestError (/Users/matthewdaly/Projects/babblr/node_modules/request/request.js:971:8)\\n      at ClientRequest.emit (events.js:95:17)\\n      at Socket.socketErrorListener (http.js:1552:9)\\n      at Socket.emit (events.js:95:17)\\n      at net.js:441:14\\n      at process._tickCallback (node.js:442:13)\\n\\n\\n\\n=============================================================================\\nWriting coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]\\nWriting coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]\\n=============================================================================\\n\\n=============================== Coverage summary ===============================\\nStatements   : 100% ( 0/0 )\\nBranches     : 100% ( 0/0 )\\nFunctions    : 100% ( 0/0 )\\nLines        : 100% ( 0/0 )\\n================================================================================\\n>>\\nWarning: Task \\\"mocha_istanbul:coverage\\\" failed. Use --force to continue.\\n\\nAborted due to warnings.\\n\")), mdx(\"p\", null, \"With that confirmed, we can start writing code to make the test pass:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"/*jslint node: true */\\n'use strict';\\n\\n// Declare variables used\\nvar app, base_url, client, express, hbs, io, port, rtg, subscribe;\\n\\n// Define values\\nexpress = require('express');\\napp = express();\\nport = process.env.PORT || 5000;\\nbase_url = process.env.BASE_URL || 'http://localhost:5000';\\nhbs = require('hbs');\\n\\n// Set up connection to Redis\\n/* istanbul ignore if */\\nif (process.env.REDISTOGO_URL) {\\n    rtg  = require(\\\"url\\\").parse(process.env.REDISTOGO_URL);\\n    client = require(\\\"redis\\\").createClient(rtg.port, rtg.hostname);\\n    subscribe = require(\\\"redis\\\").createClient(rtg.port, rtg.hostname);\\n    client.auth(rtg.auth.split(\\\":\\\")[1]);\\n    subscribe.auth(rtg.auth.split(\\\":\\\")[1]);\\n} else {\\n    client = require('redis').createClient();\\n    subscribe = require('redis').createClient();\\n}\\n\\n// Set up templating\\napp.set('views', __dirname + '/views');\\napp.set('view engine', \\\"hbs\\\");\\napp.engine('hbs', require('hbs').__express);\\n\\n// Register partials\\nhbs.registerPartials(__dirname + '/views/partials');\\n\\n// Set URL\\napp.set('base_url', base_url);\\n\\n// Define index route\\napp.get('/', function (req, res) {\\n    res.render('index');\\n});\\n\\n// Serve static files\\napp.use(express.static(__dirname + '/static'));\\n\\n// Listen\\nio = require('socket.io')({\\n}).listen(app.listen(port));\\nconsole.log(\\\"Listening on port \\\" + port);\\n\")), mdx(\"p\", null, \"If you compare this to the code for the URL shortener, you'll notice a few fairly substantial differences. For one thing, we set up two Redis connections, not one - that's because we need to do so when using Pub/Sub with Redis. You'll also notice that we register Handlebars (\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"hbs\"), \") rather than Jade, and define not just a directory for views, but another directory inside it for partials. Finally, setting it up to listen at the end is a bit more involved because we'll be using Socket.IO.\"), mdx(\"p\", null, \"Now, you can run your tests again at this point, but they won't pass because we haven't created our views. So let's do that. Create the directory \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"views\"), \" and the subdirectory \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"partials\"), \" inside it. Then add the following content to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"views/index.hbs\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-handlebars\"\n  }, \"{{> header }}\\n        <div class=\\\"container\\\">\\n            <div class=\\\"row\\\">\\n                <div class=\\\"col-md-8\\\">\\n                    <div class=\\\"conversation\\\">\\n                    </div>\\n                </div>\\n                <div class=\\\"col-md-4\\\">\\n                    <form>\\n                        <div class=\\\"form-group\\\">\\n                            <label for=\\\"message\\\">Message</label>\\n                            <textarea class=\\\"form-control\\\" id=\\\"message\\\" rows=\\\"20\\\"></textarea>\\n                            <a id=\\\"submitbutton\\\" class=\\\"btn btn-primary form-control\\\">Submit</a>\\n                        <div>\\n                    </form>\\n                </div>\\n            </div>\\n        </div>\\n{{> footer }}\\n\")), mdx(\"p\", null, \"Add this to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"views/partials/header.hbs\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-handlebars\"\n  }, \"<!DOCTYPE html>\\n<!--[if lt IE 7]>      <html class=\\\"no-js lt-ie9 lt-ie8 lt-ie7\\\"> <![endif]-->\\n<!--[if IE 7]>         <html class=\\\"no-js lt-ie9 lt-ie8\\\"> <![endif]-->\\n<!--[if IE 8]>         <html class=\\\"no-js lt-ie9\\\"> <![endif]-->\\n<!--[if gt IE 8]><!--> <html class=\\\"no-js\\\"> <!--<![endif]-->\\n    <head>\\n        <meta charset=\\\"utf-8\\\">\\n        <meta http-equiv=\\\"X-UA-Compatible\\\" content=\\\"IE=edge\\\">\\n        <title>Babblr</title>\\n        <meta name=\\\"description\\\" content=\\\"\\\">\\n        <meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1\\\">\\n\\n        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->\\n\\n        <link rel=\\\"stylesheet\\\" href=\\\"/bower_components/bootstrap/dist/css/bootstrap.min.css\\\">\\n        <link rel=\\\"stylesheet\\\" href=\\\"/bower_components/bootstrap/dist/css/bootstrap-theme.min.css\\\">\\n        <link rel=\\\"stylesheet\\\" href=\\\"/css/style.css\\\">\\n    </head>\\n    <body>\\n        <!--[if lt IE 7]>\\n            <p class=\\\"browsehappy\\\">You are using an <strong>outdated</strong> browser. Please <a href=\\\"http://browsehappy.com/\\\">upgrade your browser</a> to improve your experience.</p>\\n        <![endif]-->\\n        <nav class=\\\"navbar navbar-inverse navbar-static-top\\\" role=\\\"navigation\\\">\\n            <div class=\\\"container\\\">\\n                <div class=\\\"navbar-header\\\">\\n                    <a class=\\\"navbar-brand\\\" href=\\\"#\\\">Babblr</a>\\n                </div>\\n            </div>\\n        </nav>\\n\")), mdx(\"p\", null, \"And add this to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"views/partials/footer.hbs\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-handlebars\"\n  }, \"\\n        <script src=\\\"/bower_components/jquery/dist/jquery.min.js\\\"></script>\\n        <script src=\\\"/bower_components/bootstrap/dist/js/bootstrap.min.js\\\"></script>\\n        <script src=\\\"/socket.io/socket.io.js\\\"></script>\\n        <script src=\\\"/js/main.js\\\"></script>\\n\\n    </body>\\n</html>\\n\")), mdx(\"p\", null, \"You'll also want to create placeholder CSS and JavaScript files:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ mkdir static/js\\n$ mkdir static/css\\n$ touch static/js/main.js\\n$ touch static/css/style.css\\n\")), mdx(\"p\", null, \"The test should now pass:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ grunt test\\nRunning \\\"jshint:all\\\" (jshint) task\\n>> 2 files lint free.\\n\\nRunning \\\"mocha_istanbul:coverage\\\" (mocha_istanbul) task\\nListening on port 5000\\n\\n\\n  server\\nStarting the server\\n    Test the index route\\n      \\u2713 should return a page with the title Babblr (41ms)\\nStopping the server\\n\\n\\n  1 passing (54ms)\\n\\n=============================================================================\\nWriting coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]\\nWriting coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]\\n=============================================================================\\n\\n=============================== Coverage summary ===============================\\nStatements   : 100% ( 24/24 ), 5 ignored\\nBranches     : 100% ( 6/6 ), 1 ignored\\nFunctions    : 100% ( 1/1 )\\nLines        : 100% ( 24/24 )\\n================================================================================\\n>> Done. Check coverage folder.\\n\\nRunning \\\"coveralls:app\\\" (coveralls) task\\n>> Failed to submit 'coverage/lcov.info' to coveralls: Bad response: 422 {\\\"message\\\":\\\"Couldn't find a repository matching this job.\\\",\\\"error\\\":true}\\n>> Failed to submit coverage results to coveralls\\nWarning: Task \\\"coveralls:app\\\" failed. Use --force to continue.\\n\\nAborted due to warnings.\\n\")), mdx(\"p\", null, \"Don't worry about the coveralls task failing, as that only needs to pass when it runs on Travis CI.\"), mdx(\"p\", null, \"So we now have our main route in place. The next step is to actually implement the chat functionality. Add this code to the test file:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"\\n    // Test sending a message\\n    describe('Test sending a message', function () {\\n        it(\\\"should return 'Message received'\\\", function (done) {\\n            // Connect to server\\n            var socket = io.connect('http://localhost:5000', {\\n                'reconnection delay' : 0,\\n                'reopen delay' : 0,\\n                'force new connection' : true\\n            });\\n\\n            // Handle the message being received\\n            socket.on('message', function (data) {\\n                expect(data).to.include('Message received');\\n                socket.disconnect();\\n                done();\\n            });\\n\\n            // Send the message\\n            socket.emit('send', { message: 'Message received' });\\n        });\\n    });\\n\")), mdx(\"p\", null, \"This code should be fairly straightforward to understand. First, we connect to the server. Then, we set up a handler to verify the content of the message when it gets sent. Finally, we send the message. Let's run the tests to make sure we get the expected result:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ grunt test\\nRunning \\\"jshint:all\\\" (jshint) task\\n>> 2 files lint free.\\n\\nRunning \\\"mocha_istanbul:coverage\\\" (mocha_istanbul) task\\nListening on port 5000\\n\\n\\n  server\\nStarting the server\\n    Test the index route\\n      \\u2713 should return a page with the title Babblr (337ms)\\n    Test sending a message\\n      1) should return 'Message received'\\nStopping the server\\n\\n\\n  1 passing (2s)\\n  1 failing\\n\\n  1) server Test sending a message should return 'Message received':\\n     Error: timeout of 2000ms exceeded\\n      at null.<anonymous> (/Users/matthewdaly/Projects/babblr/node_modules/mocha/lib/runnable.js:159:19)\\n      at Timer.listOnTimeout [as ontimeout] (timers.js:112:15)\\n\\n\\n\\n=============================================================================\\nWriting coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]\\nWriting coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]\\n=============================================================================\\n\\n=============================== Coverage summary ===============================\\nStatements   : 100% ( 24/24 ), 5 ignored\\nBranches     : 100% ( 6/6 ), 1 ignored\\nFunctions    : 100% ( 1/1 )\\nLines        : 100% ( 24/24 )\\n================================================================================\\n>>\\nWarning: Task \\\"mocha_istanbul:coverage\\\" failed. Use --force to continue.\\n\\nAborted due to warnings.\\n\")), mdx(\"p\", null, \"Now, let's implement this functionality. Add this at the end of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"index.js\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"// Handle new messages\\nio.sockets.on('connection', function (socket) {\\n    // Subscribe to the Redis channel\\n    subscribe.subscribe('ChatChannel');\\n\\n    // Handle incoming messages\\n    socket.on('send', function (data) {\\n        // Publish it\\n        client.publish('ChatChannel', data.message);\\n    });\\n\\n    // Handle receiving messages\\n    var callback = function (channel, data) {\\n        socket.emit('message', data);\\n    };\\n    subscribe.on('message', callback);\\n\\n    // Handle disconnect\\n    socket.on('disconnect', function () {\\n        subscribe.removeListener('message', callback);\\n    });\\n});\\n\")), mdx(\"p\", null, \"We'll go through this. First, we create a callback for when a new connection is received. Inside the callback, we then subscribe to a Pub/Sub channel in Redis called \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ChatChannel\"), \".\"), mdx(\"p\", null, \"Then, we define another callback so that on a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"send\"), \" event from Socket.IO, we get the message and publish it to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ChatChannel\"), \". After that, we define another callback to handle receiving messages, and set it to run when a new message is published to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ChatChannel\"), \". Finally, we set up a callback to handle removing the listener when a user disconnects.\"), mdx(\"p\", null, \"Note the two different connections to Redis - \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"client\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"subscribe\"), \". As mentioned earlier, you need to use two connections to Redis when using Pub/Sub. This is because a client subscribed to one or more channels should not issue commands, so we use \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"subscribe\"), \" as a dedicated connection to handle subscriptions, and use \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"client\"), \" to publish new messages.\"), mdx(\"p\", null, \"We'll also need a bit of client-side JavaScript to handle sending and receiving messages. Amend \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"main.js\"), \" as follows:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"$(document).ready(function () {\\n    'use strict';\\n\\n    // Set up the connection\\n    var field, socket, output;\\n    socket = io.connect(window.location.href);\\n\\n    // Get a reference to the input\\n    field = $('textarea#message');\\n\\n    // Get a reference to the output\\n    output = $('div.conversation');\\n\\n    // Handle message submit\\n    $('a#submitbutton').on('click', function () {\\n        // Create the message\\n        var msg;\\n        msg = field.val();\\n        socket.emit('send', { message: msg });\\n        field.val('');\\n    });\\n\\n    // Handle incoming messages\\n    socket.on('message', function (data) {\\n        // Insert the message\\n        output.append('<p>Anonymous Coward : ' + data + '</p>');\\n    });\\n});\\n\")), mdx(\"p\", null, \"Here we have one callback that handles sending messages, and another that handles receiving messages. Note that every message will be preceded with Anonymous Coward - we won't implement user names at this point (though I plan it for a future instalment).\"), mdx(\"p\", null, \"We'll also add a little bit of additional styling:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-css\"\n  }, \"div.conversation {\\n    height: 500px;\\n    overflow-y: scroll;\\n    border: 1px solid #000;\\n    padding: 10px;\\n}\\n\")), mdx(\"p\", null, \"Now, if you run your tests, they should pass:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ grunt test\\nRunning \\\"jshint:all\\\" (jshint) task\\n>> 2 files lint free.\\n\\nRunning \\\"mocha_istanbul:coverage\\\" (mocha_istanbul) task\\nListening on port 5000\\n\\n\\n  server\\nStarting the server\\n    Test the index route\\n      \\u2713 should return a page with the title Babblr (40ms)\\n    Test sending a message\\n      \\u2713 should return 'Message received' (45ms)\\nStopping the server\\n\\n\\n  2 passing (101ms)\\n\\n=============================================================================\\nWriting coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]\\nWriting coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]\\n=============================================================================\\n\\n=============================== Coverage summary ===============================\\nStatements   : 100% ( 33/33 ), 5 ignored\\nBranches     : 100% ( 6/6 ), 1 ignored\\nFunctions    : 100% ( 5/5 )\\nLines        : 100% ( 33/33 )\\n================================================================================\\n>> Done. Check coverage folder.\\n\\nRunning \\\"coveralls:app\\\" (coveralls) task\\n>> Failed to submit 'coverage/lcov.info' to coveralls: Bad response: 422 {\\\"message\\\":\\\"Couldn't find a repository matching this job.\\\",\\\"error\\\":true}\\n>> Failed to submit coverage results to coveralls\\nWarning: Task \\\"coveralls:app\\\" failed. Use --force to continue.\\n\\nAborted due to warnings.\\n\")), mdx(\"p\", null, \"If you now run the following command:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ node index.js\\n\")), mdx(\"p\", null, \"Then visit \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http://localhost:5000\"), \", you should be able to create new messages. If you then open it up in a second tab, you can see messages added in one tab appear in another. Deploying to Heroku using Redis To Go will be straightforward, and you can then access it from multiple devices and see new chat messages appear in real time.\"), mdx(\"h2\", null, \"Wrapping up\"), mdx(\"p\", null, \"This illustrates just how straightforward it is to use Redis's Pub/Sub capability. The chat system is still quite limited, so in a future instalment we'll develop it further. You can get the source code from the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/matthewbdaly/babblr\"\n  }, \"Github repository\"), \" - just switch to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"lesson-1\"), \" tag.\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"One of the more interesting capabilities Redis offers is its support for Pub/Sub. This allows you to subscribe to a specific channel, and then react when some content is published…","frontmatter":{"title":"Building a chat server with Node.js and Redis","date":"31st December 2014 2:10 pm","isoDate":"2014-12-31T14:10:57+00:00","categories":["node.js","redis"]},"fields":{"path":"/blog/2014/12/31/building-a-chat-server-with-node-dot-js-and-redis/"}}},"pageContext":{"previous":{"fields":{"path":"/blog/2014/12/28/my-first-grunt-plugin/"},"frontmatter":{"title":"My first Grunt plugin","date":"2014-12-28 17:04:41 +0000","layout":"post"}},"next":{"fields":{"path":"/blog/2015/02/15/switching-to-my-own-static-site-generator/"},"frontmatter":{"title":"Switching to my own static site generator","date":"2015-02-15 18:11:22 +0000","layout":"post"}}}},"staticQueryHashes":["1776624730","3528622268"]}