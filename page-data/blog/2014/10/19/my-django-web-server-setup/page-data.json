{"componentChunkName":"component---src-templates-post-tsx","path":"/blog/2014/10/19/my-django-web-server-setup/","result":{"data":{"site":{"siteMetadata":{"title":"Matthew Daly","siteUrl":"https://matthewdaly.co.uk"}},"mdx":{"id":"3c92daf9-a804-56ee-8e56-43ad88e2d04b","body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"layout\": \"post\",\n  \"title\": \"My Django web server setup\",\n  \"date\": \"2014-10-19 19:52:28 +0100\",\n  \"comments\": true,\n  \"categories\": [\"python\", \"django\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"This isn't really part of my Django tutorial series (that has now definitely concluded!), but I thought I'd share the setup I generally use for deploying Django applications, partly for my own reference, and partly because it is quite complex, and those readers who don't wish to deploy to Heroku may want some guidance on how to deploy their new blogs to a VPS.\"), mdx(\"h2\", null, \"Operating system\"), mdx(\"p\", null, \"This isn't actually that much of a big deal, but while I prefer Ubuntu on desktops, I generally use Debian Stable on servers, since it's fanatically stable.\"), mdx(\"h2\", null, \"Database server\"), mdx(\"p\", null, \"For my first commercial Django app, I used MySQL. However, South had one or two issues with MySQL, and I figured that since using an ORM and migrations meant that I wouldn't need to write much SQL anyway, I might as well jump to PostgreSQL for the Django app I'm currently in the process of deploying at work. So far I haven't had any problems with it.\"), mdx(\"h2\", null, \"Web server\"), mdx(\"p\", null, \"It's customary to use two web servers with Django. One handles the static content, and reverse proxies everything else to a different port, where another web server serves the dynamic content.\"), mdx(\"p\", null, \"For serving the static files, I use Nginx - it's generally considered to be faster than Apache for this use case. Here's a typical Nginx config file:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-nginx\"\n  }, \"server {\\n    listen 80;\\n    server_name example.com;\\n    client_max_body_size 50M;\\n\\n    access_log /var/log/nginx/access.log;\\n    error_log /var/log/nginx/error.log;\\n\\n    location /static {\\n        root /var/www/mysite;\\n    }\\n\\n    location /media {\\n        root /var/www/mysite;\\n    }\\n\\n    location / {\\n        proxy_pass http://127.0.0.1:8000;\\n    }\\n}\\n\")), mdx(\"p\", null, \"For the application server, I use Gunicorn. You can install this with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"pip install gunicorn\"), \", then add it to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"INSTALLED_APPS\"), \". Then add the following config file to the root of your project, as \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gunicorn.conf.py\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-python\"\n  }, \"bind = \\\"127.0.0.1:8000\\\"\\nlogfile = \\\"/var/log/gunicorn.log\\\"\\nloglevel = \\\"debug\\\"\\nworkers = 3\\n\")), mdx(\"p\", null, \"You should normally set the number of workers to 2 times the number of cores on your machine, plus one.\"), mdx(\"p\", null, \"In order to keep Gunicorn running, I use Supervisor. As the installation commands will depend on your OS, I won't give details here - your package manager of choice should have a suitable package available. Here's a typical Supervisor config file I might use for running Gunicorn for a Django app, named \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"mysite-supervisor.conf\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-ini\"\n  }, \"[program:mysite]\\ncommand=/var/www/mysite/venv/bin/gunicorn myapp.wsgi:application --workers=3\\ndirectory=/var/www/mysite/\\nuser=nobody\\nautostart=true\\nautorestart=true\\n\")), mdx(\"p\", null, \"Once that's in place, you can easily add the new app:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ sudo supervisorctl reread\\n$ sudo supervisorctl update\\n\")), mdx(\"p\", null, \"Then to start it:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ sudo supervisorctl start mysite\\n\")), mdx(\"p\", null, \"Or stop it with:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ sudo supervisorctl stop mysite\\n\")), mdx(\"p\", null, \"Or restart it:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ sudo supervisorctl restart mysite\\n\")), mdx(\"h2\", null, \"Celery\"), mdx(\"p\", null, \"So far, both of the web apps I've built professionally have been ones where it made sense to use \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"http://www.celeryproject.org/\"\n  }, \"Celery\"), \" for some tasks. For the uninitiated, Celery lets you pass a task to a queue to be handled, rather than handling it within the context of the same HTTP request. This offers the following advantages:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The user doesn't need to wait for the task to be completed before getting a response, improving performance\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"It's more robust, since if the task fails, it can be automatically retried\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The task queue can be moved to another server if desired, making it easier to scale\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Scheduling tasks\")), mdx(\"p\", null, \"I've used it in cases where I needed to send an email or a push notification, since these don't have to be done within the context of the same HTTP request, but need to be reliable.\"), mdx(\"p\", null, \"I generally use RabbitMQ as my message queue. I'll leave setting this up as an exercise for the reader since it's covered pretty well in the Celery documentation, but like with Gunicorn, I use Supervisor to run the Celery worker. Here's a typical config file, which might be called \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"celery-supervisor.conf\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-ini\"\n  }, \"[program:celeryd]\\ncommand=/var/www/mysite/venv/bin/python manage.py celery worker\\ndirectory=/var/www/mysite/\\nuser=nobody\\nautostart=true\\nautorestart=true\\n\")), mdx(\"p\", null, \"Then start it up:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ sudo supervisorctl reread\\n$ sudo supervisorctl update\\n$ sudo supervisorctl start celeryd\\n\")), mdx(\"p\", null, \"I make no claims about how good this setup is, but it works well for me. I haven't yet had the occasion to deploy a Django app to anywhere other than Heroku that really benefited from caching, so I haven't got any tips to share about that, but if I were building a content-driven web app, I would use Memcached since it's well-supported.\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"This isn't really part of my Django tutorial series (that has now definitely concluded!), but I thought I'd share the setup I generally use for deploying Django applicationsâ€¦","frontmatter":{"title":"My Django web server setup","date":"19th October 2014 6:52 pm","isoDate":"2014-10-19T18:52:28+00:00","categories":["python","django"]},"fields":{"path":"/blog/2014/10/19/my-django-web-server-setup/"}}},"pageContext":{"previous":{"fields":{"path":"/blog/2014/10/05/introducing-generator-simple-static-blog/"},"frontmatter":{"title":"Introducing generator-simple-static-blog","date":"2014-10-05 19:56:46 +0100","layout":"post"}},"next":{"fields":{"path":"/blog/2014/11/09/building-a-url-shortener-with-node-dot-js-and-redis/"},"frontmatter":{"title":"Building a URL shortener with Node.js and Redis","date":"2014-11-09 17:13:16 +0000","layout":"post"}}}},"staticQueryHashes":["290055352","3373576264"]}