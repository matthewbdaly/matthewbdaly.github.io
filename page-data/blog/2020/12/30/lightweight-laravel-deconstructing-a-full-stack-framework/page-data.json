{"componentChunkName":"component---src-templates-post-tsx","path":"/blog/2020/12/30/lightweight-laravel-deconstructing-a-full-stack-framework/","result":{"data":{"site":{"siteMetadata":{"title":"Matthew Daly","siteUrl":"https://matthewdaly.co.uk"}},"mdx":{"id":"35e49fe6-e166-5e71-b804-83e7e9baa9cb","body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Lightweight Laravel - deconstructing a full stack framework\",\n  \"date\": \"2020-12-30 17:00:00 +0000\",\n  \"layout\": \"post\",\n  \"categories\": [\"php\", \"laravel\"],\n  \"comments\": true\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Back when I used to work with Django, I read the book \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.oreilly.com/library/view/lightweight-django/9781491946275/\"\n  }, \"Lightweight Django\"), \", and it completely changed the way I thought about building web applications. For years I'd heard the same lines parroted about how Django was too large and bloated, and something like Flask was a better bet for many applications, and this book completely blew this misconception away. By demonstrating how it was possible to break the framework apart, use just what you need, and leave out what you don't, it showed how I could benefit from my familiarity with Django, while making it more suitable for smaller applications.\"), mdx(\"p\", null, \"Laravel, like Django, is a full stack framework, and is often subject to similar misconceptions about bloat. But just because the framework ships with all this stuff, doesn't mean you're obliged to use it all. If you know you aren't going to need all of a framework's functionality, there's nothing stopping you getting rid of what you don't need, or even replacing it with something else. In this article, I'll show you how to apply the same methodology to a Laravel application to remove what you don't need. As part of this, we'll be building a simple placeholder image service. This was used in Lightweight Django as it's a good example of an application that is completely stateless, and doesn't need sessions or a database, so it's often seen as a bad fit for a full stack framework. Since the same applies here, it's a good example for us too.\"), mdx(\"h2\", null, \"Getting started\"), mdx(\"p\", null, \"Run the following command in the shell to create a new Laravel application:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ composer create-project --prefer-dist laravel/laravel lightweight-laravel\\n\")), mdx(\"p\", null, \"What this actually does is as follows:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Resolve the latest release of the package \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"laravel/laravel\"), \" that will work on your system\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Copy it from the \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://github.com/laravel/laravel\"\n  }, \"repository\"), \" to the specified location\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Carry out any post-install scripts specified, such as creating the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \".env\"), \" file and generating a key\")), mdx(\"p\", null, \"However, that's just a standardised boilerplate for Laravel applications. Most of the functionality of the framework is in the package \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"laravel/framework\"), \", which is included as a dependency in your \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"composer.json\"), \". This makes sense, because by keeping as much of the actual framework out of the starter boilerplate and in a separate repository, it minimises the work required to update the application to a new version. It also means you can strip that boilerplate down to remove references to things you don't need, and even create your own custom boilerplates to save you work in future.\"), mdx(\"h2\", null, \"Stripping down the boilerplate\"), mdx(\"p\", null, \"Let's start stripping out the things we don't need. Since our application is stateless, we have no need whatsoever of a database, so we can delete the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"app/Models\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"database\"), \" folders. We'll want to support Redis for the cache, so we can't delete the file \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"config/database.php\"), \", but we can remove any references to the database other than Redis from that file. We can delete some other files from the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"config/\"), \" folder, namely \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"auth.php\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"broadcasting.php\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"filesystems.php\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"mail.php\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"queue.php\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"services.php\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"session.php\"), \".\"), mdx(\"p\", null, \"We also don't need a lot of the middleware that ships with Laravel. If you go into the file \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"app/Http/Kernel.php\"), \" you'll see that it assigns some middleware as global, some to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"web\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"api\"), \" groups, and some as optional route middleware. In this file:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"We don't need to make any POST requests to this application, so we can lose the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"ValidatePostSize\"), \" middleware from the global middleware entirely\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"web\"), \" group relates to cookies, sessions, CSRF, authentication and handling routing with substitute bindings. Since we don't need any of that we can empty this group entirely\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"auth\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"auth.basic\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"can\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"guest\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"password.confirm\"), \", and \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"verified\"), \" route middleware is also surplus to requirements and can go\")), mdx(\"p\", null, \"As this change is a bit fiddly, here's a patch, which may be easier to read:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-diff\"\n  }, \"From 6bc87e9602e839d5635963b6d740279b2dbcf16b Mon Sep 17 00:00:00 2001\\nFrom: Matthew Daly <Matthew Daly 450801+matthewbdaly@users.noreply.github.com>\\nDate: Wed, 30 Dec 2020 11:54:56 +0000\\nSubject: [PATCH] Removed unwanted middleware\\n\\n---\\n app/Http/Kernel.php | 14 --------------\\n 1 file changed, 14 deletions(-)\\n\\ndiff --git a/app/Http/Kernel.php b/app/Http/Kernel.php\\nindex 30020a5..10e150d 100644\\n--- a/app/Http/Kernel.php\\n+++ b/app/Http/Kernel.php\\n@@ -18,7 +18,6 @@ class Kernel extends HttpKernel\\n         \\\\App\\\\Http\\\\Middleware\\\\TrustProxies::class,\\n         \\\\Fruitcake\\\\Cors\\\\HandleCors::class,\\n         \\\\App\\\\Http\\\\Middleware\\\\PreventRequestsDuringMaintenance::class,\\n-        \\\\Illuminate\\\\Foundation\\\\Http\\\\Middleware\\\\ValidatePostSize::class,\\n         \\\\App\\\\Http\\\\Middleware\\\\TrimStrings::class,\\n         \\\\Illuminate\\\\Foundation\\\\Http\\\\Middleware\\\\ConvertEmptyStringsToNull::class,\\n     ];\\n@@ -30,13 +29,6 @@ class Kernel extends HttpKernel\\n      */\\n     protected $middlewareGroups = [\\n         'web' => [\\n-            \\\\App\\\\Http\\\\Middleware\\\\EncryptCookies::class,\\n-            \\\\Illuminate\\\\Cookie\\\\Middleware\\\\AddQueuedCookiesToResponse::class,\\n-            \\\\Illuminate\\\\Session\\\\Middleware\\\\StartSession::class,\\n-            // \\\\Illuminate\\\\Session\\\\Middleware\\\\AuthenticateSession::class,\\n-            \\\\Illuminate\\\\View\\\\Middleware\\\\ShareErrorsFromSession::class,\\n-            \\\\App\\\\Http\\\\Middleware\\\\VerifyCsrfToken::class,\\n-            \\\\Illuminate\\\\Routing\\\\Middleware\\\\SubstituteBindings::class,\\n         ],\\n\\n         'api' => [\\n@@ -53,14 +45,8 @@ class Kernel extends HttpKernel\\n      * @var array\\n      */\\n     protected $routeMiddleware = [\\n-        'auth' => \\\\App\\\\Http\\\\Middleware\\\\Authenticate::class,\\n-        'auth.basic' => \\\\Illuminate\\\\Auth\\\\Middleware\\\\AuthenticateWithBasicAuth::class,\\n         'cache.headers' => \\\\Illuminate\\\\Http\\\\Middleware\\\\SetCacheHeaders::class,\\n-        'can' => \\\\Illuminate\\\\Auth\\\\Middleware\\\\Authorize::class,\\n-        'guest' => \\\\App\\\\Http\\\\Middleware\\\\RedirectIfAuthenticated::class,\\n-        'password.confirm' => \\\\Illuminate\\\\Auth\\\\Middleware\\\\RequirePassword::class,\\n         'signed' => \\\\Illuminate\\\\Routing\\\\Middleware\\\\ValidateSignature::class,\\n         'throttle' => \\\\Illuminate\\\\Routing\\\\Middleware\\\\ThrottleRequests::class,\\n-        'verified' => \\\\Illuminate\\\\Auth\\\\Middleware\\\\EnsureEmailIsVerified::class,\\n     ];\\n }\\n--\\n2.28.0\\n\\n\")), mdx(\"p\", null, \"These changes also mean a lot of the service providers and facades are now redundant and can be removed from the application. If you go into \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"config/app.php\"), \" you can remove \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AuthServiceProvider\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"BroadcastServiceProvider\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CookieServiceProvider\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"MailServiceProvider\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"NotificationServiceProvider\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"PaginationServiceProvider\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"PasswordResetServiceProvider\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SessionServiceProvider\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TranslationServiceProvider\"), \" from the providers section, as well as the commented-out local \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"BroadcastServiceProvider\"), \". You can also delete the facades for \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Auth\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Cookie\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"DB\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Eloquent\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Gate\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Lang\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Mail\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Notification\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Password\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Queue\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Schema\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Session\"), \", and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Storage\"), \".\"), mdx(\"p\", null, \"Again, here's a patch of the required changes:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-diff\"\n  }, \"From 66be3b836706ef488b890cdae6e97d4fc6195dd6 Mon Sep 17 00:00:00 2001\\nFrom: Matthew Daly <Matthew Daly 450801+matthewbdaly@users.noreply.github.com>\\nDate: Wed, 30 Dec 2020 12:10:25 +0000\\nSubject: [PATCH] Removed unused service providers and facades\\n\\n---\\n config/app.php | 26 --------------------------\\n 1 file changed, 26 deletions(-)\\n\\ndiff --git a/config/app.php b/config/app.php\\nindex 2a2f0eb..b7a38c8 100644\\n--- a/config/app.php\\n+++ b/config/app.php\\n@@ -139,26 +139,17 @@ return [\\n         /*\\n          * Laravel Framework Service Providers...\\n          */\\n-        Illuminate\\\\Auth\\\\AuthServiceProvider::class,\\n-        Illuminate\\\\Broadcasting\\\\BroadcastServiceProvider::class,\\n         Illuminate\\\\Bus\\\\BusServiceProvider::class,\\n         Illuminate\\\\Cache\\\\CacheServiceProvider::class,\\n         Illuminate\\\\Foundation\\\\Providers\\\\ConsoleSupportServiceProvider::class,\\n-        Illuminate\\\\Cookie\\\\CookieServiceProvider::class,\\n         Illuminate\\\\Database\\\\DatabaseServiceProvider::class,\\n         Illuminate\\\\Encryption\\\\EncryptionServiceProvider::class,\\n         Illuminate\\\\Filesystem\\\\FilesystemServiceProvider::class,\\n         Illuminate\\\\Foundation\\\\Providers\\\\FoundationServiceProvider::class,\\n         Illuminate\\\\Hashing\\\\HashServiceProvider::class,\\n-        Illuminate\\\\Mail\\\\MailServiceProvider::class,\\n-        Illuminate\\\\Notifications\\\\NotificationServiceProvider::class,\\n-        Illuminate\\\\Pagination\\\\PaginationServiceProvider::class,\\n         Illuminate\\\\Pipeline\\\\PipelineServiceProvider::class,\\n         Illuminate\\\\Queue\\\\QueueServiceProvider::class,\\n         Illuminate\\\\Redis\\\\RedisServiceProvider::class,\\n-        Illuminate\\\\Auth\\\\Passwords\\\\PasswordResetServiceProvider::class,\\n-        Illuminate\\\\Session\\\\SessionServiceProvider::class,\\n-        Illuminate\\\\Translation\\\\TranslationServiceProvider::class,\\n         Illuminate\\\\Validation\\\\ValidationServiceProvider::class,\\n         Illuminate\\\\View\\\\ViewServiceProvider::class,\\n\\n@@ -170,9 +161,6 @@ return [\\n          * Application Service Providers...\\n          */\\n         App\\\\Providers\\\\AppServiceProvider::class,\\n-        App\\\\Providers\\\\AuthServiceProvider::class,\\n-        // App\\\\Providers\\\\BroadcastServiceProvider::class,\\n-        App\\\\Providers\\\\EventServiceProvider::class,\\n         App\\\\Providers\\\\RouteServiceProvider::class,\\n\\n     ],\\n@@ -193,35 +181,21 @@ return [\\n         'App' => Illuminate\\\\Support\\\\Facades\\\\App::class,\\n         'Arr' => Illuminate\\\\Support\\\\Arr::class,\\n         'Artisan' => Illuminate\\\\Support\\\\Facades\\\\Artisan::class,\\n-        'Auth' => Illuminate\\\\Support\\\\Facades\\\\Auth::class,\\n         'Blade' => Illuminate\\\\Support\\\\Facades\\\\Blade::class,\\n         'Broadcast' => Illuminate\\\\Support\\\\Facades\\\\Broadcast::class,\\n         'Bus' => Illuminate\\\\Support\\\\Facades\\\\Bus::class,\\n         'Cache' => Illuminate\\\\Support\\\\Facades\\\\Cache::class,\\n         'Config' => Illuminate\\\\Support\\\\Facades\\\\Config::class,\\n-        'Cookie' => Illuminate\\\\Support\\\\Facades\\\\Cookie::class,\\n         'Crypt' => Illuminate\\\\Support\\\\Facades\\\\Crypt::class,\\n-        'DB' => Illuminate\\\\Support\\\\Facades\\\\DB::class,\\n-        'Eloquent' => Illuminate\\\\Database\\\\Eloquent\\\\Model::class,\\n-        'Event' => Illuminate\\\\Support\\\\Facades\\\\Event::class,\\n         'File' => Illuminate\\\\Support\\\\Facades\\\\File::class,\\n-        'Gate' => Illuminate\\\\Support\\\\Facades\\\\Gate::class,\\n         'Hash' => Illuminate\\\\Support\\\\Facades\\\\Hash::class,\\n         'Http' => Illuminate\\\\Support\\\\Facades\\\\Http::class,\\n-        'Lang' => Illuminate\\\\Support\\\\Facades\\\\Lang::class,\\n         'Log' => Illuminate\\\\Support\\\\Facades\\\\Log::class,\\n-        'Mail' => Illuminate\\\\Support\\\\Facades\\\\Mail::class,\\n-        'Notification' => Illuminate\\\\Support\\\\Facades\\\\Notification::class,\\n-        'Password' => Illuminate\\\\Support\\\\Facades\\\\Password::class,\\n-        'Queue' => Illuminate\\\\Support\\\\Facades\\\\Queue::class,\\n         'Redirect' => Illuminate\\\\Support\\\\Facades\\\\Redirect::class,\\n         // 'Redis' => Illuminate\\\\Support\\\\Facades\\\\Redis::class,\\n         'Request' => Illuminate\\\\Support\\\\Facades\\\\Request::class,\\n         'Response' => Illuminate\\\\Support\\\\Facades\\\\Response::class,\\n         'Route' => Illuminate\\\\Support\\\\Facades\\\\Route::class,\\n-        'Schema' => Illuminate\\\\Support\\\\Facades\\\\Schema::class,\\n-        'Session' => Illuminate\\\\Support\\\\Facades\\\\Session::class,\\n-        'Storage' => Illuminate\\\\Support\\\\Facades\\\\Storage::class,\\n         'Str' => Illuminate\\\\Support\\\\Str::class,\\n         'URL' => Illuminate\\\\Support\\\\Facades\\\\URL::class,\\n         'Validator' => Illuminate\\\\Support\\\\Facades\\\\Validator::class,\\n--\\n2.28.0\\n\\n\")), mdx(\"p\", null, \"There are a few service providers that ideally we'd strip out but are tightly integrated into the framework. For instance, the database and queue service providers are both used by some Artisan commands, and it's not very practical to disable only those commands, so removing them will stop Artisan from working. If you don't mind running the development server manually, you can go ahead and remove these.\"), mdx(\"h2\", null, \"Building the application\"), mdx(\"p\", null, \"Now, let's set out how our application will work. We will have two routes:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A route that accepts width and height parameters in the route itself, and responds with a PNG response sized accordingly\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A route that returns a simple HTML homepage\")), mdx(\"p\", null, \"You've no doubt seen various novelty placeholder sites like \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"http://placekitten.com/\"\n  }, \"placekitten.com\"), \" for use in web projects, and this will be similar to that. We'll use a simple black image with the dimensions in white text, but you should be able to use this as the basis of a more sophisticated placeholder service, such as if you wanted to use branded images for a particular client.\"), mdx(\"p\", null, \"Since the home page will be fairly straightforward, let's do that first. Delete the existing \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"resources/views/welcome.blade.php\"), \" file and save this to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"resources/views/home.blade.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-html\",\n    \"metastring\": \"title=resources/views/home.blade.php\",\n    \"title\": \"resources/views/home.blade.php\"\n  }, \"<!DOCTYPE html>\\n<html lang=\\\"en\\\">\\n<head>\\n    <meta charset=\\\"utf-8\\\">\\n    <title>Laravel Placeholder Images</title>\\n    <link href=\\\"{{ mix('css/app.css') }}\\\" rel=\\\"stylesheet\\\">\\n</head>\\n<body>\\n    <h1>Laravel Placeholder Images</h1>\\n    <p>This server can be used for serving placeholder\\n    images for any web page.</p>\\n    <p>To request a placeholder image of a given width and height\\n    simply include an image with the source pointing to\\n    <b>/image/&lt;width&gt;x&lt;height&gt;/</b>\\n    on this server such as:</p>\\n    <pre>\\n        &lt;img src=\\\"{{ $example }}\\\" &gt;\\n    </pre>\\n    <h2>Examples</h2>\\n    <ul>\\n        <li><img src=\\\"{{{ route('placeholder', ['width' => 50, 'height' => 50]) }}}\\\"></li>\\n        <li><img src=\\\"{{{ route('placeholder', ['width' => 100, 'height' => 50]) }}}\\\"></li>\\n        <li><img src=\\\"{{{ route('placeholder', ['width' => 50, 'height' => 100]) }}}\\\"></li>\\n    </ul>\\n</body>\\n</html>\\n\")), mdx(\"p\", null, \"Note we're using the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"route()\"), \" helper to add some example images, even though it's not in place yet. Add this route to your \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"routes/web.php\"), \" as well:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\",\n    \"metastring\": \"title=routes/web.php\",\n    \"title\": \"routes/web.php\"\n  }, \"Route::get('/', function () {\\n    return view('home', [\\n        'example' => route('placeholder', ['width' => 50, 'height' => 50]),\\n    ]);\\n});\\n\")), mdx(\"p\", null, \"Again, note that we're using the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"route()\"), \" helper to get the URL for the placeholder image. Next, we need to create the outline of the route for getting the placeholders:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\",\n    \"metastring\": \"title=routes/web.php\",\n    \"title\": \"routes/web.php\"\n  }, \"Route::get('/placeholder/{width}x{height}', function (int $width, int $height) {\\n})->where(['width' => '[0-9]+', 'height' => '[0-9]+'])\\n    ->name('placeholder');\\n\")), mdx(\"p\", null, \"Due to the limited scope of this application, we won't bother with full controllers, but you can add them if you wish. Note we've specified the name \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"placeholder\"), \" and set a regex to validate the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"width\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"height\"), \" parameters.\"), mdx(\"p\", null, \"Now let's populate the callback to generate a PNG file.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\",\n    \"metastring\": \"title=routes/web.php {2-13}\",\n    \"title\": \"routes/web.php\",\n    \"{2-13}\": true\n  }, \"Route::get('/placeholder/{width}x{height}', function (int $width, int $height) {\\n    if (!$img = imagecreatetruecolor($width, $height)) {\\n        abort();\\n    }\\n    $textColour = imagecolorallocate($img, 255, 255, 255);\\n    imagestring($img, 1, 5, 5, \\\"$width X $height\\\", $textColour);\\n    ob_start();\\n    imagepng($img);\\n    $file = ob_get_contents();\\n    ob_end_clean();\\n    return response()->make($file, 200, [\\n        'Content-type' => 'image/png'\\n    ]);\\n})->where(['width' => '[0-9]+', 'height' => '[0-9]+'])\\n    ->name('placeholder');\\n\")), mdx(\"p\", null, \"We'll also add some very basic CSS to the provided CSS file:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-css\",\n    \"metastring\": \"title=resources/css/app.css\",\n    \"title\": \"resources/css/app.css\"\n  }, \"body {\\n    text-align: center;\\n}\\n\\nul {\\n    list-type: none;\\n}\\n\\nli {\\n    display: inline-block;\\n}\\n\")), mdx(\"p\", null, \"Don't forget to build this with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"npm install && npm run production\"), \" too.\"), mdx(\"p\", null, \"If you now run \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"php artisan serve\"), \" you should be able to see that it works - the homepage renders, and the embedded images are pulled in OK. However, there are three potential issues:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The images themselves are regenerated each time. Since they never change, it's a no-brainer to cache them indefinitely for the best performance, and if we do need to change them in the future we can just flush the cache to resolve this\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Similarly, we should use ETags to allow the application to tell the browser when the image has changed\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"There's no limit on how large images can be, so a malicious user could request a huge image to break the system\")), mdx(\"p\", null, \"Let's tackle these in order. First, let's create some middleware to handle the caching:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\",\n    \"metastring\": \"title=app/Http/Middleware/CacheImages.php\",\n    \"title\": \"app/Http/Middleware/CacheImages.php\"\n  }, \"<?php\\n\\nnamespace App\\\\Http\\\\Middleware;\\n\\nuse Closure;\\nuse Illuminate\\\\Http\\\\Request;\\nuse Illuminate\\\\Support\\\\Facades\\\\Cache;\\n\\nfinal class CacheImages\\n{\\n    /**\\n     * Handle an incoming request.\\n     *\\n     * @param  \\\\Illuminate\\\\Http\\\\Request  $request\\n     * @param  \\\\Closure  $next\\n     * @return mixed\\n     */\\n    public function handle(Request $request, Closure $next)\\n    {\\n        $key = sprintf(\\\"%d.%d\\\", $request->width, $request->height);\\n        return Cache::rememberForever($key, function () use ($next, $request) {\\n            return $next($request);\\n        });\\n    }\\n}\\n\")), mdx(\"p\", null, \"We construct a cache key from the request width and height, and use the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Cache::rememberForever()\"), \" method to cache the response. We then register this middleware as route middleware in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"app/Http/Kernel.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\",\n    \"metastring\": \"title=app/Http/Kernel.php {5}\",\n    \"title\": \"app/Http/Kernel.php\",\n    \"{5}\": true\n  }, \"    protected $routeMiddleware = [\\n        'cache.headers' => \\\\Illuminate\\\\Http\\\\Middleware\\\\SetCacheHeaders::class,\\n        'signed' => \\\\Illuminate\\\\Routing\\\\Middleware\\\\ValidateSignature::class,\\n        'throttle' => \\\\Illuminate\\\\Routing\\\\Middleware\\\\ThrottleRequests::class,\\n        'cache.images' => \\\\App\\\\Http\\\\Middleware\\\\CacheImages::class,\\n    ];\\n\")), mdx(\"p\", null, \"And apply it to the image route:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\",\n    \"metastring\": \"title=routes/web.php {16}\",\n    \"title\": \"routes/web.php\",\n    \"{16}\": true\n  }, \"Route::get('/placeholder/{width}x{height}', function (int $width, int $height) {\\n    if (!$img = imagecreatetruecolor($width, $height)) {\\n        abort();\\n    }\\n    $textColour = imagecolorallocate($img, 255, 255, 255);\\n    imagestring($img, 1, 5, 5, \\\"$width X $height\\\", $textColour);\\n    ob_start();\\n    imagepng($img);\\n    $file = ob_get_contents();\\n    ob_end_clean();\\n    return response()->make($file, 200, [\\n        'Content-type' => 'image/png'\\n    ]);\\n})->where(['width' => '[0-9]+', 'height' => '[0-9]+'])\\n  ->name('placeholder')\\n  ->middleware('cache.images');\\n\")), mdx(\"p\", null, \"Next, let's set ETags on our images. Laravel comes with the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"cache.headers\"), \" middleware, which we can easily wrap around our placeholder route:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\",\n    \"metastring\": \"title=routes/web.php {1,18}\",\n    \"title\": \"routes/web.php\",\n    \"{1,18}\": true\n  }, \"Route::middleware('cache.headers:public;etag')->group(function () {\\n    Route::get('/placeholder/{width}x{height}', function (int $width, int $height) {\\n        if (!$img = imagecreatetruecolor($width, $height)) {\\n            abort();\\n        }\\n        $textColour = imagecolorallocate($img, 255, 255, 255);\\n        imagestring($img, 1, 5, 5, \\\"$width X $height\\\", $textColour);\\n        ob_start();\\n        imagepng($img);\\n        $file = ob_get_contents();\\n        ob_end_clean();\\n        return response()->make($file, 200, [\\n            'Content-type' => 'image/png'\\n        ]);\\n    })->where(['width' => '[0-9]+', 'height' => '[0-9]+'])\\n      ->name('placeholder')\\n      ->middleware('cache.images');\\n});\\n\")), mdx(\"p\", null, \"Finally, let's handle the dimensions issue. Again, this is something that is probably best handled in middleware since that way it can be rejected before the point it gets to the route handler. All we need to do is to check to see if the width and height parameters exceed the intended value, and throw an error in the middleware:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\",\n    \"metastring\": \"title=app/Http/Middleware/ValidateImageDimensions.php\",\n    \"title\": \"app/Http/Middleware/ValidateImageDimensions.php\"\n  }, \"<?php\\n\\nnamespace App\\\\Http\\\\Middleware;\\n\\nuse Closure;\\nuse Illuminate\\\\Http\\\\Request;\\nuse Illuminate\\\\Validation\\\\ValidationException;\\n\\nfinal class ValidateImageDimensions\\n{\\n    /**\\n     * Handle an incoming request.\\n     *\\n     * @param  \\\\Illuminate\\\\Http\\\\Request  $request\\n     * @param  \\\\Closure  $next\\n     * @return mixed\\n     */\\n    public function handle(Request $request, Closure $next)\\n    {\\n        if ($request->width > 2000 || $request->height > 2000) {\\n            abort(422, 'Height and width cannot exceed 2000 pixels');\\n        }\\n        return $next($request);\\n    }\\n}\\n\")), mdx(\"p\", null, \"Register this middleware in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"app/Http/Kernel.php\"), \":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\",\n    \"metastring\": \"title=app/Http/Kernel.php {5}\",\n    \"title\": \"app/Http/Kernel.php\",\n    \"{5}\": true\n  }, \"    protected $routeMiddleware = [\\n        'cache.headers' => \\\\Illuminate\\\\Http\\\\Middleware\\\\SetCacheHeaders::class,\\n        'signed' => \\\\Illuminate\\\\Routing\\\\Middleware\\\\ValidateSignature::class,\\n        'throttle' => \\\\Illuminate\\\\Routing\\\\Middleware\\\\ThrottleRequests::class,\\n        'cache.images' => \\\\App\\\\Http\\\\Middleware\\\\CacheImages::class,\\n        'validate.images' => \\\\App\\\\Http\\\\Middleware\\\\ValidateImageDimensions::class,\\n    ];\\n\")), mdx(\"p\", null, \"And apply it to the image route:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php\",\n    \"metastring\": \"title=routes/web.php {17}\",\n    \"title\": \"routes/web.php\",\n    \"{17}\": true\n  }, \"Route::middleware('cache.headers:public;etag')->group(function () {\\n    Route::get('/placeholder/{width}x{height}', function (int $width, int $height) {\\n        if (!$img = imagecreatetruecolor($width, $height)) {\\n            abort();\\n        }\\n        $textColour = imagecolorallocate($img, 255, 255, 255);\\n        imagestring($img, 1, 5, 5, \\\"$width X $height\\\", $textColour);\\n        ob_start();\\n        imagepng($img);\\n        $file = ob_get_contents();\\n        ob_end_clean();\\n        return response()->make($file, 200, [\\n            'Content-type' => 'image/png'\\n        ]);\\n    })->where(['width' => '[0-9]+', 'height' => '[0-9]+'])\\n      ->name('placeholder')\\n      ->middleware(['validate.images', 'cache.images']);\\n});\\n\")), mdx(\"p\", null, \"And we're done! We now have a basic, but functional, stateless Laravel application that's been stripped of a lot of the unnecessary functionality. There are a few further changes that could be made to expand this if necessary, such as:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Amend the project to allow requesting different image formats using an additional route parameter (hint - you'll want to use something like \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"http://image.intervention.io/\"\n  }, \"Intervention for this\"), \")\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Serve different images, either by using one as a starting template so they are all branded the same, or specifying one from several options in the URL, such as with \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://www.placecage.com/\"\n  }, \"PlaceCage\"))), mdx(\"p\", null, \"However, I will leave these as an exercise for the reader. The code for this project is available on \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/matthewbdaly/lightweight-laravel\"\n  }, \"Github\"), \" if you get stuck at any point.\"), mdx(\"p\", null, \"Hopefully, this article has given you some food for thought about how you can use Laravel for applications you might have previously considered too small to use it for. Don't worry too much about removing something that you need to add later - version control means you can always retrieve it if it turns out you do need it later. I'd also add that potentially the same approach can be applied to other full stack PHP frameworks, though you'll have to do some exploring on your own to determine this.\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"Back when I used to work with Django, I read the book  Lightweight Django , and it completely changed the way I thought about building web applications. For years I'd heard the…","frontmatter":{"title":"Lightweight Laravel - deconstructing a full stack framework","date":"30th December 2020 5:00 pm","isoDate":"2020-12-30T17:00:00+00:00","categories":["php","laravel"]},"fields":{"path":"/blog/2020/12/30/lightweight-laravel-deconstructing-a-full-stack-framework/"}}},"pageContext":{"previous":{"fields":{"path":"/blog/2020/09/28/what-i-want-in-a-php-cms/"},"frontmatter":{"title":"What I want in a PHP CMS","date":"2020-09-28 15:50:48 +0100","layout":"post"}},"next":{"fields":{"path":"/blog/2021/07/28/moving-to-gatsby-js/"},"frontmatter":{"title":"Moving to Gatsby.js","date":"2021-07-28 14:36:00 +0000","layout":"post"}}}},"staticQueryHashes":["290055352","2909664151"]}