<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e3adbc0bd75eaf448024.css" data-identity="gatsby-global-css">/*! tailwindcss v2.2.4 | MIT License | https://tailwindcss.com */

/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */html{-webkit-text-size-adjust:100%;line-height:1.15;-moz-tab-size:4;-o-tab-size:4;tab-size:4}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;margin:0}hr{color:inherit;height:0}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=submit],button{-webkit-appearance:button}legend{padding:0}progress{vertical-align:baseline}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{border:0 solid;box-sizing:border-box}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{color:inherit;line-height:inherit;padding:0}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}*,:after,:before{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}.float-right{float:right}.float-left{float:left}.float-none{float:none}.clear-both{clear:both}.m-0{margin:0}.mx-0{margin-left:0;margin-right:0}.mx-auto{margin-left:auto;margin-right:auto}.my-2{margin-bottom:.5rem;margin-top:.5rem}.my-4{margin-bottom:1rem;margin-top:1rem}.mt-2{margin-top:.5rem}.mt-16{margin-top:4rem}.mr-2{margin-right:.5rem}.mr-8{margin-right:2rem}.-mb-4{margin-bottom:-1rem}.-mb-8{margin-bottom:-2rem}.box-border{box-sizing:border-box}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.table{display:table}.hidden{display:none}.h-2{height:.5rem}.h-4{height:1rem}.min-h-screen{min-height:100vh}.w-1\/2{width:50%}.w-1\/3{width:33.333333%}.w-1\/4{width:25%}.w-3\/4{width:75%}.w-full{width:100%}.flex-grow{flex-grow:1}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{opacity:0;transform:scale(2)}}@keyframes ping{75%,to{opacity:0;transform:scale(2)}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}@keyframes bounce{0%,to{-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}.list-disc{list-style-type:disc}.flex-row{flex-direction:row}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.justify-center{justify-content:center}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(2rem*var(--tw-space-y-reverse));margin-top:calc(2rem*(1 - var(--tw-space-y-reverse)))}.space-y-16>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(4rem*var(--tw-space-y-reverse));margin-top:calc(4rem*(1 - var(--tw-space-y-reverse)))}.space-y-32>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(8rem*var(--tw-space-y-reverse));margin-top:calc(8rem*(1 - var(--tw-space-y-reverse)))}.divide-y>:not([hidden])~:not([hidden]){--tw-divide-y-reverse:0;border-bottom-width:calc(1px*var(--tw-divide-y-reverse));border-top-width:calc(1px*(1 - var(--tw-divide-y-reverse)))}.divide-gray-800>:not([hidden])~:not([hidden]){--tw-divide-opacity:1;border-color:rgba(31,41,55,var(--tw-divide-opacity))}@media (prefers-color-scheme:dark){.dark\:divide-gray-200>:not([hidden])~:not([hidden]){--tw-divide-opacity:1;border-color:rgba(229,231,235,var(--tw-divide-opacity))}}.overflow-x-auto{overflow-x:auto}.overflow-x-scroll{overflow-x:scroll}.rounded-full{border-radius:9999px}.rounded-t-lg{border-top-left-radius:.5rem;border-top-right-radius:.5rem}.border-2{border-width:2px}.border-b-2{border-bottom-width:2px}.border-b-4{border-bottom-width:4px}.border-l-8{border-left-width:8px}.border-transparent{border-color:transparent}.border-gray-100{--tw-border-opacity:1;border-color:rgba(243,244,246,var(--tw-border-opacity))}.border-gray-500{--tw-border-opacity:1;border-color:rgba(107,114,128,var(--tw-border-opacity))}.border-gray-800{--tw-border-opacity:1;border-color:rgba(31,41,55,var(--tw-border-opacity))}.border-green-400,.hover\:border-green-400:hover{--tw-border-opacity:1;border-color:rgba(52,211,153,var(--tw-border-opacity))}.focus\:border-blue-300:focus{--tw-border-opacity:1;border-color:rgba(147,197,253,var(--tw-border-opacity))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgba(249,250,251,var(--tw-bg-opacity))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgba(243,244,246,var(--tw-bg-opacity))}.bg-gray-300{--tw-bg-opacity:1;background-color:rgba(209,213,219,var(--tw-bg-opacity))}.bg-gray-800{--tw-bg-opacity:1;background-color:rgba(31,41,55,var(--tw-bg-opacity))}.bg-purple-200{--tw-bg-opacity:1;background-color:rgba(221,214,254,var(--tw-bg-opacity))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgba(229,231,235,var(--tw-bg-opacity))}.hover\:bg-purple-800:hover{--tw-bg-opacity:1;background-color:rgba(91,33,182,var(--tw-bg-opacity))}@media (prefers-color-scheme:dark){.dark\:bg-gray-700{--tw-bg-opacity:1;background-color:rgba(55,65,81,var(--tw-bg-opacity))}.dark\:bg-gray-800{--tw-bg-opacity:1;background-color:rgba(31,41,55,var(--tw-bg-opacity))}.dark\:bg-gray-900{--tw-bg-opacity:1;background-color:rgba(17,24,39,var(--tw-bg-opacity))}.dark\:hover\:bg-gray-800:hover{--tw-bg-opacity:1;background-color:rgba(31,41,55,var(--tw-bg-opacity))}}.bg-gradient-to-r{background-image:linear-gradient(to right,var(--tw-gradient-stops))}.bg-gradient-to-b{background-image:linear-gradient(to bottom,var(--tw-gradient-stops))}.from-gray-200{--tw-gradient-from:#e5e7eb;--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to,rgba(229,231,235,0))}.from-green-400{--tw-gradient-from:#34d399;--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to,rgba(52,211,153,0))}.via-blue-500{--tw-gradient-stops:var(--tw-gradient-from),#3b82f6,var(--tw-gradient-to,rgba(59,130,246,0))}.to-gray-300{--tw-gradient-to:#d1d5db}.to-purple-500{--tw-gradient-to:#8b5cf6}.p-2{padding:.5rem}.p-4{padding:1rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-4{padding-left:1rem;padding-right:1rem}.px-8{padding-left:2rem;padding-right:2rem}.py-2{padding-bottom:.5rem;padding-top:.5rem}.py-4{padding-bottom:1rem}.pt-4,.py-4{padding-top:1rem}.pb-16{padding-bottom:4rem}.pl-4{padding-left:1rem}.pl-6{padding-left:1.5rem}.text-center{text-align:center}.font-sans{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.text-sm{font-size:.875rem;line-height:1.25rem}.text-lg{font-size:1.125rem}.text-lg,.text-xl{line-height:1.75rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.font-semibold{font-weight:600}.font-bold{font-weight:700}.lowercase{text-transform:lowercase}.italic{font-style:italic}.leading-6{line-height:1.5rem}.text-gray-100{--tw-text-opacity:1;color:rgba(243,244,246,var(--tw-text-opacity))}.text-gray-200{--tw-text-opacity:1;color:rgba(229,231,235,var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity))}.text-gray-900{--tw-text-opacity:1;color:rgba(17,24,39,var(--tw-text-opacity))}.hover\:text-gray-200:hover{--tw-text-opacity:1;color:rgba(229,231,235,var(--tw-text-opacity))}@media (prefers-color-scheme:dark){.dark\:text-gray-100{--tw-text-opacity:1;color:rgba(243,244,246,var(--tw-text-opacity))}.dark\:text-gray-200{--tw-text-opacity:1;color:rgba(229,231,235,var(--tw-text-opacity))}.dark\:text-gray-300{--tw-text-opacity:1;color:rgba(209,213,219,var(--tw-text-opacity))}}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}*,:after,:before{--tw-shadow:0 0 #0000}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,0.05)}.shadow-lg,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05)}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}*,:after,:before{--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000}.focus\:ring:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.filter{--tw-blur:var(--tw-empty,/*!*/ /*!*/);--tw-brightness:var(--tw-empty,/*!*/ /*!*/);--tw-contrast:var(--tw-empty,/*!*/ /*!*/);--tw-grayscale:var(--tw-empty,/*!*/ /*!*/);--tw-hue-rotate:var(--tw-empty,/*!*/ /*!*/);--tw-invert:var(--tw-empty,/*!*/ /*!*/);--tw-saturate:var(--tw-empty,/*!*/ /*!*/);--tw-sepia:var(--tw-empty,/*!*/ /*!*/);--tw-drop-shadow:var(--tw-empty,/*!*/ /*!*/);filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.transition{transition-duration:.15s;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.transition-colors{transition-duration:.15s;transition-property:background-color,border-color,color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1)}.duration-300{transition-duration:.3s}.duration-500{transition-duration:.5s}.ease-in-out{transition-timing-function:cubic-bezier(.4,0,.2,1)}code[class*=language-],pre[class*=language-]{display:block}@media (min-width:768px){.md\:float-none{float:none}.md\:block{display:block}.md\:w-2\/3{width:66.666667%}.md\:w-1\/5{width:20%}}@media (min-width:1024px){.lg\:float-right{float:right}.lg\:float-left{float:left}.lg\:mt-4{margin-top:1rem}.lg\:text-left{text-align:left}}.prism-code{-webkit-overflow-scrolling:touch;background-color:transparent;border-radius:.2em;float:left;font-size:1rem;margin-bottom:1rem;margin-top:1rem;overflow:initial;padding-bottom:1rem;padding-top:1rem;position:relative}.prism-code.title{border-radius:0 0 .2em .2em}pre.prism-code{float:left;min-width:100%;overflow:initial;padding:20px}.token{display:inline-block}li>code,p>code{word-wrap:break-word;background:#011627;border-radius:.2em;color:#d6deeb;padding:.2em;white-space:pre-wrap}.gatsby-highlight{-webkit-overflow-scrolling:touch;font-size:1rem;overflow:auto;position:relative}.gatsby-highlight::-webkit-scrollbar{display:none}.gatsby-highlight>code[class*=language-],.gatsby>pre[class*=language-]{-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;overflow-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-break:normal;word-spacing:normal}.gatsby-highlight .token-line{border-left:4px solid transparent;margin-left:-20px;margin-right:-20px}.line-number-style{display:inline-block;opacity:.3;padding-left:1em;padding-right:2em;position:relative;text-align:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1.2em}.gatsby-highlight .token-line.highlight-line{background-color:#023751;border-left:4px solid #029bce}.gatsby-highlight .token-line.highlight-line .line-number-style{left:0;opacity:.5;width:calc(1.2em - 4px)}</style><meta name="generator" content="Gatsby 3.8.0"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="search" type="application/opensearchdescription+xml" crossorigin="anonymous" href="/opensearch.xml"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><title data-react-helmet="true">Building a postcode lookup client with HTTPlug and PHPSpec | Matthew Daly</title><link data-react-helmet="true" href="https://matthewdaly.co.uk" rel="canonical"/><link data-react-helmet="true" href="https://twitter.com/mattbd" rel="me"/><link data-react-helmet="true" href="https://github.com/matthewbdaly" rel="me"/><link data-react-helmet="true" href="mailto:matthew@matthewdaly.co.uk" rel="me"/><link data-react-helmet="true" href="/key.pub" rel="pgpkey"/><link data-react-helmet="true" href="https://webmention.io/matthewdaly.co.uk/xmlrpc" rel="pingback"/><link data-react-helmet="true" href="https://webmention.io/matthewdaly.co.uk/webmention" rel="webmention"/><link data-react-helmet="true" rel="authorization_endpoint" href="https://indieauth.com/auth"/><link data-react-helmet="true" rel="token_endpoint" href="https://tokens.indieauth.com/token"/><link data-react-helmet="true" rel="openid.delegate" href="https://matthewdaly.co.uk"/><link data-react-helmet="true" rel="openid.server" href="https://openid.indieauth.com/openid"/><link data-react-helmet="true" rel="alternate" type="application/rss+xml" title="Matthew Daly - feed" href="/rss.xml"/><link data-react-helmet="true" rel="alternate" type="application/atom+xml" title="Matthew Daly - feed" href="/atom.xml"/><link data-react-helmet="true" rel="alternate" type="application/feed+json" title="Matthew Daly - feed" href="/feed.json"/><meta data-react-helmet="true" name="description" content="While PHPUnit is my normal go-to PHP testing framework, for some applications I find  PHPSpec  superior, in particular REST API clients. I&#x27;ve found that it makes for a better flow…"/><meta data-react-helmet="true" property="og:title" content="Building a postcode lookup client with HTTPlug and PHPSpec"/><meta data-react-helmet="true" property="og:description" content="While PHPUnit is my normal go-to PHP testing framework, for some applications I find  PHPSpec  superior, in particular REST API clients. I&#x27;ve found that it makes for a better flow…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="mattbd"/><meta data-react-helmet="true" name="twitter:title" content="Building a postcode lookup client with HTTPlug and PHPSpec"/><meta data-react-helmet="true" name="twitter:description" content="While PHPUnit is my normal go-to PHP testing framework, for some applications I find  PHPSpec  superior, in particular REST API clients. I&#x27;ve found that it makes for a better flow…"/><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=53aa06cf17e4239d0dba6ffd09854e02" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#3b82f6"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link as="script" rel="preload" href="/webpack-runtime-88d477ac36829d76e952.js"/><link as="script" rel="preload" href="/framework-cb6229a8adb5817307a4.js"/><link as="script" rel="preload" href="/532a2f07-672258f0b4da4ed2ff53.js"/><link as="script" rel="preload" href="/app-5e95bfecb5da57fd1ffa.js"/><link as="script" rel="preload" href="/f0e45107-763177929e8eed3c13bb.js"/><link as="script" rel="preload" href="/e87769ff526c098a69bffbfff9ee9d57397fcb93-49d3f7242fa2c053e36d.js"/><link as="script" rel="preload" href="/15a3be27178e285ff113e12c60c30466a8f4d4c5-26cc17c8e4fe76c4927b.js"/><link as="script" rel="preload" href="/7840d69eefded84ab93ff6e879351e9a3a16821f-3cc77dc4aa7437d407dd.js"/><link as="script" rel="preload" href="/component---src-templates-post-tsx-493c03ff50c97c3525f1.js"/><link as="fetch" rel="preload" href="/page-data/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/290055352.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2909664151.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="flex flex-col min-h-screen font-sans text-lg antialiased text-gray-800 bg-gray-50 dark:text-gray-100 dark:bg-gray-700 leading-6 pb-16"><div class="w-full h-2 bg-gradient-to-r from-green-400 via-blue-500 to-purple-500"></div><nav class="w-full p-4 mx-auto lowercase md:w-2/3"><h1 class="block float-none py-4 text-4xl text-center lg:float-left lg:text-left"><a href="/">Matthew Daly</a></h1><ul class="py-2 text-center lg:float-right md:block lg:text-left"><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/blog/archives">Archives</a></li><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/about">About</a></li><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/uses">Uses</a></li><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/posts/1">Blog</a></li><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/blog/categories">Categories</a></li><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/search">Search</a></li></ul></nav><div class="w-full h-4 clear"></div><main class="flex-grow w-full p-4 mx-auto md:w-2/3"><article class="h-entry"><header><h2 class="py-4 text-2xl font-bold e-content p-name"><a class="u-url" href="https://matthewdaly.co.uk/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/">Building a postcode lookup client with HTTPlug and PHPSpec</a></h2><p class="my-4 text-lg font-semibold">Published by <a href="/" rel="author">Matthew Daly</a> at <!-- -->28th November 2017 11:40 am</p><time class="hidden dt-published">2017-11-28T11:40:39+00:00</time></header><section><p class="py-2">While PHPUnit is my normal go-to PHP testing framework, for some applications I find <a href="http://www.phpspec.net/en/stable/" class="border-b-2 border-green-400">PHPSpec</a> superior, in particular REST API clients. I&#x27;ve found that it makes for a better flow when doing test-driven development, because it makes it very natural to write a test first, then run it, then make the test pass.</p><p class="py-2">In this tutorial I&#x27;ll show you how to build a lookup API client for UK postcodes. In the process of doing so, we&#x27;ll use PHPSpec to drive our development process. We&#x27;ll also use <a href="http://docs.php-http.org/en/latest/httplug/tutorial.html" class="border-b-2 border-green-400">HTTPlug</a> as our underlying HTTP library. The advantage of this over using something like Guzzle is that we give library users the freedom to choose the HTTP library they feel is most appropriate to their situation.</p><h2 class="py-4 text-2xl font-bold">Background</h2><p class="py-2">If you&#x27;re unfamiliar with it, the UK postcode system is our equivalent of a zip code in the US, but with two major differences:</p><ul class="py-2 pl-4"><li class="list-disc">The codes themselves are alphanumeric instead of numeric, with the first part including one or two letters usually (but not always) derived from the nearest large town or city (eg L for Liverpool, B for Birmingham, OX for Oxford), or for London, based on the part of the city (eg NW for the north-west of London)</li><li class="list-disc">A full postcode is in two parts (eg NW1 8TQ), and the first part narrows the location down to a similar area to a US-style zip code, while the second part usually narrows it down to a street (although sometimes large organisations that receive a lot of mail will have a postcode to themselves).</li></ul><p class="py-2">This means that if you have someone&#x27;s postcode and house name or address, you can use those details to look up the rest of their address details. This obviously makes it easier for users to fill out a form, such as when placing an order on an e-commerce site - you can just request those two details and then autofill the rest from them.</p><p class="py-2">Unfortunately, it&#x27;s not quite that simple. The data is owned by Royal Mail, and they charge through the nose for access to the raw data, which places this data well outside the budgets of many web app developers. Fortunately, <a href="https://ideal-postcodes.co.uk/" class="border-b-2 border-green-400">Ideal Postcodes</a> offer a REST API for querying this data. It&#x27;s not free, but at 2.5p per request it&#x27;s not going to break the bank unless used excessively, and they offer some dummy postcodes that are free to query, which is perfectly fine for testing.</p><p class="py-2">For those of you outside the UK, this may not be of much immediate use, but the underlying principles will still be useful, and you can probably build a similar client for your own nation&#x27;s postal code system. For instance, there&#x27;s a <a href="https://www.zipcodeapi.com/API" class="border-b-2 border-green-400">Zipcode API</a> that those of you in the US can use, and if you understand what&#x27;s going on here it shouldn&#x27;t be hard to adapt it to work with that. If you do produce a similar client for your country&#x27;s postal code system, submit a pull request to update the README with a link to it and I&#x27;ll include it.</p><h2 class="py-4 text-2xl font-bold">Setting up</h2><p class="py-2">First we&#x27;ll create a <code>composer.json</code> to specify our dependencies:</p><pre><div class="gatsby-highlight" data-language="json"><pre class="prism-code language-json" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">    </span><span class="token property" style="color:#5a9bcf">&quot;name&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;matthewbdaly/postcode-client&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">    </span><span class="token property" style="color:#5a9bcf">&quot;description&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;A postcode lookup client.&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">    </span><span class="token property" style="color:#5a9bcf">&quot;type&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;library&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">    </span><span class="token property" style="color:#5a9bcf">&quot;keywords&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token string" style="color:#8dc891">&quot;postcode&quot;</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">    </span><span class="token property" style="color:#5a9bcf">&quot;require&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;psr/http-message&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;^1.0&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;php-http/client-implementation&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;^1.0&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;php-http/httplug&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;^1.0&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;php-http/message-factory&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;^1.0&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;php-http/discovery&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;^1.0&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">    </span><span class="token property" style="color:#5a9bcf">&quot;require-dev&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;psy/psysh&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;^0.8.0&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;phpspec/phpspec&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;^3.2&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;squizlabs/php_codesniffer&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;^2.7&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;php-http/mock-client&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;^1.0&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;php-http/message&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;^1.0&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;guzzlehttp/psr7&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;^1.0&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">    </span><span class="token property" style="color:#5a9bcf">&quot;license&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;MIT&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain">    </span><span class="token property" style="color:#5a9bcf">&quot;authors&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">23</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">24</span><span class="token plain">            </span><span class="token property" style="color:#5a9bcf">&quot;name&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;Matthew Daly&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">25</span><span class="token plain">            </span><span class="token property" style="color:#5a9bcf">&quot;email&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;matthewbdaly@gmail.com&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">26</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">27</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">28</span><span class="token plain">    </span><span class="token property" style="color:#5a9bcf">&quot;autoload&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">29</span><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;psr-4&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">30</span><span class="token plain">            </span><span class="token property" style="color:#5a9bcf">&quot;Matthewbdaly\\Postcode\\&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;src/&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">31</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">32</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">33</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">Note that we don&#x27;t install an actual HTTPlug client, other than the mock one, which is only useful for testing. This is deliberate - we&#x27;re giving developers working with this library the choice of working with whatever HTTP client they see fit. We do use the Guzzle PSR7 library, but that&#x27;s just for the PSR7 library.</p><p class="py-2">Then we install our dependencies:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style"></span><span class="token plain">$ </span><span class="token function" style="color:#79b6f2">composer</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">install</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">We also need to tell PHPSpec what our namespace will be. Save this as <code>phpspec.yml</code>:</p><pre><div class="gatsby-highlight" data-language="yml"><pre class="prism-code language-yml" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token key atrule">suites</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">    </span><span class="token key atrule">test_suite</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">        </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> Matthewbdaly\Postcode</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">        </span><span class="token key atrule">psr4_prefix</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> Matthewbdaly\Postcode</span></div></pre></div></pre><p class="py-2">Don&#x27;t forget to update the namespace in both files to whatever you&#x27;re using, which should have a vendor name and a package name.</p><p class="py-2">With that done, it&#x27;s time to introduce the next component.</p><h2 class="py-4 text-2xl font-bold">Introducing HTTPlug</h2><p class="py-2">In the past I&#x27;ve usually used either Curl or Guzzle to carry out HTTP requests. However, the problem with this approach is that you&#x27;re forcing whoever uses your library to use whatever HTTP client, and whatever version of that client, that you deem appropriate. If they&#x27;re also using another library that someone else has written and they made different choices, you could have problems.</p><p class="py-2">HTTPlug is an excellent way of solving this problem. By requiring only an interface and not a concrete implementation, using HTTPlug means that you can specify that the consumer of the library must provide a suitable implementation of that library, but leave the choice of implementation up to them. This means that they can choose whatever implementation best fits their use case. There are <a href="http://docs.php-http.org/en/latest/clients.html" class="border-b-2 border-green-400">adapters for many different clients</a>, so it&#x27;s unlikely that they won&#x27;t be able to find one that meets their needs.</p><p class="py-2">In addition, HTTPlug provides the means to automatically determine what HTTP client to use, so that if one is not explicitly provided, it can be resolved without any action on the part of the developer. As long as a suitable HTTP adapter is installed, it will be used.</p><h2 class="py-4 text-2xl font-bold">Getting started</h2><p class="py-2">One advantage of PHPSpec is that it will automatically generate much of the boilerplate for our client and specs. To create our client spec, run this command:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec desc Matthewbdaly/Postcode/Client</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">Specification </span><span class="token keyword" style="color:#c5a5c5">for</span><span class="token plain"> Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client created </span><span class="token keyword" style="color:#c5a5c5">in</span><span class="token plain"> /home/matthew/Projects/postcode-client/spec/ClientSpec.php.</span></div></pre></div></pre><p class="py-2">Now that we have a spec for our client, we can generate the client itself:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">Matthewbdaly/Postcode/Client                                                    </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">11</span><span class="token plain">  - it is initializable</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">      class Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client does not exist.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">                                      </span><span class="token number" style="color:#5a9bcf">100</span><span class="token plain">%                                       </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> example </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> broken</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">14ms</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">                                                                                </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">  Do you want me to create </span><span class="token variable" style="color:#d7deea">`</span><span class="token variable" style="color:#d7deea">Matthewbdaly</span><span class="token variable punctuation" style="color:#8dc891">\</span><span class="token variable" style="color:#d7deea">Postcode</span><span class="token variable punctuation" style="color:#8dc891">\</span><span class="token variable" style="color:#d7deea">Client</span><span class="token variable" style="color:#d7deea">`</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">for</span><span class="token plain"> you?              </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">                                                                         </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">Y/n</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">y</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">Class Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client created </span><span class="token keyword" style="color:#c5a5c5">in</span><span class="token plain"> /home/matthew/Projects/postcode-client/src/Client.php.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain">                                      </span><span class="token number" style="color:#5a9bcf">100</span><span class="token plain">%                                       </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> example </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain">16ms</span></div></pre></div></pre><p class="py-2">You will need to enter <code>Y</code> when prompted. We now have an empty class for our client.</p><p class="py-2">Next, we need to make sure that the constructor for our client accepts two parameters:</p><ul class="py-2 pl-4"><li class="list-disc">The HTTP client</li><li class="list-disc">A message factory instance, which is used to create the request</li></ul><p class="py-2">Amend <code>spec/ClientSpec.php</code> as follows:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token delimiter important" style="font-weight:400">&lt;?php</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">namespace</span><span class="token plain"> </span><span class="token package">spec</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Matthewbdaly</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Postcode</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Matthewbdaly</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Postcode</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Client</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">PhpSpec</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">ObjectBehavior</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Prophecy</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Argument</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Client</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">HttpClient</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Message</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">MessageFactory</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">class</span><span class="token plain"> </span><span class="token class-name" style="color:#FAC863">ClientSpec</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#FAC863">ObjectBehavior</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">let </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token class-name type-declaration" style="color:#FAC863">HttpClient</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$client</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">MessageFactory</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">beConstructedWith</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$client</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">it_is_initializable</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldHaveType</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token class-name static-context" style="color:#FAC863">Client</span><span class="token operator" style="color:#d7deea">::</span><span class="token keyword" style="color:#c5a5c5">class</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">Note the use of the <code>let()</code> method here. This lets us specify how the object is constructed, with the <code>beConstructedWith()</code> method. Also, note that <code>$this</code> refers not to the test, but to the object being tested - this takes a bit of getting used to if you&#x27;re used to working with PHPUnit.</p><p class="py-2">Also, note that the objects passed through are not actual instances of those objects - instead they are mocks created automatically by PHPSpec. This makes mocking extremely easy, and you can easily set up your own expectations on those mock objects in the test. If you want to use a real object, you can instantiate it in the spec as usual. If we need any other mocks, we can typehint them in our method in exactly the same way.</p><p class="py-2">If we once again use <code>vendor/bin/phpspec run</code> we can now generate a constructor:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">Matthewbdaly/Postcode/Client                                                    </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">18</span><span class="token plain">  - it is initializable</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">      method Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client::__construct not found.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">                                      </span><span class="token number" style="color:#5a9bcf">100</span><span class="token plain">%                                       </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> example </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> broken</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">281ms</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">                                                                                </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">  Do you want me to create </span><span class="token variable" style="color:#d7deea">`</span><span class="token variable" style="color:#d7deea">Matthewbdaly</span><span class="token variable punctuation" style="color:#8dc891">\</span><span class="token variable" style="color:#d7deea">Postcode</span><span class="token variable punctuation" style="color:#8dc891">\</span><span class="token variable" style="color:#d7deea">Client::__construct</span><span class="token variable punctuation" style="color:#8dc891">(</span><span class="token variable punctuation" style="color:#8dc891">)</span><span class="token variable" style="color:#d7deea">`</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">for</span><span class="token plain">    </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">  you?                                                                          </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">                                                                         </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">Y/n</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">y</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">  Method Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client::__construct</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> has been created.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain">  </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">                                      </span><span class="token number" style="color:#5a9bcf">100</span><span class="token plain">%                                       </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> example </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">50ms</span></div></pre></div></pre><p class="py-2">This will only create a placeholder for the constructor. You need to populate it yourself, so update <code>src/Client.php</code> as follows:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token delimiter important" style="font-weight:400">&lt;?php</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">namespace</span><span class="token plain"> </span><span class="token package">Matthewbdaly</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Postcode</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Client</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">HttpClient</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Discovery</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">HttpClientDiscovery</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Message</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">MessageFactory</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Discovery</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">MessageFactoryDiscovery</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">class</span><span class="token plain"> </span><span class="token class-name" style="color:#FAC863">Client</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">__construct</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token class-name type-declaration" style="color:#FAC863">HttpClient</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$client</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token constant" style="color:#5a9bcf">null</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">MessageFactory</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token constant" style="color:#5a9bcf">null</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token property" style="color:#5a9bcf">client</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$client</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">?</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token class-name static-context" style="color:#FAC863">HttpClientDiscovery</span><span class="token operator" style="color:#d7deea">::</span><span class="token function" style="color:#79b6f2">find</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token property" style="color:#5a9bcf">messageFactory</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">?</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token class-name static-context" style="color:#FAC863">MessageFactoryDiscovery</span><span class="token operator" style="color:#d7deea">::</span><span class="token function" style="color:#79b6f2">find</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">A little explanation is called for here. We need two arguments in our construct:</p><ul class="py-2 pl-4"><li class="list-disc">An instance of <code>Http\Client\HttpClient</code> to send the request</li><li class="list-disc">An instance of <code>Http\Message\MessageFactory</code> to create the request</li></ul><p class="py-2">However, we don&#x27;t want to force the user to create one. Therefore if they are not set, we use <code>Http\Discovery\HttpClientDiscovery</code> and <code>Http\Discovery\MessageFactoryDiscovery</code> to create them for us.</p><p class="py-2">If we re-run PHPSpec, it should now pass:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">                                      </span><span class="token number" style="color:#5a9bcf">100</span><span class="token plain">%                                       </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> example </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">31ms</span></div></pre></div></pre><p class="py-2">Next, we want to have a method for retrieving the endpoint. Add the following method to <code>spec/ClientSpec.php</code>:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">it_can_retrieve_the_base_url</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getBaseUrl</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;https://api.ideal-postcodes.co.uk/v1/postcodes/&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">Here we&#x27;re asserting that fetching the base URL returns the given result. Note how much simpler and more intuitive this syntax is than PHPUnit would be:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style"></span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">assertEquals</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;https://api.ideal-postcodes.co.uk/v1/postcodes/&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$client</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getBaseUrl</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">Running the tests again should prompt us to create the boilerplate for the new method:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">Matthewbdaly/Postcode/Client                                                      </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">23</span><span class="token plain">  - it can retrieve the base url</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">      method Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client::getBaseUrl not found.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">                  </span><span class="token number" style="color:#5a9bcf">50</span><span class="token plain">%                                     </span><span class="token number" style="color:#5a9bcf">50</span><span class="token plain">%                    </span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> passed, </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> broken</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">40ms</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">                                                                                </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">  Do you want me to create </span><span class="token variable" style="color:#d7deea">`</span><span class="token variable" style="color:#d7deea">Matthewbdaly</span><span class="token variable punctuation" style="color:#8dc891">\</span><span class="token variable" style="color:#d7deea">Postcode</span><span class="token variable punctuation" style="color:#8dc891">\</span><span class="token variable" style="color:#d7deea">Client::getBaseUrl</span><span class="token variable punctuation" style="color:#8dc891">(</span><span class="token variable punctuation" style="color:#8dc891">)</span><span class="token variable" style="color:#d7deea">`</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">for</span><span class="token plain">     </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">  you?                                                                          </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">                                                                         </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">Y/n</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">y</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">  Method Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client::getBaseUrl</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> has been created.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain">  </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">Matthewbdaly/Postcode/Client                                                      </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">23</span><span class="token plain">  - it can retrieve the base url</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain">      expected </span><span class="token string" style="color:#8dc891">&quot;https://api.ideal-postcod...&quot;</span><span class="token plain">, but got null.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain">                  </span><span class="token number" style="color:#5a9bcf">50</span><span class="token plain">%                                     </span><span class="token number" style="color:#5a9bcf">50</span><span class="token plain">%                    </span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">23</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">24</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> passed, </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> failed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">25</span><span class="token plain">72ms</span></div></pre></div></pre><p class="py-2">Now we need to update that method to work as expected:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">protected</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$baseUrl</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;https://api.ideal-postcodes.co.uk/v1/postcodes/&#x27;</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">     </span><span class="token operator" style="color:#d7deea">...</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">getBaseUrl</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token property" style="color:#5a9bcf">baseUrl</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">This should make the tests pass:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">                                      </span><span class="token number" style="color:#5a9bcf">100</span><span class="token plain">%                                       </span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">34ms</span></div></pre></div></pre><p class="py-2">Next, we need to be able to get and set the API key. Add the following to <code>spec/ClientSpec.php</code>:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">it_can_get_and_set_the_key</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token constant" style="color:#5a9bcf">null</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">setKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;foo&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$this</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;foo&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">Note that we expect <code>$this-&gt;setKey(&#x27;foo&#x27;)</code> to return <code>$this</code>. This is an example of a <em>fluent</em> interface - by returning an instance of the object, it enables methods to be chained, eg <code>$client-&gt;setKey(&#x27;foo&#x27;)-&gt;get()</code>. Obviously it won&#x27;t work for anything that has to return a value, but it&#x27;s a useful way of making your classes more intuitive to use.</p><p class="py-2">Next, run the tests again and agree to the prompts as before:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">Matthewbdaly/Postcode/Client                                                      </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">28</span><span class="token plain">  - it can get and </span><span class="token builtin class-name" style="color:#FAC863">set</span><span class="token plain"> the key</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">      method Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client::getKey not found.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">                         </span><span class="token number" style="color:#5a9bcf">66</span><span class="token plain">%                                     </span><span class="token number" style="color:#5a9bcf">33</span><span class="token plain">%             </span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"> passed, </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> broken</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">51ms</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">                                                                                </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">  Do you want me to create </span><span class="token variable" style="color:#d7deea">`</span><span class="token variable" style="color:#d7deea">Matthewbdaly</span><span class="token variable punctuation" style="color:#8dc891">\</span><span class="token variable" style="color:#d7deea">Postcode</span><span class="token variable punctuation" style="color:#8dc891">\</span><span class="token variable" style="color:#d7deea">Client::getKey</span><span class="token variable punctuation" style="color:#8dc891">(</span><span class="token variable punctuation" style="color:#8dc891">)</span><span class="token variable" style="color:#d7deea">`</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">for</span><span class="token plain"> you?    </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">                                                                         </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">Y/n</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">y</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">  Method Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client::getKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> has been created.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">  </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain">Matthewbdaly/Postcode/Client                                                      </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">28</span><span class="token plain">  - it can get and </span><span class="token builtin class-name" style="color:#FAC863">set</span><span class="token plain"> the key</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">      method Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client::setKey not found.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">                         </span><span class="token number" style="color:#5a9bcf">66</span><span class="token plain">%                                     </span><span class="token number" style="color:#5a9bcf">33</span><span class="token plain">%             </span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">23</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"> passed, </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> broken</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">24</span><span class="token plain">43ms</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">25</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">26</span><span class="token plain">                                                                                </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">27</span><span class="token plain">  Do you want me to create </span><span class="token variable" style="color:#d7deea">`</span><span class="token variable" style="color:#d7deea">Matthewbdaly</span><span class="token variable punctuation" style="color:#8dc891">\</span><span class="token variable" style="color:#d7deea">Postcode</span><span class="token variable punctuation" style="color:#8dc891">\</span><span class="token variable" style="color:#d7deea">Client::setKey</span><span class="token variable punctuation" style="color:#8dc891">(</span><span class="token variable punctuation" style="color:#8dc891">)</span><span class="token variable" style="color:#d7deea">`</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">for</span><span class="token plain"> you?    </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">28</span><span class="token plain">                                                                         </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">Y/n</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">29</span><span class="token plain">y</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">30</span><span class="token plain">  Method Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client::setKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> has been created.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">31</span><span class="token plain">  </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">32</span><span class="token plain">Matthewbdaly/Postcode/Client                                                      </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">33</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">28</span><span class="token plain">  - it can get and </span><span class="token builtin class-name" style="color:#FAC863">set</span><span class="token plain"> the key</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">34</span><span class="token plain">      expected </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">obj:Matthewbdaly</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Postcode</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Client</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain">, but got null.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">35</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">36</span><span class="token plain">                         </span><span class="token number" style="color:#5a9bcf">66</span><span class="token plain">%                                     </span><span class="token number" style="color:#5a9bcf">33</span><span class="token plain">%             </span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">37</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">38</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"> passed, </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> failed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">39</span><span class="token plain">52ms</span></div></pre></div></pre><p class="py-2">Next, add our getter and setter for the key, as well as declaring the property <code>$key</code>:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">protected</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$key</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">getKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token property" style="color:#5a9bcf">key</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">setKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token keyword type-hint" style="color:#c5a5c5">string</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$key</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token property" style="color:#5a9bcf">key</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$key</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">That should make the tests pass:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">                                      </span><span class="token number" style="color:#5a9bcf">100</span><span class="token plain">%                                       </span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">38ms</span></div></pre></div></pre><p class="py-2">With that done, our final task is to be able to handle sending requests. Add the following imports at the top of <code>spec/ClientSpec.php</code>:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Psr</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Message</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">RequestInterface</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Psr</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Message</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">ResponseInterface</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Psr</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Message</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">StreamInterface</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">And add the following method at the bottom of the same file:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">it_can_send_the_request</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token class-name type-declaration" style="color:#FAC863">HttpClient</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$client</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">MessageFactory</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">RequestInterface</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">ResponseInterface</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">StreamInterface</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$stream</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">beConstructedWith</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$client</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">setKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;foo&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$data</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">json_encode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">            </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;result&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;postcode&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;SW1A 2AA&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;postcode_inward&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;2AA&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;postcode_outward&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;SW1A&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;post_town&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;LONDON&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;dependant_locality&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;double_dependant_locality&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;thoroughfare&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;Downing Street&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;dependant_thoroughfare&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;building_number&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;10&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;building_name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;sub_building_name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;po_box&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;department_name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;organisation_name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;Prime Minister &amp; First Lord Of The Treasury&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;udprn&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">23747771</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;umprn&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">23</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;postcode_type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;L&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">24</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;su_organisation_indicator&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">25</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;delivery_point_suffix&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;1A&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">26</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;line_1&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;Prime Minister &amp; First Lord Of The Treasury&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">27</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;line_2&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;10 Downing Street&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">28</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;line_3&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">29</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;premise&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;10&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">30</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;longitude&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">-</span><span class="token number" style="color:#5a9bcf">0.127695242183412</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">31</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;latitude&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">51.5035398826274</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">32</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;eastings&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">530047</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">33</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;northings&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">179951</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">34</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;country&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;England&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">35</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;traditional_county&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;Greater London&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">36</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;administrative_county&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">37</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;postal_county&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;London&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">38</span><span class="token plain">                </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;county&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token string double-quoted-string" style="color:#8dc891">&quot;London&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">39</span><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">40</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">41</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">createRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token constant" style="color:#5a9bcf">null</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;1.1&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">willReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">42</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$client</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">sendRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">willReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">43</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getStatusCode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">willReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">200</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">44</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getBody</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">willReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$stream</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">45</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$stream</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getContents</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">willReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$data</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">46</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">get</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;SW1A 2AA&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldBeLike</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token function" style="color:#79b6f2">json_decode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$data</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token constant boolean" style="color:#ff8b50">true</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">47</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">This test is by far the biggest so far, so it merits some degree of explanation.</p><p class="py-2">Note that we don&#x27;t make a real HTTP request against the API. This may sound strange, but bear with me. We have no control whatsoever over that API, and it could in theory become inaccessible or be subject to breaking changes at any time. We also don&#x27;t want to be shelling out for a paid service just to test our API client works. All we can do is test that our implementation will send the request we expect it to send - we don&#x27;t want our test suite reporting a bug when the API goes down.</p><p class="py-2">We therefore typehint not just the dependencies for the constructor, but a request, response and stream instance. We mock our our responses from those instances using the <code>willReturn()</code> method, so we have complete control over what we pass to our client. That way we can return any appropriate response or throw any exception we deem fit to test the behaviour under those circumstances. For the message factory, we specify what arguments it should receive to create the request, and return our mocked-out request object.</p><p class="py-2">Also, note we use <code>shouldBeLike()</code> to verify the response - this is effectively using the <code>==</code> operator, whereas <code>shouldBe()</code> uses the <code>===</code> operator, making it stricter.</p><p class="py-2">Let&#x27;s run the tests, and don&#x27;t forget the prompt:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">bin</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">Matthewbdaly</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">Postcode</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">Client                                                      </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">38</span><span class="token plain">  </span><span class="token operator" style="color:#d7deea">-</span><span class="token plain"> it can send the request</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">      method </span><span class="token class-name class-name-fully-qualified static-context" style="color:#FAC863">Matthewbdaly</span><span class="token class-name class-name-fully-qualified static-context punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified static-context" style="color:#FAC863">Postcode</span><span class="token class-name class-name-fully-qualified static-context punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified static-context" style="color:#FAC863">Client</span><span class="token operator" style="color:#d7deea">::</span><span class="token plain">get not found</span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">                            </span><span class="token number" style="color:#5a9bcf">75</span><span class="token operator" style="color:#d7deea">%</span><span class="token plain">                                     </span><span class="token number" style="color:#5a9bcf">25</span><span class="token operator" style="color:#d7deea">%</span><span class="token plain">          </span><span class="token number" style="color:#5a9bcf">4</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">4</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> broken</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">55</span><span class="token plain">ms</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">                                                                                </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">  </span><span class="token keyword" style="color:#c5a5c5">Do</span><span class="token plain"> you want me to create </span><span class="token string backtick-quoted-string" style="color:#8dc891">`Matthewbdaly\Postcode\Client::get()`</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">for</span><span class="token plain"> you</span><span class="token operator" style="color:#d7deea">?</span><span class="token plain">       </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">                                                                         </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token constant" style="color:#5a9bcf">Y</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">n</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">y</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">  Method </span><span class="token class-name class-name-fully-qualified static-context" style="color:#FAC863">Matthewbdaly</span><span class="token class-name class-name-fully-qualified static-context punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified static-context" style="color:#FAC863">Postcode</span><span class="token class-name class-name-fully-qualified static-context punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified static-context" style="color:#FAC863">Client</span><span class="token operator" style="color:#d7deea">::</span><span class="token function" style="color:#79b6f2">get</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> has been created</span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">  </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain">Matthewbdaly</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">Postcode</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">Client                                                      </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">38</span><span class="token plain">  </span><span class="token operator" style="color:#d7deea">-</span><span class="token plain"> it can send the request</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">      expected </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token keyword type-declaration" style="color:#c5a5c5">array</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token number" style="color:#5a9bcf">1</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> but got </span><span class="token constant" style="color:#5a9bcf">null</span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">                            </span><span class="token number" style="color:#5a9bcf">75</span><span class="token operator" style="color:#d7deea">%</span><span class="token plain">                                     </span><span class="token number" style="color:#5a9bcf">25</span><span class="token operator" style="color:#d7deea">%</span><span class="token plain">          </span><span class="token number" style="color:#5a9bcf">4</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">23</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">4</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> failed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">24</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">56</span><span class="token plain">ms</span></div></pre></div></pre><p class="py-2">Now we can implement the <code>get()</code> method:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">get</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token keyword type-hint" style="color:#c5a5c5">string</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$postcode</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$url</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getBaseUrl</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">rawurlencode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$postcode</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;?&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">http_build_query</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">            </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;api_key&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$request</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token property" style="color:#5a9bcf">messageFactory</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">createRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain">            </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain">            </span><span class="token variable" style="color:#d7deea">$url</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">            </span><span class="token constant" style="color:#5a9bcf">null</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">            </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;1.1&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token property" style="color:#5a9bcf">client</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">sendRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$data</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">json_decode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getBody</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getContents</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token constant boolean" style="color:#ff8b50">true</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$data</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">We first build up our URL, before using the message factory to create a request object. We then pass the built request to our client to send, before decoding the response into the format we want.</p><p class="py-2">This should make our tests pass:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">                                      </span><span class="token number" style="color:#5a9bcf">100</span><span class="token plain">%                                       </span><span class="token number" style="color:#5a9bcf">4</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">4</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">4</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">307ms</span></div></pre></div></pre><p class="py-2">Our client now works, but there are a couple of situations we need to account for. First, the API will raise a 402 if you make a request for a real postcode without having paid. We need to catch this and throw an exception. Add this to <code>spec/ClientSpec.php</code>:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Matthewbdaly</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Postcode</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Exceptions</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">PaymentRequired</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">    </span><span class="token operator" style="color:#d7deea">...</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">it_throws_an_exception_if_payment_required</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token class-name type-declaration" style="color:#FAC863">HttpClient</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$client</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">MessageFactory</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">RequestInterface</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">ResponseInterface</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">StreamInterface</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$stream</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">beConstructedWith</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$client</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">setKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;foo&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">createRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token constant" style="color:#5a9bcf">null</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;1.1&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">willReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$client</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">sendRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">willReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getStatusCode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">willReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">402</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldThrow</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token class-name static-context" style="color:#FAC863">PaymentRequired</span><span class="token operator" style="color:#d7deea">::</span><span class="token keyword" style="color:#c5a5c5">class</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">duringGet</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;SW1A 2AA&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">With that done, run the tests again:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">Matthewbdaly/Postcode/Client                                                      </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">87</span><span class="token plain">  - it throws an exception </span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token plain"> payment required</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">      expected exception of class </span><span class="token string" style="color:#8dc891">&quot;Matthewbdaly\Postcode</span><span class="token string entity" style="color:#d7deea">\E</span><span class="token string" style="color:#8dc891">xc...&quot;</span><span class="token plain">, but got</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">      </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">exc:Prophecy</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Exception</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Call</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">UnexpectedCallException</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">&quot;Method call:</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token string" style="color:#8dc891">        - getBody()</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token string" style="color:#8dc891">      on Double\ResponseInterface\P15 was not expected, expected calls were:</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token string" style="color:#8dc891">        - getStatusCode()&quot;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain">.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">                              </span><span class="token number" style="color:#5a9bcf">80</span><span class="token plain">%                                     </span><span class="token number" style="color:#5a9bcf">20</span><span class="token plain">%        </span><span class="token number" style="color:#5a9bcf">5</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">5</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">4</span><span class="token plain"> passed, </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> failed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">130ms</span></div></pre></div></pre><p class="py-2">Let&#x27;s amend the client to throw this exception:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Matthewbdaly</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Postcode</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Exceptions</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">PaymentRequired</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">    </span><span class="token operator" style="color:#d7deea">...</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">get</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token keyword type-hint" style="color:#c5a5c5">string</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$postcode</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$url</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getBaseUrl</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">rawurlencode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$postcode</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;?&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">http_build_query</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain">            </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;api_key&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$request</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token property" style="color:#5a9bcf">messageFactory</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">createRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">            </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">            </span><span class="token variable" style="color:#d7deea">$url</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">            </span><span class="token constant" style="color:#5a9bcf">null</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">            </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;1.1&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token property" style="color:#5a9bcf">client</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">sendRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getStatusCode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">==</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">402</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">            </span><span class="token keyword" style="color:#c5a5c5">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">new</span><span class="token plain"> </span><span class="token class-name" style="color:#FAC863">PaymentRequired</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$data</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">json_decode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getBody</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getContents</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token constant boolean" style="color:#ff8b50">true</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$data</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">23</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">And let&#x27;s re-run the tests:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">Matthewbdaly/Postcode/Client                                                    </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">87</span><span class="token plain">  - it throws an exception </span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token plain"> payment required</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">      expected exception of class </span><span class="token string" style="color:#8dc891">&quot;Matthewbdaly\Postcode</span><span class="token string entity" style="color:#d7deea">\E</span><span class="token string" style="color:#8dc891">xc...&quot;</span><span class="token plain">, but got </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">obj:Error</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> with the</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">      message: </span><span class="token string" style="color:#8dc891">&quot;Class &#x27;Matthewbdaly\Postcode</span><span class="token string entity" style="color:#d7deea">\E</span><span class="token string" style="color:#8dc891">xceptions\PaymentRequired&#x27; not found&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain">                              </span><span class="token number" style="color:#5a9bcf">80</span><span class="token plain">%                                     </span><span class="token number" style="color:#5a9bcf">20</span><span class="token plain">%        </span><span class="token number" style="color:#5a9bcf">5</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">5</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">4</span><span class="token plain"> passed, </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> failed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">389ms</span></div></pre></div></pre><p class="py-2">It fails now because the exception doesn&#x27;t exist. Let&#x27;s create it at <code>src/Exceptions/PaymentRequired.php</code>:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token delimiter important" style="font-weight:400">&lt;?php</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">namespace</span><span class="token plain"> </span><span class="token package">Matthewbdaly</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Postcode</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Exceptions</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">class</span><span class="token plain"> </span><span class="token class-name" style="color:#FAC863">PaymentRequired</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">extends</span><span class="token plain"> </span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">Exception</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">That should be enough to make our tests pass:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">                                      </span><span class="token number" style="color:#5a9bcf">100</span><span class="token plain">%                                       </span><span class="token number" style="color:#5a9bcf">5</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">5</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">5</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">89ms</span></div></pre></div></pre><p class="py-2">We also need to raise an exception when the postcode is not found, which raises a 404 error. Add the following spec:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Matthewbdaly</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Postcode</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Exceptions</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">PostcodeNotFound</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">    </span><span class="token operator" style="color:#d7deea">...</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">it_throws_an_exception_if_postcode_not_found</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token class-name type-declaration" style="color:#FAC863">HttpClient</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$client</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">MessageFactory</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">RequestInterface</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">ResponseInterface</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">StreamInterface</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$stream</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">beConstructedWith</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$client</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">setKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;foo&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$messageFactory</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">createRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token constant" style="color:#5a9bcf">null</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;1.1&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">willReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$client</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">sendRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">willReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getStatusCode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">willReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">404</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldThrow</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token class-name static-context" style="color:#FAC863">PostcodeNotFound</span><span class="token operator" style="color:#d7deea">::</span><span class="token keyword" style="color:#c5a5c5">class</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">duringGet</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;SW1A 2AA&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">Run the tests:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">Matthewbdaly/Postcode/Client                                                    </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">98</span><span class="token plain">  - it throws an exception </span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token plain"> postcode not found</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">      expected exception of class </span><span class="token string" style="color:#8dc891">&quot;Matthewbdaly\Postcode</span><span class="token string entity" style="color:#d7deea">\E</span><span class="token string" style="color:#8dc891">xc...&quot;</span><span class="token plain">, but got</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">      </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">exc:Prophecy</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Exception</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">Call</span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain">UnexpectedCallException</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">&quot;Method call:</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token string" style="color:#8dc891">        - getBody()</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token string" style="color:#8dc891">      on Double\ResponseInterface\P20 was not expected, expected calls were:</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token string" style="color:#8dc891">        - getStatusCode()&quot;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain">.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">                                </span><span class="token number" style="color:#5a9bcf">83</span><span class="token plain">%                                     </span><span class="token number" style="color:#5a9bcf">16</span><span class="token plain">%      </span><span class="token number" style="color:#5a9bcf">6</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">6</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">5</span><span class="token plain"> passed, </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> failed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">538ms</span></div></pre></div></pre><p class="py-2">This time we&#x27;ll create the exception class before updating the client. Create the following class at <code>src/Exceptions/PostcodeNotFound.php</code>:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token delimiter important" style="font-weight:400">&lt;?php</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">namespace</span><span class="token plain"> </span><span class="token package">Matthewbdaly</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Postcode</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Exceptions</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain"></span><span class="token comment" style="color:#999999">/**</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token comment" style="color:#999999"> * Postcode not found exception</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token comment" style="color:#999999"> *</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token comment" style="color:#999999"> */</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">class</span><span class="token plain"> </span><span class="token class-name" style="color:#FAC863">PostcodeNotFound</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">extends</span><span class="token plain"> </span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">Exception</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">And update the client:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Matthewbdaly</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Postcode</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Exceptions</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">PostcodeNotFound</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">    </span><span class="token operator" style="color:#d7deea">...</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">get</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token keyword type-hint" style="color:#c5a5c5">string</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$postcode</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$url</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getBaseUrl</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">rawurlencode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$postcode</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;?&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">.</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">http_build_query</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain">            </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;api_key&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getKey</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$request</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token property" style="color:#5a9bcf">messageFactory</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">createRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">            </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">            </span><span class="token variable" style="color:#d7deea">$url</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">            </span><span class="token constant" style="color:#5a9bcf">null</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">            </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;1.1&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token property" style="color:#5a9bcf">client</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">sendRequest</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getStatusCode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">==</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">402</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain">            </span><span class="token keyword" style="color:#c5a5c5">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">new</span><span class="token plain"> </span><span class="token class-name" style="color:#FAC863">PaymentRequired</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getStatusCode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">==</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">404</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain">            </span><span class="token keyword" style="color:#c5a5c5">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">new</span><span class="token plain"> </span><span class="token class-name" style="color:#FAC863">PostcodeNotFound</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$data</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">json_decode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getBody</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getContents</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token constant boolean" style="color:#ff8b50">true</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">23</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$data</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">24</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">Re-run the tests:</p><pre><div class="gatsby-highlight" data-language="bash"><pre class="prism-code language-bash" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token plain">$ vendor/bin/phpspec run</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain">                                      </span><span class="token number" style="color:#5a9bcf">100</span><span class="token plain">%                                       </span><span class="token number" style="color:#5a9bcf">6</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> specs</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain"></span><span class="token number" style="color:#5a9bcf">6</span><span class="token plain"> examples </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">6</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain">103ms</span></div></pre></div></pre><p class="py-2">And our API client is feature complete! You can find the source code of the finished client <a href="https://github.com/matthewbdaly/postcode-client" class="border-b-2 border-green-400">here</a>.</p><h2 class="py-4 text-2xl font-bold">Summary</h2><p class="py-2">Personally, I find that while PHPSpec isn&#x27;t appropriate for every use case, it&#x27;s particularly handy for API clients and it&#x27;s generally my go-to testing solution for them. It handles producing a lot of the boilerplate for me, and it results in a much better workflow for test-driven development as it makes it very natural to write the test first, then make it pass.</p><p class="py-2">HTTPlug has been a revelation for me. While it takes a bit of getting used to if you&#x27;re used to something like Guzzle, it means that you&#x27;re giving consumers of your library the freedom to choose the HTTP client of their choice, meaning they don&#x27;t have to fight with several different libraries requiring different versions of Guzzle. It also allows for easy resolution of the HTTP client, rather than having to explicitly pass through an instance when instantiating your client. I&#x27;m planning to use it extensively in the future.</p></section><hr/><div class="py-4"><a class="p-category" href="/blog/categories/php/"><span class="inline-block px-4 py-2 my-2 mr-2 text-sm font-bold text-gray-900 bg-purple-200 rounded-full hover:bg-purple-800 hover:text-gray-200 transition-colors duration-500">php</span></a><a class="p-category" href="/blog/categories/tdd/"><span class="inline-block px-4 py-2 my-2 mr-2 text-sm font-bold text-gray-900 bg-purple-200 rounded-full hover:bg-purple-800 hover:text-gray-200 transition-colors duration-500">tdd</span></a><a class="p-category" href="/blog/categories/phpspec/"><span class="inline-block px-4 py-2 my-2 mr-2 text-sm font-bold text-gray-900 bg-purple-200 rounded-full hover:bg-purple-800 hover:text-gray-200 transition-colors duration-500">phpspec</span></a><a class="p-category" href="/blog/categories/http/"><span class="inline-block px-4 py-2 my-2 mr-2 text-sm font-bold text-gray-900 bg-purple-200 rounded-full hover:bg-purple-800 hover:text-gray-200 transition-colors duration-500">http</span></a><a class="p-category" href="/blog/categories/httplug/"><span class="inline-block px-4 py-2 my-2 mr-2 text-sm font-bold text-gray-900 bg-purple-200 rounded-full hover:bg-purple-800 hover:text-gray-200 transition-colors duration-500">httplug</span></a></div><nav class="pt-4 clear-both box-border"><a rel="prev" class="float-left w-1/2 p-2 shadow-sm hover:bg-gray-200 dark:hover:bg-gray-800 transition duration-300 ease-in-out" href="/blog/2017/11/16/creating-custom-assertions-with-phpunit/"><p><strong class="font-bold clear-both">← Previous page</strong></p><p class="pl-6">Creating custom assertions with PHPUnit</p></a><a rel="next" class="float-right w-1/2 p-2 shadow-sm hover:bg-gray-200 dark:hover:bg-gray-800 transition duration-300 ease-in-out" href="/blog/2017/12/02/full-text-search-with-laravel-and-postgresql/"><p><strong>→ Next page</strong></p><p class="pl-6">Full text search with Laravel and PostgreSQL</p></a></nav><div id="disqus_thread"></div></article></main></div><footer class="w-full p-4 text-gray-100 bg-gray-800"><ul class="flex flex-row flex-wrap justify-center w-full p-2 mx-auto text-center md:w-2/3 box-border"><li class="w-1/3 my-2 md:w-1/5"><a href="/posts/1">Blog</a></li><li class="w-1/3 my-2 md:w-1/5"><a href="/about">About</a></li><li class="w-1/3 my-2 md:w-1/5"><a href="https://twitter.com/mattbd">Twitter</a></li><li class="w-1/3 my-2 md:w-1/5"><a href="https://github.com/matthewbdaly">Github</a></li><li class="w-1/3 my-2 md:w-1/5"><a href="/rss.xml">Feed</a></li></ul><div class="w-full p-4 mx-auto text-center md:w-2/3"><p>© Matthew Daly <!-- -->2021</p></div></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-17043630-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-31be65513fba52a5a50c.js"],"app":["/app-5e95bfecb5da57fd1ffa.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-e15fb7b4e4c3e068158e.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-a8bec21bd19e150cd447.js"],"component---src-pages-search-tsx":["/component---src-pages-search-tsx-de35131b8b54d707dd3c.js"],"component---src-templates-404-tsx":["/component---src-templates-404-tsx-1e9ca5e77d61c162fbb8.js"],"component---src-templates-archives-tsx":["/component---src-templates-archives-tsx-df7825ea34c62a098040.js"],"component---src-templates-categories-tsx":["/component---src-templates-categories-tsx-151c44ef3edeea819ec2.js"],"component---src-templates-category-tsx":["/component---src-templates-category-tsx-249488b5bc3e35b8519c.js"],"component---src-templates-chunk-tsx":["/component---src-templates-chunk-tsx-e37127127dfaebd5f552.js"],"component---src-templates-page-tsx":["/component---src-templates-page-tsx-43a798b7c40f1e0cff4e.js"],"component---src-templates-post-tsx":["/component---src-templates-post-tsx-493c03ff50c97c3525f1.js"]};/*]]>*/</script><script src="/polyfill-31be65513fba52a5a50c.js" nomodule=""></script><script src="/component---src-templates-post-tsx-493c03ff50c97c3525f1.js" async=""></script><script src="/7840d69eefded84ab93ff6e879351e9a3a16821f-3cc77dc4aa7437d407dd.js" async=""></script><script src="/15a3be27178e285ff113e12c60c30466a8f4d4c5-26cc17c8e4fe76c4927b.js" async=""></script><script src="/e87769ff526c098a69bffbfff9ee9d57397fcb93-49d3f7242fa2c053e36d.js" async=""></script><script src="/f0e45107-763177929e8eed3c13bb.js" async=""></script><script src="/app-5e95bfecb5da57fd1ffa.js" async=""></script><script src="/532a2f07-672258f0b4da4ed2ff53.js" async=""></script><script src="/framework-cb6229a8adb5817307a4.js" async=""></script><script src="/webpack-runtime-88d477ac36829d76e952.js" async=""></script></body></html>