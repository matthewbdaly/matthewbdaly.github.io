<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta http-equiv="Content-Security-Policy" content="base-uri &#x27;self&#x27;; default-src &#x27;self&#x27; *.google-analytics.com disqus.com *.disqus.com *.disquscdn.com; script-src &#x27;self&#x27; localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com &#x27;unsafe-inline&#x27; &#x27;unsafe-eval&#x27;; style-src &#x27;self&#x27; fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com &#x27;unsafe-inline&#x27;; object-src &#x27;none&#x27;; form-action &#x27;self&#x27;; font-src &#x27;self&#x27; data: fonts.google-apis.com fonts.gstatic.com; connect-src &#x27;self&#x27; ws://localhost:* *.google-analytics.com stats.g.doubleclick.net; img-src &#x27;self&#x27; *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net; child-src &#x27;self&#x27;; frame-src disqus.com *.addthis.com;"/><style data-href="/styles.e9de386fab7f4e2d36e8.css" data-identity="gatsby-global-css">/*! tailwindcss v2.2.15 | MIT License | https://tailwindcss.com */

/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */html{-webkit-text-size-adjust:100%;line-height:1.15;-moz-tab-size:4;-o-tab-size:4;tab-size:4}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;margin:0}hr{color:inherit;height:0}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=submit],button{-webkit-appearance:button}legend{padding:0}progress{vertical-align:baseline}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{border:0 solid;box-sizing:border-box}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{color:inherit;line-height:inherit;padding:0}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}[hidden]{display:none}*,:after,:before{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}.float-right{float:right}.float-left{float:left}.float-none{float:none}.clear-both{clear:both}.m-0{margin:0}.mx-0{margin-left:0;margin-right:0}.mx-auto{margin-left:auto;margin-right:auto}.my-2{margin-bottom:.5rem;margin-top:.5rem}.my-4{margin-bottom:1rem;margin-top:1rem}.mt-2{margin-top:.5rem}.mt-16{margin-top:4rem}.mr-2{margin-right:.5rem}.mr-8{margin-right:2rem}.-mb-4{margin-bottom:-1rem}.-mb-8{margin-bottom:-2rem}.box-border{box-sizing:border-box}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.table{display:table}.hidden{display:none}.h-2{height:.5rem}.h-4{height:1rem}.min-h-screen{min-height:100vh}.w-1\/2{width:50%}.w-1\/3{width:33.333333%}.w-1\/4{width:25%}.w-3\/4{width:75%}.w-full{width:100%}.flex-grow{flex-grow:1}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{opacity:0;transform:scale(2)}}@keyframes ping{75%,to{opacity:0;transform:scale(2)}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}@keyframes bounce{0%,to{-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}.list-disc{list-style-type:disc}.flex-row{flex-direction:row}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.justify-center{justify-content:center}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(2rem*var(--tw-space-y-reverse));margin-top:calc(2rem*(1 - var(--tw-space-y-reverse)))}.space-y-16>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(4rem*var(--tw-space-y-reverse));margin-top:calc(4rem*(1 - var(--tw-space-y-reverse)))}.space-y-32>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(8rem*var(--tw-space-y-reverse));margin-top:calc(8rem*(1 - var(--tw-space-y-reverse)))}.divide-y>:not([hidden])~:not([hidden]){--tw-divide-y-reverse:0;border-bottom-width:calc(1px*var(--tw-divide-y-reverse));border-top-width:calc(1px*(1 - var(--tw-divide-y-reverse)))}.divide-gray-800>:not([hidden])~:not([hidden]){--tw-divide-opacity:1;border-color:rgba(31,41,55,var(--tw-divide-opacity))}@media (prefers-color-scheme:dark){.dark\:divide-gray-200>:not([hidden])~:not([hidden]){--tw-divide-opacity:1;border-color:rgba(229,231,235,var(--tw-divide-opacity))}}.overflow-x-auto{overflow-x:auto}.overflow-x-scroll{overflow-x:scroll}.rounded-full{border-radius:9999px}.rounded-t-lg{border-top-left-radius:.5rem;border-top-right-radius:.5rem}.border-2{border-width:2px}.border-b-2{border-bottom-width:2px}.border-b-4{border-bottom-width:4px}.border-l-8{border-left-width:8px}.border-transparent{border-color:transparent}.border-gray-100{--tw-border-opacity:1;border-color:rgba(243,244,246,var(--tw-border-opacity))}.border-gray-500{--tw-border-opacity:1;border-color:rgba(107,114,128,var(--tw-border-opacity))}.border-gray-800{--tw-border-opacity:1;border-color:rgba(31,41,55,var(--tw-border-opacity))}.border-green-400,.hover\:border-green-400:hover{--tw-border-opacity:1;border-color:rgba(52,211,153,var(--tw-border-opacity))}.focus\:border-blue-300:focus{--tw-border-opacity:1;border-color:rgba(147,197,253,var(--tw-border-opacity))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgba(249,250,251,var(--tw-bg-opacity))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgba(243,244,246,var(--tw-bg-opacity))}.bg-gray-300{--tw-bg-opacity:1;background-color:rgba(209,213,219,var(--tw-bg-opacity))}.bg-gray-800{--tw-bg-opacity:1;background-color:rgba(31,41,55,var(--tw-bg-opacity))}.bg-purple-200{--tw-bg-opacity:1;background-color:rgba(221,214,254,var(--tw-bg-opacity))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgba(229,231,235,var(--tw-bg-opacity))}.hover\:bg-purple-800:hover{--tw-bg-opacity:1;background-color:rgba(91,33,182,var(--tw-bg-opacity))}@media (prefers-color-scheme:dark){.dark\:bg-gray-700{--tw-bg-opacity:1;background-color:rgba(55,65,81,var(--tw-bg-opacity))}.dark\:bg-gray-800{--tw-bg-opacity:1;background-color:rgba(31,41,55,var(--tw-bg-opacity))}.dark\:bg-gray-900{--tw-bg-opacity:1;background-color:rgba(17,24,39,var(--tw-bg-opacity))}.dark\:hover\:bg-gray-800:hover{--tw-bg-opacity:1;background-color:rgba(31,41,55,var(--tw-bg-opacity))}}.bg-gradient-to-r{background-image:linear-gradient(to right,var(--tw-gradient-stops))}.bg-gradient-to-b{background-image:linear-gradient(to bottom,var(--tw-gradient-stops))}.from-gray-200{--tw-gradient-from:#e5e7eb;--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to,rgba(229,231,235,0))}.from-green-400{--tw-gradient-from:#34d399;--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to,rgba(52,211,153,0))}.via-blue-500{--tw-gradient-stops:var(--tw-gradient-from),#3b82f6,var(--tw-gradient-to,rgba(59,130,246,0))}.to-gray-300{--tw-gradient-to:#d1d5db}.to-purple-500{--tw-gradient-to:#8b5cf6}.p-2{padding:.5rem}.p-4{padding:1rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-4{padding-left:1rem;padding-right:1rem}.px-8{padding-left:2rem;padding-right:2rem}.py-2{padding-bottom:.5rem;padding-top:.5rem}.py-4{padding-bottom:1rem}.pt-4,.py-4{padding-top:1rem}.pb-16{padding-bottom:4rem}.pl-4{padding-left:1rem}.pl-6{padding-left:1.5rem}.text-center{text-align:center}.font-sans{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.text-sm{font-size:.875rem;line-height:1.25rem}.text-lg{font-size:1.125rem}.text-lg,.text-xl{line-height:1.75rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.font-semibold{font-weight:600}.font-bold{font-weight:700}.lowercase{text-transform:lowercase}.italic{font-style:italic}.leading-6{line-height:1.5rem}.text-gray-100{--tw-text-opacity:1;color:rgba(243,244,246,var(--tw-text-opacity))}.text-gray-200{--tw-text-opacity:1;color:rgba(229,231,235,var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity))}.text-gray-900{--tw-text-opacity:1;color:rgba(17,24,39,var(--tw-text-opacity))}.hover\:text-gray-200:hover{--tw-text-opacity:1;color:rgba(229,231,235,var(--tw-text-opacity))}@media (prefers-color-scheme:dark){.dark\:text-gray-100{--tw-text-opacity:1;color:rgba(243,244,246,var(--tw-text-opacity))}.dark\:text-gray-200{--tw-text-opacity:1;color:rgba(229,231,235,var(--tw-text-opacity))}.dark\:text-gray-300{--tw-text-opacity:1;color:rgba(209,213,219,var(--tw-text-opacity))}}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}*,:after,:before{--tw-shadow:0 0 #0000}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,0.05)}.shadow-lg,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05)}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}*,:after,:before{--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000}.focus\:ring:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.filter{--tw-blur:var(--tw-empty,/*!*/ /*!*/);--tw-brightness:var(--tw-empty,/*!*/ /*!*/);--tw-contrast:var(--tw-empty,/*!*/ /*!*/);--tw-grayscale:var(--tw-empty,/*!*/ /*!*/);--tw-hue-rotate:var(--tw-empty,/*!*/ /*!*/);--tw-invert:var(--tw-empty,/*!*/ /*!*/);--tw-saturate:var(--tw-empty,/*!*/ /*!*/);--tw-sepia:var(--tw-empty,/*!*/ /*!*/);--tw-drop-shadow:var(--tw-empty,/*!*/ /*!*/);filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.transition{transition-duration:.15s;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.transition-colors{transition-duration:.15s;transition-property:background-color,border-color,color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1)}.duration-300{transition-duration:.3s}.duration-500{transition-duration:.5s}.ease-in-out{transition-timing-function:cubic-bezier(.4,0,.2,1)}code[class*=language-],pre[class*=language-]{display:block}@media (min-width:768px){.md\:float-none{float:none}.md\:block{display:block}.md\:w-2\/3{width:66.666667%}.md\:w-1\/5{width:20%}}@media (min-width:1024px){.lg\:float-right{float:right}.lg\:float-left{float:left}.lg\:mt-4{margin-top:1rem}.lg\:text-left{text-align:left}}.prism-code{-webkit-overflow-scrolling:touch;background-color:transparent;border-radius:.2em;float:left;font-size:1rem;margin-bottom:1rem;margin-top:1rem;overflow:initial;padding-bottom:1rem;padding-top:1rem;position:relative}.prism-code.title{border-radius:0 0 .2em .2em}pre.prism-code{float:left;min-width:100%;overflow:initial;padding:20px}.token{display:inline-block}li>code,p>code{word-wrap:break-word;background:#011627;border-radius:.2em;color:#d6deeb;padding:.2em;white-space:pre-wrap}.gatsby-highlight{-webkit-overflow-scrolling:touch;font-size:1rem;overflow:auto;position:relative}.gatsby-highlight::-webkit-scrollbar{display:none}.gatsby-highlight>code[class*=language-],.gatsby>pre[class*=language-]{-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;overflow-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-break:normal;word-spacing:normal}.gatsby-highlight .token-line{border-left:4px solid transparent;margin-left:-20px;margin-right:-20px}.line-number-style{display:inline-block;opacity:.3;padding-left:1em;padding-right:2em;position:relative;text-align:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1.2em}.gatsby-highlight .token-line.highlight-line{background-color:#023751;border-left:4px solid #029bce}.gatsby-highlight .token-line.highlight-line .line-number-style{left:0;opacity:.5;width:calc(1.2em - 4px)}</style><meta name="generator" content="Gatsby 3.14.0"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="search" type="application/opensearchdescription+xml" crossorigin="anonymous" href="/opensearch.xml"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><title data-react-helmet="true">Testing Laravel Middleware | Matthew Daly</title><link data-react-helmet="true" href="https://matthewdaly.co.uk/blog/2016/11/29/testing-laravel-middleware/" rel="canonical"/><link data-react-helmet="true" href="https://twitter.com/mattbd" rel="me"/><link data-react-helmet="true" href="https://github.com/matthewbdaly" rel="me"/><link data-react-helmet="true" href="mailto:matthew@matthewdaly.co.uk" rel="me"/><link data-react-helmet="true" href="/key.pub" rel="pgpkey"/><link data-react-helmet="true" href="https://webmention.io/matthewdaly.co.uk/xmlrpc" rel="pingback"/><link data-react-helmet="true" href="https://webmention.io/matthewdaly.co.uk/webmention" rel="webmention"/><link data-react-helmet="true" rel="authorization_endpoint" href="https://indieauth.com/auth"/><link data-react-helmet="true" rel="token_endpoint" href="https://tokens.indieauth.com/token"/><link data-react-helmet="true" rel="openid.delegate" href="https://matthewdaly.co.uk"/><link data-react-helmet="true" rel="openid.server" href="https://openid.indieauth.com/openid"/><link data-react-helmet="true" rel="alternate" type="application/rss+xml" title="Matthew Daly - feed" href="/rss.xml"/><link data-react-helmet="true" rel="alternate" type="application/atom+xml" title="Matthew Daly - feed" href="/atom.xml"/><link data-react-helmet="true" rel="alternate" type="application/feed+json" title="Matthew Daly - feed" href="/feed.json"/><meta data-react-helmet="true" name="description" content="It&#x27;s widely accepted that high-level integration tests alone do not make for a good test suite. Ideally each individual component of your application should have unit tests, which…"/><meta data-react-helmet="true" property="og:title" content="Testing Laravel Middleware"/><meta data-react-helmet="true" property="og:description" content="It&#x27;s widely accepted that high-level integration tests alone do not make for a good test suite. Ideally each individual component of your application should have unit tests, which…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="mattbd"/><meta data-react-helmet="true" name="twitter:title" content="Testing Laravel Middleware"/><meta data-react-helmet="true" name="twitter:description" content="It&#x27;s widely accepted that high-level integration tests alone do not make for a good test suite. Ideally each individual component of your application should have unit tests, which…"/><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=53aa06cf17e4239d0dba6ffd09854e02" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#3b82f6"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link as="script" rel="preload" href="/webpack-runtime-c33358236e0b6acb82bb.js"/><link as="script" rel="preload" href="/framework-aeedefbd40854c93cd6e.js"/><link as="script" rel="preload" href="/app-ee7d5025f6bfd6d08ba0.js"/><link as="script" rel="preload" href="/f0e45107-1ab5e6e9877396d2cf44.js"/><link as="script" rel="preload" href="/e87769ff526c098a69bffbfff9ee9d57397fcb93-f80d1b6945cc05a4b927.js"/><link as="script" rel="preload" href="/15a3be27178e285ff113e12c60c30466a8f4d4c5-05c94d59cdf70f961f79.js"/><link as="script" rel="preload" href="/7840d69eefded84ab93ff6e879351e9a3a16821f-3cc77dc4aa7437d407dd.js"/><link as="script" rel="preload" href="/component---src-templates-post-tsx-aaa8214c2c4f236a2974.js"/><link as="fetch" rel="preload" href="/page-data/blog/2016/11/29/testing-laravel-middleware/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/290055352.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2909664151.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="flex flex-col min-h-screen pb-16 font-sans text-lg antialiased text-gray-800 bg-gray-50 dark:text-gray-100 dark:bg-gray-700 leading-6"><div class="w-full h-2 bg-gradient-to-r from-green-400 via-blue-500 to-purple-500"></div><nav class="w-full p-4 mx-auto lowercase md:w-2/3"><h1 class="block float-none py-4 text-4xl text-center lg:float-left lg:text-left"><a href="/">Matthew Daly</a></h1><ul class="py-2 text-center lg:float-right md:block lg:text-left"><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/blog/archives">Archives</a></li><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/about">About</a></li><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/uses">Uses</a></li><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/posts/1">Blog</a></li><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/blog/categories">Categories</a></li><li class="inline-block pr py-2 mr-8 lg:mt-4 text-sm text-gray-900 dark:text-gray-200 border-b-4 border-transparent hover:border-green-400 transition-colors duration-500"><a href="/search">Search</a></li></ul></nav><div class="w-full h-4 clear"></div><main class="flex-grow w-full p-4 mx-auto md:w-2/3"><article class="h-entry"><header><h2 class="py-4 text-2xl font-bold e-content p-name"><a class="u-url" href="https://matthewdaly.co.uk/blog/2016/11/29/testing-laravel-middleware/">Testing Laravel Middleware</a></h2><p class="my-4 text-lg font-semibold">Published by <a href="/" rel="author">Matthew Daly</a> at <!-- -->29th November 2016 11:00 pm</p><time class="hidden dt-published">2016-11-29T23:00:38+00:00</time></header><section><p class="py-2">It&#x27;s widely accepted that high-level integration tests alone do not make for a good test suite. Ideally each individual component of your application should have unit tests, which test that component in isolation. These unit tests are usually much quicker to run, making it easier to practice test-driven development. However, it can sometimes be hard to grasp how to test that one component on its own.</p><p class="py-2">The other day I had an issue with several middleware classes for a Laravel application and I wanted to verify that they were working as expected. Sounds like a job for dedicated unit tests, but I hadn&#x27;t tested custom middleware in isolation before, and figuring out how to do so took a while.</p><p class="py-2">Laravel middleware accepts an instance of <code>Illuminate\Http\Request</code>, itself based on the Symfony request object, as well as a closure for the action to take next. Depending on what the middleware does, it may return a redirect or simply amend the existing request or response. So in theory you can instantiate a request object, pass it to the middleware, and check the response. For middleware that does something simple, such as redirecting users based on certain conditions, this is fairly straightforward.</p><p class="py-2">In this example we have a fairly useless piece of middleware that checks to see what the route is for a request and redirects it if it matches a certain pattern:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token delimiter important" style="font-weight:400">&lt;?php</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">namespace</span><span class="token plain"> </span><span class="token package">App</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Middleware</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Closure</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">class</span><span class="token plain"> </span><span class="token class-name-definition class-name" style="color:#FAC863">RedirectFromAdminMiddleware</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">    </span><span class="token comment" style="color:#999999">/**</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token comment" style="color:#999999">     * Handle an incoming request.</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token comment" style="color:#999999">     *</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token comment" style="color:#999999">     * @param  \Illuminate\Http\Request  $request</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token comment" style="color:#999999">     * @param  \Closure  $next</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token comment" style="color:#999999">     * @return mixed</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token comment" style="color:#999999">     */</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function-definition function" style="color:#79b6f2">handle</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">Closure</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$next</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">is</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;admin*&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">            </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">redirect</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;/&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$next</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">23</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">While this example is of limited use, it wouldn&#x27;t take much work to develop it to redirect conditionally based on an account type, and it&#x27;s simple enough to demonstrate the principles involved. In these tests, we create instances of <code>Illuminate\Http\Request</code> and pass them to the middleware&#x27;s <code>handle()</code> method, along with an empty closure representing the response. If the middleware does not amend the request, we get the empty response from the closure. If it does amend the request, we get a redirect response.</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token delimiter important" style="font-weight:400">&lt;?php</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Illuminate</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Request</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">class</span><span class="token plain"> </span><span class="token class-name-definition class-name" style="color:#FAC863">RedirectFromAdminMiddlewareTest</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#FAC863">TestCase</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function-definition function" style="color:#79b6f2">testRedirectMiddlewareCalledOnAdmin</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Create request</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$request</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token class-name static-context" style="color:#FAC863">Request</span><span class="token operator" style="color:#d7deea">::</span><span class="token function" style="color:#79b6f2">create</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;http://example.com/admin&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Pass it to the middleware</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$middleware</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">new</span><span class="token plain"> </span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">App</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">Http</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">Middleware</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">RedirectFromAdminMiddleware</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$middleware</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">handle</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token punctuation" style="color:#8dc891">}</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">assertEquals</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getStatusCode</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">302</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function-definition function" style="color:#79b6f2">testRedirectMiddlewareNotCalledOnNonAdmin</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Create request</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$request</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token class-name static-context" style="color:#FAC863">Request</span><span class="token operator" style="color:#d7deea">::</span><span class="token function" style="color:#79b6f2">create</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;http://example.com/pages&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">23</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Pass it to the middleware</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">24</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$middleware</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">new</span><span class="token plain"> </span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">App</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">Http</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">Middleware</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">RedirectFromAdminMiddleware</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">25</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$middleware</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">handle</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token punctuation" style="color:#8dc891">}</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">26</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$this</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">assertEquals</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token constant" style="color:#5a9bcf">null</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">27</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">28</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">For middleware that fetches the response and acts on it, things are a little more complex. For instance, this is the Etag middleware I use on many projects:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token delimiter important" style="font-weight:400">&lt;?php</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">namespace</span><span class="token plain"> </span><span class="token package">App</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Middleware</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Closure</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">class</span><span class="token plain"> </span><span class="token class-name-definition class-name" style="color:#FAC863">ETagMiddleware</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token plain">    </span><span class="token comment" style="color:#999999">/**</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token comment" style="color:#999999">     * Implement Etag support</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token comment" style="color:#999999">     *</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token comment" style="color:#999999">     * @param  \Illuminate\Http\Request  $request</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token comment" style="color:#999999">     * @param  \Closure  $next</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token comment" style="color:#999999">     * @return mixed</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token comment" style="color:#999999">     */</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function-definition function" style="color:#79b6f2">handle</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token class-name type-declaration" style="color:#FAC863">Closure</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$next</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Get response</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$next</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// If this was a GET request...</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">isMethod</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;get&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">            </span><span class="token comment" style="color:#999999">// Generate Etag</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain">            </span><span class="token variable" style="color:#d7deea">$etag</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">md5</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getContent</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">23</span><span class="token plain">            </span><span class="token variable" style="color:#d7deea">$requestEtag</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">str_replace</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;&quot;&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$request</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getETags</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">24</span><span class="token plain">            </span><span class="token comment" style="color:#999999">// Check to see if Etag has changed</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">25</span><span class="token plain">            </span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$requestEtag</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">&amp;&amp;</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$requestEtag</span><span class="token punctuation" style="color:#8dc891">[</span><span class="token number" style="color:#5a9bcf">0</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">==</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$etag</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">26</span><span class="token plain">                </span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">setNotModified</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">27</span><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">28</span><span class="token plain">            </span><span class="token comment" style="color:#999999">// Set Etag</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">29</span><span class="token plain">            </span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">setEtag</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$etag</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">30</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">31</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Send response</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">32</span><span class="token plain">        </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">33</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">34</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">This acts on the response object, so we need to pass that through as well. Fortunately, Mockery allows us to create a mock of our response object and set it up to handle only those methods we anticipate being called:</p><pre><div class="gatsby-highlight" data-language="php"><pre class="prism-code language-php" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="line-number-style">1</span><span class="token delimiter important" style="font-weight:400">&lt;?php</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">3</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token package">Illuminate</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Http</span><span class="token package punctuation" style="color:#8dc891">\</span><span class="token package">Request</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">5</span><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">class</span><span class="token plain"> </span><span class="token class-name-definition class-name" style="color:#FAC863">ETagMiddlewareTest</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#FAC863">TestCase</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">6</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">7</span><span class="token plain">    </span><span class="token comment" style="color:#999999">/**</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">8</span><span class="token comment" style="color:#999999">     * Test new request not cached</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">9</span><span class="token comment" style="color:#999999">     *</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">10</span><span class="token comment" style="color:#999999">     * @return void</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">11</span><span class="token comment" style="color:#999999">     */</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">12</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function-definition function" style="color:#79b6f2">testModified</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">13</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">14</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Create mock response</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">15</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token class-name static-context" style="color:#FAC863">Mockery</span><span class="token operator" style="color:#d7deea">::</span><span class="token function" style="color:#79b6f2">mock</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;Illuminate\Http\Response&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldReceive</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;getContent&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">once</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">andReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;blah&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getMock</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">16</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldReceive</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;setEtag&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">with</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token function" style="color:#79b6f2">md5</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;blah&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">17</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">18</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Create request</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">19</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$request</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token class-name static-context" style="color:#FAC863">Request</span><span class="token operator" style="color:#d7deea">::</span><span class="token function" style="color:#79b6f2">create</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;http://example.com/admin&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">20</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">21</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Pass it to the middleware</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">22</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$middleware</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">new</span><span class="token plain"> </span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">App</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">Http</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">Middleware</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">ETagMiddleware</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">23</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$middlewareResponse</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$middleware</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">handle</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"> </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">24</span><span class="token plain">            </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">25</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">26</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">27</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">28</span><span class="token plain">    </span><span class="token comment" style="color:#999999">/**</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">29</span><span class="token comment" style="color:#999999">     * Test repeated request not modified</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">30</span><span class="token comment" style="color:#999999">     *</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">31</span><span class="token comment" style="color:#999999">     * @return void</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">32</span><span class="token comment" style="color:#999999">     */</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">33</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function-definition function" style="color:#79b6f2">testNotModified</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">34</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">35</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Create mock response</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">36</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token class-name static-context" style="color:#FAC863">Mockery</span><span class="token operator" style="color:#d7deea">::</span><span class="token function" style="color:#79b6f2">mock</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;Illuminate\Http\Response&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldReceive</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;getContent&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">once</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">andReturn</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;blah&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">getMock</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">37</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldReceive</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;setEtag&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">with</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token function" style="color:#79b6f2">md5</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;blah&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">38</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$response</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">shouldReceive</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;setNotModified&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">39</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">40</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Create request</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">41</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$request</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token class-name static-context" style="color:#FAC863">Request</span><span class="token operator" style="color:#d7deea">::</span><span class="token function" style="color:#79b6f2">create</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;http://example.com/admin&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">42</span><span class="token plain">            </span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;ETag&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">md5</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string single-quoted-string" style="color:#8dc891">&#x27;blah&#x27;</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">43</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">44</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">45</span><span class="token plain">        </span><span class="token comment" style="color:#999999">// Pass it to the middleware</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">46</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$middleware</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">new</span><span class="token plain"> </span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">App</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">Http</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">Middleware</span><span class="token class-name class-name-fully-qualified punctuation" style="color:#8dc891">\</span><span class="token class-name class-name-fully-qualified" style="color:#FAC863">ETagMiddleware</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">47</span><span class="token plain">        </span><span class="token variable" style="color:#d7deea">$middlewareResponse</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$middleware</span><span class="token operator" style="color:#d7deea">-&gt;</span><span class="token function" style="color:#79b6f2">handle</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$request</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">use</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"> </span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">48</span><span class="token plain">            </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$response</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">49</span><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">50</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">51</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">52</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">public</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function-definition function" style="color:#79b6f2">teardown</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">53</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">54</span><span class="token plain">        </span><span class="token class-name static-context" style="color:#FAC863">Mockery</span><span class="token operator" style="color:#d7deea">::</span><span class="token function" style="color:#79b6f2">close</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">55</span><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div><div class="token-line" style="color:#ffffff"><span class="line-number-style">56</span><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span></div></pre></div></pre><p class="py-2">In the first example we mock out the <code>getContent()</code> and <code>setEtag()</code> methods of our response to make sure they get called, and then pass the request to the middleware, along with a closure that returns the response. In the second example, we also mock out <code>setNotModified()</code> to ensure that the correct status code of 304 is set, and add an ETag to our request. In this way we can easily test our middleware in isolation, rather than having to resort to building up our entire application just to test one small method.</p><p class="py-2">Middleware is a convenient place to put functionality that&#x27;s needed for many routes, but you shouldn&#x27;t neglect testing it, and ideally you shouldn&#x27;t have to resort to writing a slow integration test to test it works as expected. By mocking out your dependencies, it&#x27;s generally not too hard to test it in isolation, resulting in faster and more robust test suites.</p></section><hr/><div class="py-4"><a class="p-category" href="/blog/categories/php/"><span class="inline-block px-4 py-2 my-2 mr-2 text-sm font-bold text-gray-900 bg-purple-200 rounded-full hover:bg-purple-800 hover:text-gray-200 transition-colors duration-500">php</span></a><a class="p-category" href="/blog/categories/laravel/"><span class="inline-block px-4 py-2 my-2 mr-2 text-sm font-bold text-gray-900 bg-purple-200 rounded-full hover:bg-purple-800 hover:text-gray-200 transition-colors duration-500">laravel</span></a></div><nav class="pt-4 clear-both box-border"><a rel="prev" class="float-left w-1/2 p-2 shadow-sm hover:bg-gray-200 dark:hover:bg-gray-800 transition duration-300 ease-in-out" href="/blog/2016/11/26/easy-static-asset-versioning-in-php/"><p><strong class="font-bold clear-both">← Previous page</strong></p><p class="pl-6">Easy static asset versioning in PHP</p></a><a rel="next" class="float-right w-1/2 p-2 shadow-sm hover:bg-gray-200 dark:hover:bg-gray-800 transition duration-300 ease-in-out" href="/blog/2017/02/18/integrating-behat-with-laravel/"><p><strong>→ Next page</strong></p><p class="pl-6">Integrating Behat with Laravel</p></a></nav><div id="disqus_thread"></div></article></main></div><footer class="w-full p-4 text-gray-100 bg-gray-800"><ul class="flex flex-row flex-wrap justify-center w-full p-2 mx-auto text-center md:w-2/3 box-border"><li class="w-1/3 my-2 md:w-1/5"><a href="/posts/1">Blog</a></li><li class="w-1/3 my-2 md:w-1/5"><a href="/about">About</a></li><li class="w-1/3 my-2 md:w-1/5"><a href="https://twitter.com/mattbd">Twitter</a></li><li class="w-1/3 my-2 md:w-1/5"><a href="https://github.com/matthewbdaly">Github</a></li><li class="w-1/3 my-2 md:w-1/5"><a href="/rss.xml">Feed</a></li></ul><div class="w-full p-4 mx-auto text-center md:w-2/3"><p>© Matthew Daly <!-- -->2021</p></div></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-17043630-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/2016/11/29/testing-laravel-middleware/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-6860dcd81490c6aa82f7.js"],"app":["/app-ee7d5025f6bfd6d08ba0.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-f73ba0fd1f8ccd9c9e51.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-7a805f0868e56456f3c2.js"],"component---src-pages-search-tsx":["/component---src-pages-search-tsx-2aa1fb57664bc330c649.js"],"component---src-templates-404-tsx":["/component---src-templates-404-tsx-0ab7260f6562c3839505.js"],"component---src-templates-archives-tsx":["/component---src-templates-archives-tsx-1bc03ba39f14994e7af6.js"],"component---src-templates-categories-tsx":["/component---src-templates-categories-tsx-cf2f6aa49dce8d94207b.js"],"component---src-templates-category-tsx":["/component---src-templates-category-tsx-88d743825e0eb1227d3b.js"],"component---src-templates-chunk-tsx":["/component---src-templates-chunk-tsx-52619a805d8f0ab4d7a4.js"],"component---src-templates-page-tsx":["/component---src-templates-page-tsx-678d4f74a4a37ea6a955.js"],"component---src-templates-post-tsx":["/component---src-templates-post-tsx-aaa8214c2c4f236a2974.js"]};/*]]>*/</script><script src="/polyfill-6860dcd81490c6aa82f7.js" nomodule=""></script><script src="/component---src-templates-post-tsx-aaa8214c2c4f236a2974.js" async=""></script><script src="/7840d69eefded84ab93ff6e879351e9a3a16821f-3cc77dc4aa7437d407dd.js" async=""></script><script src="/15a3be27178e285ff113e12c60c30466a8f4d4c5-05c94d59cdf70f961f79.js" async=""></script><script src="/e87769ff526c098a69bffbfff9ee9d57397fcb93-f80d1b6945cc05a4b927.js" async=""></script><script src="/f0e45107-1ab5e6e9877396d2cf44.js" async=""></script><script src="/app-ee7d5025f6bfd6d08ba0.js" async=""></script><script src="/framework-aeedefbd40854c93cd6e.js" async=""></script><script src="/webpack-runtime-c33358236e0b6acb82bb.js" async=""></script></body></html>